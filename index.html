<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title id="app-title">Gestor de Ateliê Pro</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        :root {
            /* ... (Variáveis CSS mantidas) ... */
            --cor-primaria: #E91E63; --cor-secundaria: #AD1457; --cor-fundo-app: #F4F6F9;
            --cor-fundo-container: #FFFFFF; --cor-texto: #343A40; --cor-texto-claro: #FFFFFF;
            --cor-destaque: #FFC107; --cor-sucesso: #28A745; --cor-erro: #DC3545;
            --cor-info: #17A2B8; --cor-aviso: #FF7F0E; --cor-borda: #DEE2E6;
            --sombra-padrao: 0 3px 10px rgba(0, 0, 0, 0.08); --borda-arredondada: 10px;
            --padding-padrao: 16px; --altura-bottom-nav: 65px; --altura-header: 60px;
            --altura-subheader: 45px; --cor-primaria-transparente: rgba(233, 30, 99, 0.25);
            --largura-nav-item: 75px; --nav-arrow-width: 35px;
        }

        /* TEMAS */
        /* ... (Temas mantidos) ... */
         body.theme-classic-rose {} body.theme-ocean-breeze { --cor-primaria: #007BFF; --cor-secundaria: #0056B3; --cor-fundo-app: #E7F3FF; --cor-fundo-container: #FDFEFF; --cor-texto: #212529; --cor-destaque: #FFC107; --cor-primaria-transparente: rgba(0, 123, 255, 0.25); } body.theme-forest-haven { --cor-primaria: #28A745; --cor-secundaria: #19692C; --cor-fundo-app: #EAF6EC; --cor-fundo-container: #FBFCFA; --cor-texto: #155724; --cor-destaque: #FD7E14; --cor-primaria-transparente: rgba(40, 167, 69, 0.25); } body.theme-sunset-glow { --cor-primaria: #FD7E14; --cor-secundaria: #B3590D; --cor-fundo-app: #FFF3E0; --cor-fundo-container: #FFFCF5; --cor-texto: #592E00; --cor-destaque: #007BFF; --cor-primaria-transparente: rgba(253, 126, 20, 0.25); } body.theme-lavender-dream { --cor-primaria: #6F42C1; --cor-secundaria: #4A2C82; --cor-fundo-app: #F0E6FF; --cor-fundo-container: #F9F5FF; --cor-texto: #3D2370; --cor-destaque: #20C997; --cor-primaria-transparente: rgba(111, 66, 193, 0.25); } body.theme-dark-mode { --cor-primaria: #BB86FC; --cor-secundaria: #3700B3; --cor-fundo-app: #121212; --cor-fundo-container: #1E1E1E; --cor-texto: #E0E0E0; --cor-texto-claro: #121212; --cor-destaque: #03DAC6; --cor-borda: #444444; --cor-primaria-transparente: rgba(187, 134, 252, 0.25); }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--cor-fundo-app); color: var(--cor-texto); line-height: 1.6;
            padding: calc(var(--altura-header) + var(--altura-subheader) + 15px) 15px calc(var(--altura-bottom-nav) + 20px) 15px;
            transition: background-color 0.3s ease, color 0.3s ease; min-height: 100vh;
            position: relative; /* Para garantir contexto de posicionamento */
            padding-bottom: calc(var(--altura-bottom-nav) + 20px); /* Espaço base */
        }
         body.nav-expand-visible {
             padding-bottom: calc(var(--altura-bottom-nav) * 2 + 20px); /* Dobra o padding */
         }

        .app-header-fixed { position: fixed; top: 0; left: 0; width: 100%; z-index: 999; background-color: var(--cor-fundo-container); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header#app-main-header { height: var(--altura-header); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px var(--padding-padrao); border-bottom: 1px solid var(--cor-borda); }
        header#app-main-header h1 { color: var(--cor-primaria); font-size: 1.5em; margin-bottom: 0; line-height: 1.2; }
        #nome-atelie-header { font-style: italic; }
        header#app-main-header p { font-size: 0.8em; color: var(--cor-texto); opacity: 0.7; margin-top: 2px; line-height: 1.2; }
        
        .sub-header-fixed { height: var(--altura-subheader); display: flex; align-items: center; padding: 0 var(--padding-padrao); background-color: var(--cor-fundo-app); border-bottom: 1px solid var(--cor-borda); transition: font-size 0.3s ease, box-shadow 0.3s ease; position: relative; }
        .sub-header-fixed h2#sub-header-titulo-aba { flex-grow: 1; text-align: center; font-size: 1.1em; color: var(--cor-secundaria); margin: 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 40px; padding-left: 40px; }
        button#btn-ajuda-sub-header { background: none; border: none; color: var(--cor-info); font-size: 1.4em; cursor: pointer; padding: 3px 5px; line-height: 1; position: absolute; right: var(--padding-padrao); top: 50%; transform: translateY(-50%); }
        button#btn-ajuda-sub-header:hover { color: var(--cor-primaria); opacity: 1; }

        body.scrolled .sub-header-fixed { box-shadow: var(--sombra-padrao); }
        body.scrolled .sub-header-fixed h2 { font-size: 0.95em; }
        .container-principal { max-width: 1200px; margin: 0 auto; width: 100%; background-color: transparent; padding: 0; box-shadow: none; border-radius: 0; }
        
        /* --- Estilos Base Barra Navegação --- */
        .bottom-nav-container { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; }
        .bottom-nav-base { height: var(--altura-bottom-nav); background-color: var(--cor-fundo-container); display: flex; align-items: stretch; box-shadow: 0 -3px 12px rgba(0,0,0,0.1); border-top: 1px solid var(--cor-borda); }
        
        /* --- Barra de Navegação Rolável --- */
        #nav-scroll-container { display: none; padding: 0 var(--nav-arrow-width); position: relative; }
        body.nav-scroll #nav-scroll-container { display: flex; }
        #nav-scroll-container .bottom-nav-scroll-wrapper { flex-grow: 1; overflow-x: scroll; scroll-behavior: smooth; display: flex; align-items: stretch; -webkit-overflow-scrolling: touch; scrollbar-width: none; cursor: grab; }
        #nav-scroll-container .bottom-nav-scroll-wrapper::-webkit-scrollbar { display: none; }
        #nav-scroll-container .nav-scroll-btn { position: absolute; top: 0; bottom: 0; width: var(--nav-arrow-width); background: linear-gradient(to right, var(--cor-fundo-container) 60%, transparent); border: none; color: var(--cor-secundaria); font-size: 1.3em; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s ease, background-color 0.2s ease; opacity: 0.8; }
        #nav-scroll-container .nav-scroll-btn.next { right: 0; background: linear-gradient(to left, var(--cor-fundo-container) 60%, transparent); justify-content: flex-end; padding-right: 5px; }
        #nav-scroll-container .nav-scroll-btn.prev { left: 0; background: linear-gradient(to right, var(--cor-fundo-container) 60%, transparent); justify-content: flex-start; padding-left: 5px; }
        #nav-scroll-container .nav-scroll-btn:hover { opacity: 1; background-color: rgba(200, 200, 200, 0.1); }
        #nav-scroll-container .nav-scroll-btn:disabled { opacity: 0.2; cursor: default; background-color: transparent !important; }

        /* --- Barra de Navegação Expansível --- */
        #nav-expand-container { display: none; flex-direction: column-reverse; }
        body.nav-expand #nav-expand-container { display: flex; }

        #secondary-nav-panel {
            background-color: var(--cor-fundo-container); display: flex; justify-content: space-around; align-items: stretch;
            height: 0; overflow: hidden; transition: height 0.3s ease, padding 0.3s ease; /* Transição na altura */
            border-bottom: 1px solid var(--cor-borda); box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 0; /* Sem padding quando fechado */
        }
         #secondary-nav-panel.visible {
            height: var(--altura-bottom-nav);
            padding: 5px 0; /* Padding só quando visível */
         }

        #nav-expand-main { justify-content: space-around; } /* Barra principal */
        #btn-expand-nav .icon-expand { transition: transform 0.3s ease; display: inline-block; }
        #secondary-nav-panel.visible + #nav-expand-main #btn-expand-nav .icon-expand { transform: rotate(180deg); } /* Gira a seta */

        /* --- Estilos Comuns dos Itens da Nav --- */
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; width: var(--largura-nav-item); padding: 6px 2px; cursor: pointer; border: none; background: transparent; color: var(--cor-texto); opacity: 0.7; font-size: 0.65em; text-align: center; transition: color 0.2s ease, opacity 0.2s ease, border-top-color 0.2s ease; border-top: 3px solid transparent; height: 100%; }
        .bottom-nav-item .icon { font-size: 1.6em; margin-bottom: 1px; }
        .bottom-nav-item.active { color: var(--cor-primaria); opacity: 1; font-weight: 600; border-top-color: var(--cor-primaria); }

        /* --- Restante do CSS (mantido com ajustes menores) --- */
        /* ... (Resto do CSS: .tab-content, .secao, formulários, tabelas, cards, modal, etc.) ... */
          .tab-content { display: none; animation: fadeInTab 0.4s ease-out; } .tab-content.active { display: block; } @keyframes fadeInTab { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .secao { margin-bottom: 25px; padding: var(--padding-padrao); background-color: var(--cor-fundo-container); border-radius: var(--borda-arredondada); border: 1px solid var(--cor-borda); box-shadow: var(--sombra-padrao); } .secao > *:first-child:not(h3) { margin-top: 0; } .secao h3 { color: var(--cor-primaria); margin: 18px 0 10px 0; font-size: 1.25em; } .secao > .filtro-periodo-container + h3, .secao > #filtro-status-producao-container + h3, .secao > .filtros-container + h3 { margin-top: 18px; } .secao > h3:first-child { margin-top: 0; } label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--cor-texto); font-size: 0.9em; } input[type="text"], input[type="number"], input[type="date"], input[type="tel"], input[type="email"], input[type="time"], input[type="month"], input[type="color"], select, textarea { width: 100%; padding: 12px; margin-bottom: 14px; border: 1px solid var(--cor-borda); border-radius: calc(var(--borda-arredondada) - 5px); font-size: 1em; background-color: var(--cor-fundo-app); color: var(--cor-texto); transition: border-color 0.2s ease, box-shadow 0.2s ease; } input:focus, select:focus, textarea:focus { outline: none; border-color: var(--cor-primaria); box-shadow: 0 0 0 3px var(--cor-primaria-transparente); } input[type="color"] { padding: 2px; height: 45px; } textarea { min-height: 80px; resize: vertical; } .checkbox-label { font-weight: normal; display: flex; align-items: center; margin-bottom: 10px; font-size: 1em; } input[type="checkbox"] { margin-right: 8px; transform: scale(1.3); } .campo-grupo { margin-bottom: 14px; } .grid-2-col, .grid-3-col { display: grid; gap: 14px; } .grid-2-col { grid-template-columns: 1fr; } .grid-3-col { grid-template-columns: 1fr; } @media (min-width: 600px) { .grid-2-col { grid-template-columns: 1fr 1fr; } .grid-3-col { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));} } .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; font-size: 1em; font-weight: bold; color: var(--cor-texto-claro); background-color: var(--cor-primaria); border: none; border-radius: var(--borda-arredondada); cursor: pointer; text-align: center; transition: all 0.2s ease; text-decoration: none; } .btn:hover { filter: brightness(115%); transform: translateY(-1px); } .btn:active { transform: translateY(0px) scale(0.98); filter: brightness(100%);} .btn .icon { font-size: 1.1em; } .btn-secundario { background-color: var(--cor-texto); opacity:0.8; } .btn-secundario:hover { opacity:1; } .btn-sucesso { background-color: var(--cor-sucesso); } .btn-perigo { background-color: var(--cor-erro); } .btn-aviso { background-color: var(--cor-aviso); } .btn-info { background-color: var(--cor-info); } .btn-pequeno { padding: 6px 12px; font-size: 0.85em; } .btn-full-width { width: 100%; display: flex; margin-top: 8px; } .tabela-responsiva { overflow-x: auto; margin-top: 15px; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid var(--cor-borda); padding: 10px 12px; text-align: left; vertical-align: middle; font-size: 0.9em; line-height: 1.4; } th { background-color: var(--cor-secundaria); color: var(--cor-texto-claro); font-weight: bold; } tr:nth-child(even) td { background-color: #f9f9f9; } tr:hover td { background-color: #f1f1f1; } td .btn { margin-right: 5px; margin-bottom: 5px; } #tabela-producao th:nth-child(1), #tabela-producao td:nth-child(1) { min-width: 80px; } #tabela-producao th:nth-child(2), #tabela-producao td:nth-child(2) { min-width: 130px; } #tabela-producao th:nth-child(3), #tabela-producao td:nth-child(3) { min-width: 120px; } #tabela-producao th:nth-child(4), #tabela-producao td:nth-child(4) { min-width: 150px; white-space: normal; } #tabela-producao th:nth-child(5), #tabela-producao td:nth-child(5) { min-width: 50px; text-align: center; } #tabela-producao th:nth-child(6), #tabela-producao td:nth-child(6) { min-width: 130px; white-space: normal; } #tabela-producao th:nth-child(7), #tabela-producao td:nth-child(7) { min-width: 90px; text-align: right; } #tabela-producao th:nth-child(8), #tabela-producao td:nth-child(8) { min-width: 90px; text-align: center; } #tabela-producao th:nth-child(9), #tabela-producao td:nth-child(9) { min-width: 180px; text-align: center; } #tabela-despesas th:nth-child(1), #tabela-despesas td:nth-child(1) { min-width: 80px; } #tabela-despesas th:nth-child(2), #tabela-despesas td:nth-child(2) { min-width: 150px; white-space: normal; } #tabela-despesas th:nth-child(3), #tabela-despesas td:nth-child(3) { min-width: 120px; } #tabela-despesas th:nth-child(4), #tabela-despesas td:nth-child(4) { min-width: 90px; text-align: right;} #tabela-despesas th:nth-child(5), #tabela-despesas td:nth-child(5) { min-width: 100px; text-align: center; } #tabela-maquinas th:nth-child(1), #tabela-maquinas td:nth-child(1) { min-width: 120px; } #tabela-maquinas th:nth-child(2), #tabela-maquinas td:nth-child(2) { min-width: 100px; } #tabela-maquinas th:nth-child(3), #tabela-maquinas td:nth-child(3) { min-width: 100px; } #tabela-maquinas th:nth-child(4), #tabela-maquinas td:nth-child(4) { min-width: 80px; text-align: center;} #tabela-maquinas th:nth-child(5), #tabela-maquinas td:nth-child(5) { min-width: 130px; text-align: center; } .dashboard-cards { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; } @media (min-width: 500px) { .dashboard-cards { grid-template-columns: 1fr 1fr; } } @media (min-width: 900px) { .dashboard-cards { grid-template-columns: 1fr 1fr 1fr; } } @media (min-width: 1100px) { .dashboard-cards { grid-template-columns: repeat(4, 1fr); } } .card { background-color: var(--cor-primaria); color: var(--cor-texto-claro); padding: var(--padding-padrao); border-radius: var(--borda-arredondada); text-align: center; box-shadow: var(--sombra-padrao); display: flex; flex-direction: column; justify-content: center; min-height: 110px; } .card.destaque { background-color: var(--cor-destaque); color: var(--cor-texto); } .card.info { background-color: var(--cor-info); } .card.erro { background-color: var(--cor-erro); } .card.sucesso { background-color: var(--cor-sucesso); } .card h3 { margin-bottom: 8px; font-size: 0.85em; font-weight: 600; opacity: 1; color: inherit; letter-spacing: 0.2px; } .card p { font-size: 1.8em; font-weight: bold; line-height: 1.2; } .mensagem-feedback { padding: var(--padding-padrao); margin: 15px 0; border-radius: var(--borda-arredondada); text-align: center; font-weight: 500; display: none; border: 1px solid; } .mensagem-feedback.sucesso { background-color: #d4edda; color: #155724; border-color: #c3e6cb; display: block; } .mensagem-feedback.erro { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; display: block; } .mensagem-feedback.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; display: block; } .filtros-container { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; padding: 12px; background-color: var(--cor-fundo-app); border-radius: var(--borda-arredondada); flex-wrap: wrap;} .filtros-container label { margin-bottom: 0; font-size: 0.85em; } .filtros-container select { margin-bottom: 0; width: auto; min-width: 140px; padding: 8px; font-size: 0.9em;} .filtro-periodo-container { background-color: var(--cor-fundo-app); padding: 10px; margin-bottom: 15px; border-radius: var(--borda-arredondada); border: 1px solid var(--cor-borda); } .filtro-periodo-container .controles-superiores-filtro { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; } .filtro-periodo-container .btn-toggle-filtro { flex-grow: 1; } .filtro-periodo-container .btn-mes-atual { padding: 6px 10px; font-size: 0.9em; flex-shrink: 0; } .campos-filtro-periodo { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--cor-borda); } .campos-filtro-periodo label { margin-bottom: 0; font-size: 0.85em; } .campos-filtro-periodo input[type="date"] { padding: 8px; font-size: 0.9em; width: auto; min-width: 130px; margin-bottom: 0; } .campos-filtro-periodo .btn { margin-left: auto; } .periodo-selecionado-display { font-size: 0.8em; color: var(--cor-texto); opacity: 0.8; margin-top: 8px; text-align: center; } #total-despesas-periodo { margin-top: 10px; font-weight: bold; text-align: right; font-size: 1.1em; color: var(--cor-erro); } .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModal 0.3s ease-out; } .modal-conteudo { background-color: var(--cor-fundo-container); margin: 5% auto; padding: 25px; border: 1px solid var(--cor-borda); width: 95%; max-width: 800px; border-radius: var(--borda-arredondada); box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; color: var(--cor-texto); max-height: 90vh; overflow-y: auto; } .modal-fechar { color: var(--cor-texto); opacity: 0.7; position: absolute; top: 10px; right: 20px; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; z-index: 2001; } /* Garante que fechar esteja acima */ .modal-fechar:hover { opacity: 1; color: var(--cor-erro); } @keyframes fadeInModal { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1;transform: translateY(0px);}} .modal h2 { margin-top: 0; color: var(--cor-primaria); } .modal ul { list-style: inside; padding-left: 5px; margin-top:10px; } .modal li { margin-bottom: 8px; } .modal p { margin-bottom: 10px; } #modal-detalhes-maquina .maquina-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--cor-borda); } #modal-detalhes-maquina .maquina-info-grid p { margin-bottom: 3px; font-size: 0.9em; } #modal-detalhes-maquina h3 { margin-top: 20px; margin-bottom: 8px; } /* Espaço entre título e botão/tabela */ #modal-detalhes-maquina .tabela-responsiva { max-height: 200px; overflow-y: auto; margin-top: 5px; } /* Scroll interno nas tabelas do modal */ .theme-editor-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 10px; } @media (min-width: 500px) { .theme-editor-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } } .theme-editor-grid .campo-grupo label { display: flex; align-items: center; justify-content: space-between; } .theme-editor-grid input[type="color"] { width: 50px; height: 30px; padding: 0; margin-left: 10px; } .cor-peca-preview { display: inline-block; width: 16px; height: 16px; border-radius: 50%; margin-right: 6px; border: 1px solid #ccc; vertical-align: middle; } .modo-completo-item { display: none; } body.modo-completo .modo-completo-item { display: block; } .modo-simples-item { display: block; } body.modo-completo .modo-simples-item { display: none; } .grafico-barras-simples { display: flex; gap: 5px; align-items: flex-end; height: 150px; border-left: 2px solid var(--cor-borda); border-bottom: 2px solid var(--cor-borda); padding: 5px; margin-top:15px; overflow-x: auto; } .grafico-barras-simples .barra { background-color: var(--cor-primaria); flex-shrink: 0; width: 40px; text-align: center; color: var(--cor-texto-claro); font-size: 0.7em; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2px; } .grafico-barras-simples .barra span { writing-mode: vertical-rl; text-orientation: mixed; white-space:nowrap; transform: rotate(180deg); margin-bottom: 5px; } .btn-whatsapp { background-color: #25D366; } .btn-whatsapp:hover { background-color: #1DAE54; } #page-footer { text-align: center; margin-top: 30px; padding: 15px 0; border-top: 1px solid var(--cor-borda); color: var(--cor-texto); opacity:0.7; font-size: 0.85em; } #lista-processos-peca .processo-item { display: flex; gap: 10px; align-items: center; padding: 8px; border: 1px solid var(--cor-borda); margin-bottom: 8px; border-radius: calc(var(--borda-arredondada) - 4px); } #lista-processos-peca .processo-item input[type="text"], #lista-processos-peca .processo-item input[type="number"] { margin-bottom: 0; flex-grow: 1; } #lista-processos-peca .processo-item .btn-remover-processo-temp { padding: 6px 10px; font-size: 0.9em; line-height: 1; }

        /* ESTILOS DE IMPRESSÃO */
        /* ... (Mantidos) ... */
         @media print { body { padding: 0 !important; margin: 0 !important; font-size: 10pt; } .nao-imprimir, .bottom-nav-container, .app-header-fixed, #page-footer, #btn-ajuda-sub-header, #mensagem-global, .filtros-container, #filtro-status-producao-container, #filtro-periodo-container-dashboard, #filtro-periodo-container-producao, #filtro-periodo-container-despesas, #btn-adicionar-exemplos-tipos-peca, #form-producao button, #form-tipo-peca button, #form-cliente button, #form-contato-util button, #form-reparo button, #form-horas button, #form-anotacao button, #form-maquina button, #form-despesa button, #tabela-producao .btn-editar-producao, #tabela-producao .btn-excluir-producao, #tabela-producao .btn-toggle-pago, #tabela-producao .btn-share-whatsapp, #tabela-tipos-peca .btn, #tabela-clientes .btn, #tabela-contatos-uteis .btn, #tabela-reparos .btn, #tabela-maquinas .btn-editar-maquina, #tabela-maquinas .btn-excluir-maquina, #tabela-maquinas .btn-ver-maquina, #tabela-despesas .btn, .btn-editar-peca-modelo, .btn-excluir-peca-modelo, .btn-editar-cliente, .btn-excluir-cliente, .btn-editar-contato-util, .btn-excluir-contato-util, .btn-editar-reparo, .btn-excluir-reparo, .btn-editar-maquina, .btn-excluir-maquina, .btn-editar-despesa, .btn-excluir-despesa, #form-configuracoes-nomes button, #config-modo-interface, #config-nav-style, #config-tema-predefinido, #editor-tema-personalizado, #btn-exportar-dados, #input-importar-dados, #filtro-relatorio-cliente, #btn-gerar-relatorio-periodo { display: none !important; } .container-principal { box-shadow: none; border: none; padding: 0; margin: 0; max-width: 100%; } .secao { box-shadow: none; border: none; margin-bottom: 10px; padding: 0;} .tab-content { display: none !important; } #comprovante-para-impressao-container { display: block !important; } #comprovante-para-impressao, #comprovante-para-impressao * { visibility: visible !important; color: #000 !important; background-color: #fff !important; } #comprovante-para-impressao { margin: 10mm; padding:0; font-size: 10pt; line-height: 1.4;} #comprovante-para-impressao h1 { font-size: 16pt; margin-bottom: 15px; text-align: center; } #comprovante-para-impressao h2 { font-size: 13pt; margin-top: 12px; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 3px;} #comprovante-para-impressao h3 { font-size: 11pt; margin-top: 10px; margin-bottom: 6px; font-weight: bold; } #comprovante-para-impressao p, #comprovante-para-impressao li { margin-bottom: 5px; } #comprovante-para-impressao p strong { font-weight: bold; } #comprovante-para-impressao ul { list-style: disc; padding-left: 20px; margin-top: 3px; } #comprovante-para-impressao hr { border: none; border-top: 1px dashed #999; margin: 12px 0; } #comprovante-para-impressao table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size:9pt; } #comprovante-para-impressao th, #comprovante-para-impressao td { border: 1px solid #666; padding: 5px; text-align: left; word-break: break-word;} #comprovante-para-impressao th { background-color: #eaeaea; font-weight: bold; } #rodape-comprovante { font-size: 8pt; text-align: center; margin-top: 15px; color: #444 !important; } a[href^="http"]:after { content: ""; } a {text-decoration: none; color: inherit;} }
        .comprovante-container-hidden { display: none; }

    </style>
</head>
<body class="nav-scroll"> <!-- Classe inicial controlada por JS -->
    <div class="app-header-fixed">
        <header id="app-main-header"> <h1 id="nome-atelie-header">Gestor de Ateliê</h1> <p>Olá, <span id="nome-costureira-header">Costureira</span>! ❤️</p> </header>
        <div class="sub-header-fixed"> <h2 id="sub-header-titulo-aba">Painel</h2> <button class="nao-imprimir" id="btn-ajuda-sub-header" title="Ajuda da Aba">❓</button> </div>
    </div>

    <div class="container-principal">
        <div id="mensagem-global" class="mensagem-feedback"></div>
        <main id="main-content">
             <!-- Conteúdo das Abas -->
             <!-- ... (Abas Dashboard, Produção, Despesas, Peças, Clientes, Máquinas, Contatos, Reparos, Configurações - Estrutura mantida) ... -->
              <!-- Tab: Dashboard --> <div id="tab-dashboard" class="tab-content active" data-help-key="dashboard"> <section class="secao"> <div class="filtro-periodo-container" id="filtro-periodo-container-dashboard"> <div class="controles-superiores-filtro"> <button id="btn-toggle-filtro-periodo-dashboard" class="btn btn-pequeno btn-info btn-toggle-filtro"> 🗓️ Definir Período <span class="arrow">▼</span> </button> <button id="btn-mes-atual-dashboard" class="btn btn-pequeno btn-info btn-mes-atual" title="Mês Atual">🔄 Mês Atual</button> </div> <div id="campos-filtro-periodo-dashboard" class="campos-filtro-periodo" style="display:none;"> <label for="filtro-data-inicio-dashboard">Início:</label> <input type="date" id="filtro-data-inicio-dashboard"> <label for="filtro-data-fim-dashboard">Fim:</label> <input type="date" id="filtro-data-fim-dashboard"> <button id="btn-aplicar-filtro-periodo-dashboard" class="btn btn-pequeno btn-sucesso">Aplicar</button> <button id="btn-resetar-filtro-periodo-dashboard" class="btn btn-pequeno btn-secundario">Resetar Período</button> </div> <p id="periodo-atual-dashboard" class="periodo-selecionado-display"></p> </div> <div class="dashboard-cards"> <div class="card"><h3>Ganhos do Dia</h3><p id="dash-valor-card1">R$ 0,00</p></div> <div class="card destaque"><h3>Ganhos do Período</h3><p id="dash-valor-card2">R$ 0,00</p></div> <div class="card erro"><h3>Despesas (Período)</h3><p id="dash-valor-card-despesas">R$ 0,00</p></div> <div class="card sucesso"><h3>Lucro Líquido (Período)</h3><p id="dash-valor-card-lucro">R$ 0,00</p></div> <div class="card"><h3>Total Recebido (Período)</h3><p id="dash-valor-card3">R$ 0,00</p></div> <div class="card info"><h3>Total Pendente (Período)</h3><p id="dash-valor-card4">R$ 0,00</p></div> <div class="card"><h3>Peças Produzidas (Período)</h3><p id="dash-valor-card5">0</p></div> <div class="card"><h3>Horas Trabalhadas (Período)</h3><p id="dash-valor-card6">0h</p></div> </div> <div class="modo-completo-item"> <h3>📈 Ganhos Mensais (Últimos 6 Meses Referentes ao Fim do Período)</h3> <div id="grafico-ganhos-mensais" class="grafico-barras-simples"></div> <h3 style="margin-top:20px;">⭐ Peças Mais Produzidas (Período Selecionado)</h3> <ul id="lista-top-pecas" class="lista-simples"></ul> </div> </section> </div>
              <!-- Tab: Produção --> <div id="tab-producao" class="tab-content" data-help-key="producao"> <section class="secao"> <form id="form-producao"> <!-- ... (Formulário de Produção) ... --><input type="hidden" id="producao-id"> <div class="grid-2-col"> <div class="campo-grupo"><label for="prod-data">Data:</label><input type="date" id="prod-data" required></div> <div class="campo-grupo"><label for="prod-tipo-peca">Peça/Modelo Base:</label><select id="prod-tipo-peca" required></select></div> </div> <div class="grid-2-col"> <div class="campo-grupo"><label for="prod-modelo-descricao">Descrição Detalhada (Item Específico):</label><input type="text" id="prod-modelo-descricao" placeholder="Ex: Renda frufru, Algodão cliente X"></div> <div class="campo-grupo"><label for="prod-cor-peca">Cor da Peça:</label><input type="text" id="prod-cor-peca" placeholder="Ex: Preto, Rosa Bebê, Estampado Floral"></div> </div> <div class="campo-grupo modo-completo-item"> <label for="prod-cliente">Cliente (Opcional):</label> <select id="prod-cliente"><option value="">Nenhum cliente específico</option></select> </div> <div class="modo-completo-item"> <h3>Processos Realizados:</h3> <div id="processos-para-producao" class="campo-grupo"><p class="info-text">Selecione Peça/Modelo Base.</p></div> </div> <div class="campo-grupo modo-simples-item"> <label for="prod-valor-manual">Valor Total do Item (R$):</label> <input type="number" id="prod-valor-manual" step="0.01" placeholder="Para modo simples sem processos"> </div> <div class="grid-2-col"> <div class="campo-grupo"><label for="prod-quantidade">Quantidade:</label><input type="number" id="prod-quantidade" min="1" value="1" required></div> <div class="campo-grupo modo-completo-item"> <label for="prod-valor-total-calculado">Valor Total Processos (R$):</label> <input type="text" id="prod-valor-total-calculado" readonly placeholder="Automático (Processos x Qtd)"> </div> </div> <div class="campo-grupo modo-completo-item"> <label for="prod-materiais">Materiais Utilizados (Opcional):</label> <textarea id="prod-materiais" placeholder="Ex: Linha XYZ cor A, Tecido ABC, 2m elástico Z..."></textarea> </div> <div class="campo-grupo"><label class="checkbox-label"><input type="checkbox" id="prod-pago"> Pagamento Recebido</label></div> <div class="campo-grupo"><label for="prod-observacoes">Observações:</label><textarea id="prod-observacoes"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Produção</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-limpar-form-prod" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <div class="filtro-periodo-container" id="filtro-periodo-container-producao"> <div class="controles-superiores-filtro"> <button id="btn-toggle-filtro-periodo-producao" class="btn btn-pequeno btn-info btn-toggle-filtro"> 🗓️ Definir Período <span class="arrow">▼</span> </button> <button id="btn-mes-atual-producao" class="btn btn-pequeno btn-info btn-mes-atual" title="Mês Atual">🔄 Mês Atual</button> </div> <div id="campos-filtro-periodo-producao" class="campos-filtro-periodo" style="display:none;"> <label for="filtro-data-inicio-producao">Início:</label> <input type="date" id="filtro-data-inicio-producao"> <label for="filtro-data-fim-producao">Fim:</label> <input type="date" id="filtro-data-fim-producao"> <button id="btn-aplicar-filtro-periodo-producao" class="btn btn-pequeno btn-sucesso">Aplicar</button> <button id="btn-resetar-filtro-periodo-producao" class="btn btn-pequeno btn-secundario">Resetar Período</button> </div> <p id="periodo-atual-producao" class="periodo-selecionado-display"></p> </div> <div class="filtros-container" id="filtro-status-producao-container"> <label for="filtro-status-pagamento">Status Pag.:</label> <select id="filtro-status-pagamento"><option value="todos">Todos</option><option value="pago">Pago</option><option value="pendente">Pendente</option></select> </div> <div class="tabela-responsiva"> <table id="tabela-producao"> <thead> <tr> <th class="col-data">Data</th> <th class="col-peca">Peça Base/Cor</th> <th class="modo-completo-item col-cliente">Cliente</th> <th class="col-descricao">Descrição Detalhada</th> <th class="col-qtd">Qtd</th> <th class="modo-completo-item col-processos">Processos</th> <th class="col-valor">Valor</th> <th class="col-status">Status</th> <th class="col-acoes">Ações</th> </tr> </thead> <tbody id="corpo-tabela-producao"></tbody> </table> </div> <p id="sem-producao-msg" class="mensagem-feedback info" style="display:none;">Nenhuma produção encontrada.</p> <h3 style="margin-top: 30px;">Gerar Relatório Detalhado</h3> <div class="filtros-container" id="filtros-relatorio-periodo"> <p style="font-size:0.9em; margin-bottom:5px;">O relatório usará o período definido acima. Você pode refinar por cliente:</p> <div class="modo-completo-item"><label for="filtro-relatorio-cliente">Cliente (Opcional):</label><select id="filtro-relatorio-cliente"><option value="">Todos os Clientes</option></select></div> <button class="btn btn-sucesso" id="btn-gerar-relatorio-periodo" style="padding: 8px 15px;"><span class="icon">🧾</span>Gerar Relatório</button> </div> </section> </div>
             <!-- Tab: Despesas --> <div id="tab-despesas" class="tab-content" data-help-key="despesas"> <section class="secao"> <form id="form-despesa"> <!-- ... (Formulário Despesas) ... --><input type="hidden" id="despesa-id"> <div class="grid-2-col"> <div class="campo-grupo"><label for="despesa-data">Data:</label><input type="date" id="despesa-data" required></div> <div class="campo-grupo"><label for="despesa-valor">Valor (R$):</label><input type="number" step="0.01" id="despesa-valor" required></div> </div> <div class="campo-grupo"><label for="despesa-descricao">Descrição:</label><input type="text" id="despesa-descricao" placeholder="Ex: Compra de linha, Conta de luz" required></div> <div class="campo-grupo"><label for="despesa-categoria">Categoria:</label> <select id="despesa-categoria" required> <option value="">Selecione...</option> </select> </div> <div class="campo-grupo"><label for="despesa-notas">Notas (Opcional):</label><textarea id="despesa-notas"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Despesa</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-despesa" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <div class="filtro-periodo-container" id="filtro-periodo-container-despesas"> <div class="controles-superiores-filtro"> <button id="btn-toggle-filtro-periodo-despesas" class="btn btn-pequeno btn-info btn-toggle-filtro"> 🗓️ Definir Período <span class="arrow">▼</span> </button> <button id="btn-mes-atual-despesas" class="btn btn-pequeno btn-info btn-mes-atual" title="Mês Atual">🔄 Mês Atual</button> </div> <div id="campos-filtro-periodo-despesas" class="campos-filtro-periodo" style="display:none;"> <label for="filtro-data-inicio-despesas">Início:</label> <input type="date" id="filtro-data-inicio-despesas"> <label for="filtro-data-fim-despesas">Fim:</label> <input type="date" id="filtro-data-fim-despesas"> <button id="btn-aplicar-filtro-periodo-despesas" class="btn btn-pequeno btn-sucesso">Aplicar</button> <button id="btn-resetar-filtro-periodo-despesas" class="btn btn-pequeno btn-secundario">Resetar Período</button> </div> <p id="periodo-atual-despesas" class="periodo-selecionado-display"></p> </div> <div class="filtros-container"> <label for="filtro-categoria-despesa">Filtrar Categoria:</label> <select id="filtro-categoria-despesa"><option value="todas">Todas</option></select> </div> <div class="tabela-responsiva"> <table id="tabela-despesas"> <thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-despesas"></tbody> </table> </div> <p id="sem-despesas-msg" class="mensagem-feedback info" style="display:none;">Nenhuma despesa encontrada.</p> <p id="total-despesas-periodo">Total Despesas (Período): R$ 0,00</p> </section> </div>
             <!-- Tab: Peças/Modelos --> <div id="tab-pecas-modelos" class="tab-content" data-help-key="pecas"> <section class="secao"> <form id="form-tipo-peca"> <!-- ... (Formulário Peças) ... --><input type="hidden" id="tipo-peca-id-edit"> <div class="grid-2-col"> <div class="campo-grupo"><label for="tipo-peca-nome">Nome da Peça/Modelo:</label><input type="text" id="tipo-peca-nome" placeholder="Ex: Sutiã Reforçado Alça Larga" required></div> <div class="campo-grupo" style="align-self: end;"><label class="checkbox-label"><input type="checkbox" id="tipo-peca-cobra-par"> Cobrado por Par</label></div> </div> <div class="modo-completo-item"> <h3>Processos desta Peça/Modelo:</h3> <div id="lista-processos-peca"></div> <button type="button" class="btn btn-pequeno btn-info" id="btn-add-processo-peca" style="margin:5px 0 15px 0;">+ Processo</button> </div> <div class="campo-grupo modo-completo-item"> <label for="tipo-peca-materiais">Materiais Padrão Sugeridos (Opcional):</label> <textarea id="tipo-peca-materiais" placeholder="Ex: Renda X, Microfibra Y, Bojo Z..."></textarea> </div> <br> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Peça/Modelo</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-tipo-peca" style="display:none;">Cancelar Edição</button> </form> <button class="btn btn-info btn-full-width" id="btn-adicionar-exemplos-tipos-peca" style="margin-top: 15px;">+ Adicionar Exemplos Iniciais</button> </section> <section class="secao"> <div class="tabela-responsiva"> <table id="tabela-tipos-peca"> <thead><tr><th>Nome</th><th class="modo-completo-item">Processos (Valor Total)</th><th>Cobrado Por</th><th class="modo-completo-item">Materiais</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-tipos-peca"></tbody> </table> </div> <p id="sem-tipos-peca-msg" class="mensagem-feedback info" style="display:none;">Nenhuma peça/modelo cadastrado.</p> </section> </div>
             <!-- Tab: Clientes --> <div id="tab-clientes" class="tab-content" data-help-key="clientes"> <section class="secao"> <form id="form-cliente"> <!-- ... (Formulário Cliente) ... --><input type="hidden" id="cliente-id-edit"> <div class="campo-grupo"><label for="cliente-nome">Nome Completo:</label><input type="text" id="cliente-nome" required></div> <div class="grid-2-col"> <div class="campo-grupo"><label for="cliente-telefone">Telefone/WhatsApp:</label><input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"></div> <div class="campo-grupo"><label for="cliente-email">Email (Opcional):</label><input type="email" id="cliente-email"></div> </div> <div class="campo-grupo modo-completo-item"><label for="cliente-endereco">Endereço (Opcional):</label><textarea id="cliente-endereco" placeholder="Rua, Número, Bairro, Cidade..."></textarea></div> <div class="campo-grupo"><label for="cliente-observacoes">Observações (Preferências, etc.):</label><textarea id="cliente-observacoes"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Cliente</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-cliente" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <input type="text" id="filtro-clientes" placeholder="🔎 Buscar cliente por nome..." style="margin-bottom:15px;"> <div class="tabela-responsiva"> <table id="tabela-clientes"> <thead><tr><th>Nome</th><th>Contato</th><th class="modo-completo-item">Observações</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-clientes"></tbody> </table> </div> <p id="sem-clientes-msg" class="mensagem-feedback info" style="display:none;">Nenhum cliente cadastrado.</p> </section> </div>
             <!-- Tab: Máquinas --> <div id="tab-maquinas" class="tab-content" data-help-key="maquinas"> <section class="secao"> <form id="form-maquina"> <!-- ... (Formulário Máquina) ... --><input type="hidden" id="maquina-id"> <div class="campo-grupo"><label for="maquina-nome">Nome/Apelido:</label><input type="text" id="maquina-nome" placeholder="Ex: Overlock Principal" required></div> <div class="grid-3-col"> <div class="campo-grupo"><label for="maquina-marca">Marca:</label><input type="text" id="maquina-marca" placeholder="Ex: Singer"></div> <div class="campo-grupo"><label for="maquina-modelo">Modelo:</label><input type="text" id="maquina-modelo" placeholder="Ex: Facilita Pro"></div> <div class="campo-grupo"><label for="maquina-tipo">Tipo:</label> <select id="maquina-tipo"> <option value="">Selecione...</option> <option>Reta Industrial</option><option>Overlock</option><option>Galoneira</option> <option>Caseadeira</option><option>Botoneira</option><option>Travete</option> <option>Doméstica</option><option>Bordadeira</option><option>Outra</option> </select> </div> </div> <div class="grid-3-col"> <div class="campo-grupo"><label for="maquina-data-compra">Data Compra:</label><input type="date" id="maquina-data-compra"></div> <div class="campo-grupo"><label for="maquina-valor-compra">Valor Compra (R$):</label><input type="number" step="0.01" id="maquina-valor-compra"></div> <div class="campo-grupo"><label for="maquina-status">Status:</label> <select id="maquina-status"> <option value="Ativa">Ativa</option><option value="Inativa">Inativa</option> <option value="Em Manutenção">Em Manutenção</option><option value="Vendida">Vendida</option> </select> </div> </div> <div class="campo-grupo"><label for="maquina-foto-url">URL da Foto (Opcional):</label><input type="text" id="maquina-foto-url" placeholder="Cole o link de uma imagem online aqui"></div> <div class="campo-grupo"><label for="maquina-notas">Notas:</label><textarea id="maquina-notas"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Máquina</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-maquina" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <div class="tabela-responsiva"> <table id="tabela-maquinas"> <thead><tr><th>Nome/Apelido</th><th>Tipo</th><th>Marca/Modelo</th><th>Status</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-maquinas"></tbody> </table> </div> <p id="sem-maquinas-msg" class="mensagem-feedback info" style="display:none;">Nenhuma máquina cadastrada.</p> </section> </div>
             <!-- Tab: Contatos --> <div id="tab-contatos" class="tab-content" data-help-key="contatos"> <section class="secao"> <form id="form-contato-util"> <!-- ... (Formulário Contatos) ... --><input type="hidden" id="contato-util-id-edit"> <div class="grid-2-col"> <div class="campo-grupo"><label for="contato-util-nome">Nome:</label><input type="text" id="contato-util-nome" required></div> <div class="campo-grupo"><label for="contato-util-tipo">Tipo:</label> <select id="contato-util-tipo" required> <option value="">Selecione...</option> <option value="Fornecedor">Fornecedor</option><option value="Mecânico Máquina">Mecânico Máquina</option> <option value="Entregador">Entregador</option><option value="Parceiro">Parceiro</option><option value="Outro">Outro</option> </select> </div> </div> <div class="grid-2-col"> <div class="campo-grupo"><label for="contato-util-telefone">Telefone/WhatsApp:</label><input type="tel" id="contato-util-telefone" placeholder="(XX) XXXXX-XXXX"></div> <div class="campo-grupo"><label for="contato-util-email">Email (Opcional):</label><input type="email" id="contato-util-email"></div> </div> <div class="campo-grupo"><label for="contato-util-observacoes">Observações (Serviços, etc.):</label><textarea id="contato-util-observacoes"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Contato</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-contato-util" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <input type="text" id="filtro-contatos" placeholder="🔎 Buscar contato..." style="margin-bottom:15px;"> <div class="tabela-responsiva"> <table id="tabela-contatos-uteis"> <thead><tr><th>Nome</th><th>Tipo</th><th>Contato</th><th class="modo-completo-item">Observações</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-contatos-uteis"></tbody> </table> </div> <p id="sem-contatos-uteis-msg" class="mensagem-feedback info" style="display:none;">Nenhum contato útil cadastrado.</p> </section> </div>
             <!-- Tab: Reparos --> <div id="tab-reparos" class="tab-content" data-help-key="reparos"> <section class="secao"> <form id="form-reparo"> <!-- ... (Formulário Reparos) ... --><input type="hidden" id="reparo-id"> <div class="grid-2-col"> <div class="campo-grupo"><label for="reparo-data-entrada">Data Entrada:</label><input type="date" id="reparo-data-entrada" required></div> <div class="campo-grupo"><label for="reparo-origem-texto">Cliente/Origem:</label><input type="text" id="reparo-origem-texto" placeholder="Nome do cliente ou 'Produção Interna'"></div> </div> <div class="campo-grupo"><label for="reparo-descricao">Descrição Problema/Serviço:</label><textarea id="reparo-descricao"></textarea> </div> <div class="grid-2-col"> <div class="campo-grupo"><label for="reparo-valor">Valor (R$):</label><input type="number" id="reparo-valor" step="0.01" value="0"></div> <div class="campo-grupo"><label for="reparo-status">Status:</label> <select id="reparo-status"><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option><option value="Entregue">Entregue</option></select> </div> </div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Reparo</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-reparo" style="display:none;">Cancelar Edição</button> </form> </section> <section class="secao"> <div class="tabela-responsiva"> <table id="tabela-reparos"> <thead><tr><th>Data</th><th>Origem</th><th>Descrição</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-reparos"></tbody> </table> </div> <p id="sem-reparos-msg" class="mensagem-feedback info" style="display:none;">Nenhum reparo registrado.</p> </section> </div>
             <!-- Tab: Configurações --> <div id="tab-configuracoes" class="tab-content" data-help-key="configuracoes"> <section class="secao"> <form id="form-configuracoes-nomes"> <!-- ... (Form Nomes) ... --><div class="campo-grupo"><label for="config-nome-atelie">Nome Ateliê/Firma:</label><input type="text" id="config-nome-atelie"></div> <div class="campo-grupo"><label for="config-nome-costureira">Seu Nome:</label><input type="text" id="config-nome-costureira"></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Nomes</button> </form> <div class="campo-grupo" style="margin-top:20px;"> <label for="config-modo-interface">Modo da Interface:</label> <select id="config-modo-interface"> <option value="completo">✨ Completo (Todas as Funcionalidades)</option> <option value="simples">👌 Simples (Foco no Essencial)</option> </select> </div> <div class="campo-grupo" style="margin-top:20px;"> <label for="config-nav-style">Estilo da Barra de Navegação:</label> <select id="config-nav-style"> <option value="scroll">↔️ Rolagem Lateral (Setas/Arrastar)</option> <option value="expand">↕️ Expandir/Recolher (Botão Seta)</option> </select> </div> </section> <section class="secao"> <!-- ... (Tema Visual) ... --><div class="campo-grupo"> <label for="config-tema-predefinido">Temas Predefinidos:</label> <select id="config-tema-predefinido"> <option value="theme-classic-rose">Rosa Clássico</option><option value="theme-ocean-breeze">Brisa do Oceano</option> <option value="theme-forest-haven">Refúgio da Floresta</option><option value="theme-sunset-glow">Brilho do Pôr do Sol</option> <option value="theme-lavender-dream">Sonho de Lavanda</option><option value="theme-dark-mode">Modo Escuro</option> <option value="custom">✨ Personalizado ✨</option> </select> </div> <div id="editor-tema-personalizado" style="display:none;"> <h3>Personalizar Cores (Prévia em tempo real):</h3> <div class="theme-editor-grid"> <div class="campo-grupo"><label for="cor-primaria-picker">Cor Primária <input type="color" id="cor-primaria-picker"></label></div> <div class="campo-grupo"><label for="cor-secundaria-picker">Cor Secundária <input type="color" id="cor-secundaria-picker"></label></div> <div class="campo-grupo"><label for="cor-fundo-app-picker">Fundo App <input type="color" id="cor-fundo-app-picker"></label></div> <div class="campo-grupo"><label for="cor-fundo-container-picker">Fundo Conteúdo <input type="color" id="cor-fundo-container-picker"></label></div> <div class="campo-grupo"><label for="cor-texto-picker">Cor do Texto <input type="color" id="cor-texto-picker"></label></div> <div class="campo-grupo"><label for="cor-destaque-picker">Cor Destaque <input type="color" id="cor-destaque-picker"></label></div> </div> <button class="btn btn-sucesso btn-full-width" id="btn-salvar-tema-personalizado" style="margin-top:10px;"><span class="icon">💾</span>Salvar Tema Personalizado</button> </div> </section> <section class="secao modo-completo-item"> <form id="form-horas"> <!-- ... (Form Horas) ... --><div class="grid-2-col"> <div class="campo-grupo"><label for="horas-data">Data:</label><input type="date" id="horas-data" required></div> <div class="campo-grupo"><label for="horas-quantidade">Horas Trabalhadas:</label><input type="number" id="horas-quantidade" step="0.1" min="0.1" required></div> </div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Registrar Horas</button> </form> <h3 style="margin-top:20px;">Registro de Horas (Mês Atual)</h3> <div class="filtros-container"><label for="filtro-mes-horas">Mês/Ano:</label><input type="month" id="filtro-mes-horas"></div> <ul id="lista-horas-registradas" class="lista-simples"></ul> <p id="sem-horas-msg" class="mensagem-feedback info" style="display:none;">Nenhuma hora neste mês.</p> <h4>Total Horas Mês: <span id="total-horas-mes" style="color: var(--cor-primaria);">0h</span></h4> </section> <section class="secao modo-completo-item"> <form id="form-anotacao"> <!-- ... (Form Anotações) ... --><input type="hidden" id="anotacao-id"> <div class="campo-grupo"><label for="anotacao-titulo">Título (Opcional):</label><input type="text" id="anotacao-titulo"></div> <div class="campo-grupo"><label for="anotacao-conteudo">Anotação:</label><textarea id="anotacao-conteudo"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Anotação</button> <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-anotacao" style="display:none;">Cancelar</button> </form> <h3 style="margin-top:20px;">Suas Anotações</h3> <div id="lista-anotacoes"></div> <p id="sem-anotacoes-msg" class="mensagem-feedback info" style="display:none;">Nenhuma anotação.</p> </section> <section class="secao"> <p>Faça backups regulares dos seus dados para segurança.</p> <div class="grid-2-col" style="margin-top:10px;"> <button class="btn btn-info btn-full-width" id="btn-exportar-dados"><span class="icon">📤</span>Exportar Dados</button> <div> <label for="input-importar-dados" class="btn btn-aviso btn-full-width" style="display:flex; text-align:center;"><span class="icon">📥</span>Importar (Substitui!)</label> <input type="file" id="input-importar-dados" accept=".json" style="display:none;"> </div> </div> </section> </div>

        </main>

        <footer id="page-footer">
             <p>&copy; <span id="ano-atual"></span> <span id="footer-nome-atelie">Seu Ateliê</span>. Feito com amor e carinho!</p>
        </footer>
    </div>

    <!-- Container da Barra de Navegação -->
     <div class="bottom-nav-container">
         <!-- Barra Rolável -->
         <nav class="bottom-nav-base" id="nav-scroll-container"> <button class="nav-scroll-btn prev nao-imprimir" id="nav-scroll-prev" disabled>‹</button> <div class="bottom-nav-scroll-wrapper" id="bottom-nav-scroll-wrapper"> <button class="bottom-nav-item active" data-tab="tab-dashboard" title="Painel"><span class="icon">📊</span>Painel</button> <button class="bottom-nav-item" data-tab="tab-producao" title="Produção"><span class="icon">🧵</span>Produção</button> <button class="bottom-nav-item" data-tab="tab-despesas" title="Despesas"><span class="icon">💰</span>Despesas</button> <button class="bottom-nav-item" data-tab="tab-pecas-modelos" title="Modelos"><span class="icon">✂️</span>Modelos</button> <button class="bottom-nav-item" data-tab="tab-clientes" title="Clientes"><span class="icon">👥</span>Clientes</button> <button class="bottom-nav-item" data-tab="tab-maquinas" title="Máquinas"><span class="icon">🔧</span>Máquinas</button> <button class="bottom-nav-item" data-tab="tab-contatos" title="Contatos"><span class="icon">📞</span>Contatos</button> <button class="bottom-nav-item" data-tab="tab-reparos" title="Reparos"><span class="icon">🛠️</span>Reparos</button> <button class="bottom-nav-item" data-tab="tab-configuracoes" title="Ajustes"><span class="icon">⚙️</span>Ajustes</button> </div> <button class="nav-scroll-btn next nao-imprimir" id="nav-scroll-next">›</button> </nav>
         <!-- Barra Expansível -->
         <div id="nav-expand-container">
             <div id="secondary-nav-panel">
                  <!-- Itens Secundários (A partir do 5º) -->
                 <button class="bottom-nav-item" data-tab="tab-clientes" title="Clientes"><span class="icon">👥</span>Clientes</button>
                 <button class="bottom-nav-item" data-tab="tab-maquinas" title="Máquinas"><span class="icon">🔧</span>Máquinas</button>
                 <button class="bottom-nav-item" data-tab="tab-contatos" title="Contatos"><span class="icon">📞</span>Contatos</button>
                 <button class="bottom-nav-item" data-tab="tab-reparos" title="Reparos"><span class="icon">🛠️</span>Reparos</button>
                 <button class="bottom-nav-item" data-tab="tab-configuracoes" title="Ajustes"><span class="icon">⚙️</span>Ajustes</button>
             </div>
             <nav class="bottom-nav-base" id="nav-expand-main">
                  <!-- Itens Principais (4 primeiros) -->
                  <button class="bottom-nav-item active" data-tab="tab-dashboard" title="Painel"><span class="icon">📊</span>Painel</button>
                  <button class="bottom-nav-item" data-tab="tab-producao" title="Produção"><span class="icon">🧵</span>Produção</button>
                  <button class="bottom-nav-item" data-tab="tab-despesas" title="Despesas"><span class="icon">💰</span>Despesas</button>
                  <button class="bottom-nav-item" data-tab="tab-pecas-modelos" title="Modelos"><span class="icon">✂️</span>Modelos</button>
                  <!-- Botão Expandir/Recolher -->
                  <button class="bottom-nav-item" id="btn-expand-nav" title="Mais/Menos">
                      <span class="icon icon-expand">🔼</span>
                      <span class="text-expand">Mais</span>
                  </button>
             </nav>
         </div>
     </div>

     <!-- Modais -->
      <!-- ... (Modais mantidos: Ajuda, Detalhes Máquina, Form Manut/Reparo) ... -->
      <div id="modal-ajuda" class="modal"> <div class="modal-conteudo"> <span class="modal-fechar" id="modal-ajuda-fechar">&times;</span> <h2 id="modal-ajuda-titulo">Ajuda</h2> <div id="modal-ajuda-conteudo"><p>Conteúdo da ajuda aqui...</p></div> </div> </div>
      <div id="modal-detalhes-maquina" class="modal"> <div class="modal-conteudo"> <span class="modal-fechar" id="modal-detalhes-maquina-fechar">&times;</span> <h2 id="modal-detalhes-maquina-titulo">Detalhes da Máquina</h2> <div id="modal-detalhes-maquina-info" class="maquina-info-grid"></div> <h3>Histórico de Manutenção Preventiva</h3> <button class="btn btn-pequeno btn-info" id="btn-nova-manutencao-modal">+ Nova Manutenção</button> <div class="tabela-responsiva"> <table id="tabela-historico-manutencao"> <thead><tr><th>Data</th><th>Tipo</th><th>Custo</th><th>Realizado Por</th><th>Próxima</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-historico-manutencao"></tbody> </table> </div> <p id="sem-manutencoes-msg" class="mensagem-feedback info" style="display:none;">Nenhuma manutenção registrada.</p> <h3 style="margin-top: 25px;">Histórico de Reparos Corretivos</h3> <button class="btn btn-pequeno btn-aviso" id="btn-novo-reparo-maquina-modal">+ Novo Reparo</button> <div class="tabela-responsiva"> <table id="tabela-historico-reparos-maq"> <thead><tr><th>Data</th><th>Problema</th><th>Peças</th><th>Custo</th><th>Realizado Por</th><th>Ações</th></tr></thead> <tbody id="corpo-tabela-historico-reparos-maq"></tbody> </table> </div> <p id="sem-reparos-maq-msg" class="mensagem-feedback info" style="display:none;">Nenhum reparo registrado.</p> </div> </div>
      <div id="modal-form-manut-reparo" class="modal"> <div class="modal-conteudo"> <span class="modal-fechar" id="modal-form-manut-reparo-fechar">&times;</span> <h2 id="modal-form-manut-reparo-titulo">Registrar Evento</h2> <form id="form-manutencao-maquina" style="display: none;"> <input type="hidden" id="manutencao-id"> <input type="hidden" id="manutencao-maquina-id"> <div class="grid-2-col"> <div class="campo-grupo"><label for="manutencao-data">Data:</label><input type="date" id="manutencao-data" required></div> <div class="campo-grupo"><label for="manutencao-tipo">Tipo:</label><input type="text" id="manutencao-tipo" placeholder="Ex: Limpeza, Lubrificação" required></div> </div> <div class="grid-2-col"> <div class="campo-grupo"><label for="manutencao-custo">Custo (R$):</label><input type="number" step="0.01" id="manutencao-custo" value="0"></div> <div class="campo-grupo"><label for="manutencao-proxima-data">Próxima Prevista:</label><input type="date" id="manutencao-proxima-data"></div> </div> <div class="campo-grupo"><label for="manutencao-realizado">Realizado Por:</label><input type="text" id="manutencao-realizado" placeholder="Ex: Eu mesmo, Técnico X"></div> <div class="campo-grupo"><label for="manutencao-notas">Notas:</label><textarea id="manutencao-notas"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Manutenção</button> </form> <form id="form-reparo-maquina" style="display: none;"> <input type="hidden" id="reparo-maquina-id"> <input type="hidden" id="reparo-maquina-maquina-id"> <div class="campo-grupo"><label for="reparo-maquina-data">Data:</label><input type="date" id="reparo-maquina-data" required></div> <div class="campo-grupo"><label for="reparo-maquina-problema">Problema Descrito:</label><textarea id="reparo-maquina-problema" required></textarea></div> <div class="campo-grupo"><label for="reparo-maquina-pecas">Peças Trocadas:</label><input type="text" id="reparo-maquina-pecas" placeholder="Ex: Agulha DBx1, Correia Z"></div> <div class="grid-2-col"> <div class="campo-grupo"><label for="reparo-maquina-custo-pecas">Custo Peças (R$):</label><input type="number" step="0.01" id="reparo-maquina-custo-pecas" value="0"></div> <div class="campo-grupo"><label for="reparo-maquina-custo-mo">Custo M.Obra (R$):</label><input type="number" step="0.01" id="reparo-maquina-custo-mo" value="0"></div> </div> <div class="campo-grupo"><label for="reparo-maquina-realizado">Realizado Por:</label><input type="text" id="reparo-maquina-realizado" placeholder="Ex: Técnico Y"></div> <div class="campo-grupo"><label for="reparo-maquina-notas">Notas:</label><textarea id="reparo-maquina-notas"></textarea></div> <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Reparo</button> </form> </div> </div>

    <!-- Container para impressão -->
    <div id="comprovante-para-impressao-container" class="comprovante-container-hidden" aria-hidden="true"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
            console.log("App Ateliê Gestor Pro - vNavConfigManutAjustada - JS Iniciado");

            // --- REFERÊNCIAS DOM (mantidas e verificadas) ---
            // ... (Todas as refs anteriores mantidas)
             const appTitle = document.getElementById('app-title'); const nomeAtelieHeader = document.getElementById('nome-atelie-header'); const nomeCostureiraHeader = document.getElementById('nome-costureira-header'); const footerNomeAtelie = document.getElementById('footer-nome-atelie'); const anoAtualEl = document.getElementById('ano-atual'); const mensagemGlobalEl = document.getElementById('mensagem-global'); const bodyEl = document.body; const subHeaderTituloAbaEl = document.getElementById('sub-header-titulo-aba'); const btnAjudaSubHeader = document.getElementById('btn-ajuda-sub-header'); const tabContents = document.querySelectorAll('.tab-content'); const modalAjuda = document.getElementById('modal-ajuda'); const modalAjudaFechar = document.getElementById('modal-ajuda-fechar'); const modalAjudaTitulo = document.getElementById('modal-ajuda-titulo'); const modalAjudaConteudo = document.getElementById('modal-ajuda-conteudo');
             const navScrollContainer = document.getElementById('nav-scroll-container'); const bottomNavScrollWrapper = document.getElementById('bottom-nav-scroll-wrapper'); const navScrollPrev = document.getElementById('nav-scroll-prev'); const navScrollNext = document.getElementById('nav-scroll-next');
             const navExpandContainer = document.getElementById('nav-expand-container'); const navExpandMain = document.getElementById('nav-expand-main'); const secondaryNavPanel = document.getElementById('secondary-nav-panel'); const btnExpandNav = document.getElementById('btn-expand-nav'); const allBottomNavItems = document.querySelectorAll('.bottom-nav-item');
             const dashValorCard1 = document.getElementById('dash-valor-card1'); const dashValorCard2 = document.getElementById('dash-valor-card2'); const dashValorCardDespesas = document.getElementById('dash-valor-card-despesas'); const dashValorCardLucro = document.getElementById('dash-valor-card-lucro'); const dashValorCard3 = document.getElementById('dash-valor-card3'); const dashValorCard4 = document.getElementById('dash-valor-card4'); const dashValorCard5 = document.getElementById('dash-valor-card5'); const dashValorCard6 = document.getElementById('dash-valor-card6'); const graficoGanhosMensaisDiv = document.getElementById('grafico-ganhos-mensais'); const listaTopPecasUl = document.getElementById('lista-top-pecas'); const btnToggleFiltroPeriodoDashboard = document.getElementById('btn-toggle-filtro-periodo-dashboard'); const camposFiltroPeriodoDashboard = document.getElementById('campos-filtro-periodo-dashboard'); const filtroDataInicioDashboard = document.getElementById('filtro-data-inicio-dashboard'); const filtroDataFimDashboard = document.getElementById('filtro-data-fim-dashboard'); const btnAplicarFiltroPeriodoDashboard = document.getElementById('btn-aplicar-filtro-periodo-dashboard'); const btnResetarFiltroPeriodoDashboard = document.getElementById('btn-resetar-filtro-periodo-dashboard'); const btnMesAtualDashboard = document.getElementById('btn-mes-atual-dashboard'); const periodoAtualDashboardEl = document.getElementById('periodo-atual-dashboard');
             const formProducao = document.getElementById('form-producao'); const producaoIdInput = document.getElementById('producao-id'); const prodDataInput = document.getElementById('prod-data'); const prodPecaModeloSelect = document.getElementById('prod-tipo-peca'); const prodModeloDescricaoInput = document.getElementById('prod-modelo-descricao'); const prodCorPecaInput = document.getElementById('prod-cor-peca'); const prodClienteSelect = document.getElementById('prod-cliente'); const processosParaProducaoDiv = document.getElementById('processos-para-producao'); const prodValorManualInput = document.getElementById('prod-valor-manual'); const prodQuantidadeInput = document.getElementById('prod-quantidade'); const prodValorTotalCalculadoInput = document.getElementById('prod-valor-total-calculado'); const prodMateriaisTextarea = document.getElementById('prod-materiais'); const prodPagoCheckbox = document.getElementById('prod-pago'); const prodObservacoesTextarea = document.getElementById('prod-observacoes'); const btnLimparFormProd = document.getElementById('btn-limpar-form-prod'); const corpoTabelaProducao = document.getElementById('corpo-tabela-producao'); const semProducaoMsg = document.getElementById('sem-producao-msg'); const filtroStatusPagamento = document.getElementById('filtro-status-pagamento'); const btnToggleFiltroPeriodoProducao = document.getElementById('btn-toggle-filtro-periodo-producao'); const camposFiltroPeriodoProducao = document.getElementById('campos-filtro-periodo-producao'); const filtroDataInicioProducao = document.getElementById('filtro-data-inicio-producao'); const filtroDataFimProducao = document.getElementById('filtro-data-fim-producao'); const btnAplicarFiltroPeriodoProducao = document.getElementById('btn-aplicar-filtro-periodo-producao'); const btnResetarFiltroPeriodoProducao = document.getElementById('btn-resetar-filtro-periodo-producao'); const btnMesAtualProducao = document.getElementById('btn-mes-atual-producao'); const periodoAtualProducaoEl = document.getElementById('periodo-atual-producao');
             const formDespesa = document.getElementById('form-despesa'); const despesaIdInput = document.getElementById('despesa-id'); const despesaDataInput = document.getElementById('despesa-data'); const despesaValorInput = document.getElementById('despesa-valor'); const despesaDescricaoInput = document.getElementById('despesa-descricao'); const despesaCategoriaSelect = document.getElementById('despesa-categoria'); const despesaNotasTextarea = document.getElementById('despesa-notas'); const btnCancelarEdicaoDespesa = document.getElementById('btn-cancelar-edicao-despesa'); const corpoTabelaDespesas = document.getElementById('corpo-tabela-despesas'); const semDespesasMsg = document.getElementById('sem-despesas-msg'); const filtroCategoriaDespesaSelect = document.getElementById('filtro-categoria-despesa'); const totalDespesasPeriodoEl = document.getElementById('total-despesas-periodo'); const btnToggleFiltroPeriodoDespesas = document.getElementById('btn-toggle-filtro-periodo-despesas'); const camposFiltroPeriodoDespesas = document.getElementById('campos-filtro-periodo-despesas'); const filtroDataInicioDespesas = document.getElementById('filtro-data-inicio-despesas'); const filtroDataFimDespesas = document.getElementById('filtro-data-fim-despesas'); const btnAplicarFiltroPeriodoDespesas = document.getElementById('btn-aplicar-filtro-periodo-despesas'); const btnResetarFiltroPeriodoDespesas = document.getElementById('btn-resetar-filtro-periodo-despesas'); const btnMesAtualDespesas = document.getElementById('btn-mes-atual-despesas'); const periodoAtualDespesasEl = document.getElementById('periodo-atual-despesas');
             const formPecaModelo = document.getElementById('form-tipo-peca'); const pecaModeloIdEditInput = document.getElementById('tipo-peca-id-edit'); const pecaModeloNomeInput = document.getElementById('tipo-peca-nome'); const pecaModeloCobraParCheckbox = document.getElementById('tipo-peca-cobra-par'); const listaProcessosPecaDiv = document.getElementById('lista-processos-peca'); const btnAddProcessoPeca = document.getElementById('btn-add-processo-peca'); const pecaModeloMateriaisTextarea = document.getElementById('tipo-peca-materiais'); const corpoTabelaPecasModelos = document.getElementById('corpo-tabela-tipos-peca'); const semPecasModelosMsg = document.getElementById('sem-tipos-peca-msg'); const btnCancelarEdicaoPecaModelo = document.getElementById('btn-cancelar-edicao-tipo-peca'); const btnAdicionarExemplosPecasModelos = document.getElementById('btn-adicionar-exemplos-tipos-peca');
             const formCliente = document.getElementById('form-cliente'); const clienteIdEditInput = document.getElementById('cliente-id-edit'); const clienteNomeInput = document.getElementById('cliente-nome'); const clienteTelefoneInput = document.getElementById('cliente-telefone'); const clienteEmailInput = document.getElementById('cliente-email'); const clienteEnderecoTextarea = document.getElementById('cliente-endereco'); const clienteObservacoesTextarea = document.getElementById('cliente-observacoes'); const btnCancelarEdicaoCliente = document.getElementById('btn-cancelar-edicao-cliente'); const tabelaClientesBody = document.getElementById('corpo-tabela-clientes'); const semClientesMsg = document.getElementById('sem-clientes-msg'); const filtroClientesInput = document.getElementById('filtro-clientes');
             const formMaquina = document.getElementById('form-maquina'); const maquinaIdInput = document.getElementById('maquina-id'); const maquinaNomeInput = document.getElementById('maquina-nome'); const maquinaMarcaInput = document.getElementById('maquina-marca'); const maquinaModeloInput = document.getElementById('maquina-modelo'); const maquinaTipoSelect = document.getElementById('maquina-tipo'); const maquinaDataCompraInput = document.getElementById('maquina-data-compra'); const maquinaValorCompraInput = document.getElementById('maquina-valor-compra'); const maquinaStatusSelect = document.getElementById('maquina-status'); const maquinaFotoUrlInput = document.getElementById('maquina-foto-url'); const maquinaNotasTextarea = document.getElementById('maquina-notas'); const btnCancelarEdicaoMaquina = document.getElementById('btn-cancelar-edicao-maquina'); const corpoTabelaMaquinas = document.getElementById('corpo-tabela-maquinas'); const semMaquinasMsg = document.getElementById('sem-maquinas-msg');
             const modalDetalhesMaquina = document.getElementById('modal-detalhes-maquina'); const modalDetalhesMaquinaFechar = document.getElementById('modal-detalhes-maquina-fechar'); const modalDetalhesMaquinaTitulo = document.getElementById('modal-detalhes-maquina-titulo'); const modalDetalhesMaquinaInfo = document.getElementById('modal-detalhes-maquina-info'); const btnNovaManutencaoModal = document.getElementById('btn-nova-manutencao-modal'); const corpoTabelaHistoricoManutencao = document.getElementById('corpo-tabela-historico-manutencao'); const semManutencoesMsg = document.getElementById('sem-manutencoes-msg'); const btnNovoReparoMaquinaModal = document.getElementById('btn-novo-reparo-maquina-modal'); const corpoTabelaHistoricoReparosMaq = document.getElementById('corpo-tabela-historico-reparos-maq'); const semReparosMaqMsg = document.getElementById('sem-reparos-maq-msg');
             const modalFormManutReparo = document.getElementById('modal-form-manut-reparo'); const modalFormManutReparoFechar = document.getElementById('modal-form-manut-reparo-fechar'); const modalFormManutReparoTitulo = document.getElementById('modal-form-manut-reparo-titulo'); const formManutencaoMaquina = document.getElementById('form-manutencao-maquina'); const manutencaoIdInput = document.getElementById('manutencao-id'); const manutencaoMaquinaIdInput = document.getElementById('manutencao-maquina-id'); const manutencaoDataInput = document.getElementById('manutencao-data'); const manutencaoTipoInput = document.getElementById('manutencao-tipo'); const manutencaoCustoInput = document.getElementById('manutencao-custo'); const manutencaoProximaDataInput = document.getElementById('manutencao-proxima-data'); const manutencaoRealizadoInput = document.getElementById('manutencao-realizado'); const manutencaoNotasTextarea = document.getElementById('manutencao-notas'); const formReparoMaquina = document.getElementById('form-reparo-maquina'); const reparoMaquinaIdInput = document.getElementById('reparo-maquina-id'); const reparoMaquinaMaquinaIdInput = document.getElementById('reparo-maquina-maquina-id'); const reparoMaquinaDataInput = document.getElementById('reparo-maquina-data'); const reparoMaquinaProblemaTextarea = document.getElementById('reparo-maquina-problema'); const reparoMaquinaPecasInput = document.getElementById('reparo-maquina-pecas'); const reparoMaquinaCustoPecasInput = document.getElementById('reparo-maquina-custo-pecas'); const reparoMaquinaCustoMoInput = document.getElementById('reparo-maquina-custo-mo'); const reparoMaquinaRealizadoInput = document.getElementById('reparo-maquina-realizado'); const reparoMaquinaNotasTextarea = document.getElementById('reparo-maquina-notas');
             const formContatoUtil = document.getElementById('form-contato-util'); const contatoUtilIdEditInput = document.getElementById('contato-util-id-edit'); const contatoUtilNomeInput = document.getElementById('contato-util-nome'); const contatoUtilTipoSelect = document.getElementById('contato-util-tipo'); const contatoUtilTelefoneInput = document.getElementById('contato-util-telefone'); const contatoUtilEmailInput = document.getElementById('contato-util-email'); const contatoUtilObservacoesTextarea = document.getElementById('contato-util-observacoes'); const btnCancelarEdicaoContatoUtil = document.getElementById('btn-cancelar-edicao-contato-util'); const tabelaContatosUteisBody = document.getElementById('corpo-tabela-contatos-uteis'); const semContatosUteisMsg = document.getElementById('sem-contatos-uteis-msg'); const filtroContatosInput = document.getElementById('filtro-contatos');
             const formReparo = document.getElementById('form-reparo'); const reparoIdInput = document.getElementById('reparo-id'); const reparoDataEntradaInput = document.getElementById('reparo-data-entrada'); const reparoOrigemTextoInput = document.getElementById('reparo-origem-texto'); const reparoDescricaoTextarea = document.getElementById('reparo-descricao'); const reparoValorInput = document.getElementById('reparo-valor'); const reparoStatusSelect = document.getElementById('reparo-status'); const btnCancelarEdicaoReparo = document.getElementById('btn-cancelar-edicao-reparo'); const corpoTabelaReparos = document.getElementById('corpo-tabela-reparos'); const semReparosMsg = document.getElementById('sem-reparos-msg');
             const formConfiguracoesNomesEl = document.getElementById('form-configuracoes-nomes'); const configNomeAtelieInput = document.getElementById('config-nome-atelie'); const configNomeCostureiraInput = document.getElementById('config-nome-costureira'); const configModoInterfaceSelect = document.getElementById('config-modo-interface'); const configNavStyleSelect = document.getElementById('config-nav-style'); const configTemaPredefinidoSelect = document.getElementById('config-tema-predefinido'); const editorTemaPersonalizadoDiv = document.getElementById('editor-tema-personalizado'); const btnSalvarTemaPersonalizado = document.getElementById('btn-salvar-tema-personalizado'); const colorPickers = { primaria: document.getElementById('cor-primaria-picker'), secundaria: document.getElementById('cor-secundaria-picker'), fundoApp: document.getElementById('cor-fundo-app-picker'), fundoContainer: document.getElementById('cor-fundo-container-picker'), texto: document.getElementById('cor-texto-picker'), destaque: document.getElementById('cor-destaque-picker'), }; const formHoras = document.getElementById('form-horas'); const horasDataInput = document.getElementById('horas-data'); const horasQuantidadeInput = document.getElementById('horas-quantidade'); const listaHorasRegistradasUl = document.getElementById('lista-horas-registradas'); const semHorasMsg = document.getElementById('sem-horas-msg'); const totalHorasMesSpan = document.getElementById('total-horas-mes'); const filtroMesHoras = document.getElementById('filtro-mes-horas'); const formAnotacao = document.getElementById('form-anotacao'); const anotacaoIdInput = document.getElementById('anotacao-id'); const anotacaoTituloInput = document.getElementById('anotacao-titulo'); const anotacaoConteudoTextarea = document.getElementById('anotacao-conteudo'); const btnCancelarEdicaoAnotacao = document.getElementById('btn-cancelar-edicao-anotacao'); const listaAnotacoesDiv = document.getElementById('lista-anotacoes'); const semAnotacoesMsg = document.getElementById('sem-anotacoes-msg'); const btnExportarDados = document.getElementById('btn-exportar-dados'); const inputImportarDados = document.getElementById('input-importar-dados'); const comprovanteContainerHidden = document.getElementById('comprovante-para-impressao-container');
             const filtroRelatorioCliente = document.getElementById('filtro-relatorio-cliente'); const btnGerarRelatorioPeriodo = document.getElementById('btn-gerar-relatorio-periodo');

            let currentMachineIdForModal = null;

            // --- ESTADO DA APLICAÇÃO (Mantido com novas arrays) ---
            let appData = {
                configuracoes: {
                    nomeAtelie: "Meu Ateliê de Costura", nomeCostureira: "Costureira Estrela",
                    temaPredefinido: "theme-classic-rose",
                    temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' },
                    modoInterface: "completo", navBarStyle: "scroll",
                    filtroPeriodoDashboard: { inicio: '', fim: '', expandido: false },
                    filtroPeriodoProducao: { inicio: '', fim: '', expandido: false },
                    filtroPeriodoDespesas: { inicio: '', fim: '', expandido: false }
                },
                pecasModelos: [], producoes: [], clientes: [], contatosUteis: [],
                maquinas: [], manutencoes: [], reparosMaquinas: [], despesas: [],
                reparos: [], horasTrabalhadas: [], anotacoes: []
            };

            // --- CONTEÚDO DE AJUDA (DETALHADO - Mantido) ---
             const conteudosAjuda = { /* ... (Conteúdo de ajuda mantido) ... */ 'dashboard': `<h3>📊 Painel (Dashboard)</h3> <p>Aqui você tem uma visão geral e rápida do seu ateliê no período selecionado.</p> <h4>Filtros:</h4> <ul> <li><strong>🗓️ Definir Período:</strong> Clique para abrir os campos de data Início e Fim. Após selecionar, clique em "Aplicar".</li> <li><strong>🔄 Mês Atual:</strong> Clique para definir rapidamente o período como o mês corrente.</li> <li><strong>Resetar Período:</strong> Volta o filtro para o mês atual padrão.</li> </ul> <h4>Cards de Resumo:</h4> <ul> <li><strong>Ganhos do Dia:</strong> Valor total das produções registradas HOJE (independente do filtro de período).</li> <li><strong>Ganhos do Período:</strong> Valor total de TODAS as produções dentro do período selecionado.</li> <li><strong>Despesas (Período):</strong> Soma de todas as despesas registradas na aba "Despesas" dentro do período selecionado.</li> <li><strong>Lucro Líquido (Período):</strong> Resultado de (Ganhos do Período) - (Despesas do Período). Mostra a rentabilidade.</li> <li><strong>Total Recebido (Período):</strong> Soma das produções MARCADAS COMO PAGAS dentro do período.</li> <li><strong>Total Pendente (Período):</strong> Soma das produções NÃO MARCADAS COMO PAGAS dentro do período.</li> <li><strong>Peças Produzidas (Período):</strong> Quantidade total de peças produzidas no período.</li> <li><strong>Horas Trabalhadas (Período):</strong> Soma das horas registradas na aba "Ajustes > Registrar Horas" dentro do período (Disponível no Modo Completo).</li> </ul> <div class="modo-completo-item"> <h4>Gráficos (Modo Completo):</h4> <ul> <li><strong>Ganhos Mensais:</strong> Mostra a evolução dos ganhos nos últimos 6 meses, terminando no mês final do período selecionado.</li> <li><strong>Peças Mais Produzidas:</strong> Lista as peças/modelos mais feitos no período selecionado.</li> </ul> </div>`, 'producao': `<h3>🧵 Produção</h3> <p>Registre e gerencie os itens que você produz.</p> <h4>Nova Produção:</h4> <ol> <li>Preencha a <strong>Data</strong> da produção.</li> <li>Selecione a <strong>Peça/Modelo Base</strong> (cadastrada na aba Modelos).</li> <li>(Opcional) Adicione uma <strong>Descrição Detalhada</strong> (Ex: tecido específico, ajuste, nome da cliente).</li> <li>(Opcional) Informe a <strong>Cor da Peça</strong>.</li> <li class="modo-completo-item">(Opcional - Modo Completo) Selecione o <strong>Cliente</strong>.</li> <li class="modo-completo-item">(Modo Completo) Marque os <strong>Processos Realizados</strong> (o valor será calculado).</li> <li class="modo-simples-item">(Modo Simples) Informe o <strong>Valor Total do Item</strong> manualmente.</li> <li>Informe a <strong>Quantidade</strong> de itens idênticos feitos.</li> <li class="modo-completo-item">(Opcional - Modo Completo) Descreva os <strong>Materiais Utilizados</strong>.</li> <li>Marque <strong>Pagamento Recebido</strong> se já foi pago.</li> <li>(Opcional) Adicione <strong>Observações</strong> gerais.</li> <li>Clique em <strong>Salvar Produção</strong>.</li> </ol> <h4>Histórico de Produção:</h4> <ul> <li>Use os filtros de <strong>Período</strong> e <strong>Status Pag.</strong> para encontrar registros.</li> <li><strong>Ações na Tabela:</strong> <ul> <li><strong>Botão Status (✔️ Pago / ⌛ Pend.):</strong> Clique para alternar rapidamente o status de pagamento.</li> <li><strong>✏️ Editar:</strong> Carrega os dados da produção no formulário acima para modificação.</li> <li><strong>🗑️ Excluir:</strong> Remove permanentemente o registro.</li> <li><strong>🧾 Comprov.:</strong> Gera um comprovante simples para impressão ou PDF.</li> <li><strong>💬 Zap:</strong> Abre o WhatsApp com um resumo da produção para compartilhar.</li> </ul> </li> <li><strong>Gerar Relatório Detalhado:</strong> Cria um relatório para impressão/PDF com todas as produções listadas na tabela (respeitando os filtros de período e status), com opção adicional de filtrar por cliente específico.</li> </ul>`, 'despesas': `<h3>💰 Despesas</h3> <p>Controle todos os custos e gastos do seu ateliê.</p> <h4>Nova Despesa:</h4> <ol> <li>Informe a <strong>Data</strong> da despesa.</li> <li>Digite o <strong>Valor</strong> gasto.</li> <li>Escreva uma <strong>Descrição</strong> clara (Ex: Compra de tecido X, Conta de luz, Manutenção máquina Y).</li> <li>Selecione a <strong>Categoria</strong> correta para classificar o gasto.</li> <li>(Opcional) Adicione <strong>Notas</strong> relevantes.</li> <li>Clique em <strong>Salvar Despesa</strong>.</li> </ol> <h4>Histórico de Despesas:</h4> <ul> <li>Use os filtros de <strong>Período</strong> e <strong>Categoria</strong> para analisar seus gastos.</li> <li>O <strong>Total Despesas (Período)</strong> é exibido abaixo da tabela.</li> <li><strong>Ações na Tabela:</strong> <ul> <li><strong>✏️ Editar:</strong> Carrega os dados da despesa no formulário para correção.</li> <li><strong>🗑️ Excluir:</strong> Remove permanentemente o registro.</li> </ul> </li> </ul> <p><strong>Dica:</strong> Registrar todas as despesas, inclusive materiais e custos fixos, permite calcular seu Lucro Líquido real no Painel.</p>`, 'pecas': `<h3>✂️ Peças/Modelos</h3> <p>Cadastre os tipos de peças que você faz para facilitar o registro da produção.</p> <h4>Cadastrar Peça/Modelo:</h4> <ol> <li>Digite um <strong>Nome da Peça/Modelo</strong> claro e descritivo.</li> <li>Marque <strong>Cobrado por Par</strong> se o preço/processos se referem ao par (Ex: luvas, meias).</li> <li class="modo-completo-item">(Modo Completo) Clique em <strong>+ Processo</strong> para adicionar etapas de produção. Para cada processo, informe o nome (Ex: Cortar, Costurar Bojo, Pregar Elástico) e o valor que você cobra por essa etapa.</li> <li class="modo-completo-item">(Opcional - Modo Completo) Liste os <strong>Materiais Padrão</strong> sugeridos para este modelo.</li> <li>Clique em <strong>Salvar Peça/Modelo</strong>.</li> </ol> <p>Use <strong>+ Adicionar Exemplos Iniciais</strong> para carregar alguns modelos comuns.</p> <h4>Lista de Modelos Cadastrados:</h4> <ul> <li>Visualize todos os seus modelos.</li> <li><strong>Ações:</strong> Editar (✏️) e Excluir (🗑️).</li> </ul>`, 'clientes': `<h3>👥 Clientes</h3> <p>Gerencie as informações dos seus clientes.</p> <h4>Cadastrar Cliente:</h4> <ol> <li>Digite o <strong>Nome Completo</strong>.</li> <li>(Recomendado) Informe o <strong>Telefone/WhatsApp</strong> para contato rápido.</li> <li>(Opcional) Adicione <strong>Email</strong> e <strong>Endereço</strong> (Modo Completo).</li> <li>(Opcional) Anote <strong>Observações</strong> importantes (preferências, medidas básicas, etc.).</li> <li>Clique em <strong>Salvar Cliente</strong>.</li> </ol> <h4>Lista de Clientes:</h4> <ul> <li>Use a <strong>Busca</strong> para encontrar um cliente pelo nome.</li> <li><strong>Ações:</strong> <ul> <li><strong>📞 WhatsApp:</strong> Abre uma conversa diretamente (se o telefone estiver cadastrado).</li> <li><strong>✏️ Editar:</strong> Carrega os dados do cliente no formulário para atualização.</li> <li><strong>🗑️ Excluir:</strong> Remove o cliente permanentemente.</li> </ul> </li> </ul>`, 'maquinas': `<h3>🔧 Máquinas</h3> <p>Cadastre e gerencie seus equipamentos e seu histórico.</p> <h4>Cadastrar Máquina:</h4> <ol> <li>Dê um <strong>Nome/Apelido</strong> fácil de identificar (Ex: Reta 1, Overlock da Bancada).</li> <li>Informe <strong>Marca</strong>, <strong>Modelo</strong> e selecione o <strong>Tipo</strong> da máquina.</li> <li>(Opcional) Registre a <strong>Data</strong> e o <strong>Valor da Compra</strong> para controle.</li> <li>Defina o <strong>Status</strong> atual (Ativa, Em Manutenção, etc.).</li> <li>(Opcional) Cole a <strong>URL da Foto</strong> online da máquina.</li> <li>(Opcional) Adicione <strong>Notas</strong> gerais.</li> <li>Clique em <strong>Salvar Máquina</strong>.</li> </ol> <h4>Lista de Máquinas:</h4> <ul> <li>Veja suas máquinas cadastradas.</li> <li><strong>Ações:</strong> <ul> <li><strong>👁️ Detalhes:</strong> Abre uma janela com todas as informações da máquina e o histórico de manutenções/reparos registrados para ela.</li> <li><strong>✏️ Editar:</strong> Carrega os dados da máquina no formulário para alteração.</li> <li><strong>🗑️ Excluir:</strong> Remove a máquina e todo o seu histórico associado.</li> </ul> </li> </ul> <h4>Detalhes da Máquina (ao clicar em 👁️):</h4> <ul> <li>Mostra todas as informações cadastradas da máquina.</li> <li><strong>Histórico de Manutenção Preventiva:</strong> Lista limpezas, lubrificações, etc. <ul> <li>Use <strong>+ Nova Manutenção</strong> para registrar um evento. Informe Data, Tipo, Custo (opcional), Quem fez e a data da Próxima prevista (opcional).</li> <li><strong>🗑️ Excluir:</strong> Remove um registro de manutenção.</li> </ul> </li> <li><strong>Histórico de Reparos Corretivos:</strong> Lista consertos realizados. <ul> <li>Use <strong>+ Novo Reparo</strong> para registrar um conserto. Informe Data, Problema, Peças trocadas (opcional), Custos (peças/m.obra), Quem fez.</li> <li><strong>🗑️ Excluir:</strong> Remove um registro de reparo.</li> </ul> </li> </ul>`, 'contatos': `<h3>📞 Contatos Úteis</h3> <p>Mantenha uma agenda de fornecedores, mecânicos, parceiros, etc.</p> <h4>Cadastrar Contato Útil:</h4> <ol> <li>Informe o <strong>Nome</strong> do contato/empresa.</li> <li>Selecione o <strong>Tipo</strong> (Fornecedor, Mecânico, etc.).</li> <li>Adicione <strong>Telefone/WhatsApp</strong> e/ou <strong>Email</strong>.</li> <li>(Opcional) Anote <strong>Observações</strong> (produtos, serviços, horários).</li> <li>Clique em <strong>Salvar Contato</strong>.</li> </ol> <h4>Lista de Contatos:</h4> <ul> <li>Use a <strong>Busca</strong> para encontrar um contato.</li> <li><strong>Ações:</strong> <ul> <li><strong>📞 WhatsApp:</strong> Abre uma conversa (se o telefone estiver cadastrado).</li> <li><strong>✏️ Editar:</strong> Carrega os dados no formulário para atualização.</li> <li><strong>🗑️ Excluir:</strong> Remove o contato.</li> </ul> </li> </ul>`, 'reparos': `<h3>🛠️ Reparos Gerais</h3> <p>Use esta aba para registrar consertos ou ajustes rápidos que <strong>não</strong> estão diretamente ligados a uma máquina específica cadastrada na aba "Máquinas". (Ex: ajuste em peça de cliente, pequeno reparo em ferramenta).</p> <p><strong>Nota:</strong> Para manutenções e consertos das suas máquinas de costura, use a aba "Máquinas" e o botão "Detalhes" (👁️) para acessar o histórico específico de cada uma.</p> <h4>Registrar Reparo Geral:</h4> <ol> <li>Informe a <strong>Data</strong>.</li> <li>Descreva a <strong>Origem</strong> (Ex: Cliente Joana, Ferramenta X).</li> <li>Detalhe a <strong>Descrição</strong> do problema ou serviço.</li> <li>(Opcional) Informe o <strong>Valor</strong> cobrado ou gasto.</li> <li>Selecione o <strong>Status</strong>.</li> <li>Clique em <strong>Salvar Reparo</strong>.</li> </ol> <h4>Histórico de Reparos Gerais:</h4> <ul> <li>Visualize a lista de reparos gerais.</li> <li><strong>Ações:</strong> Editar (✏️) e Excluir (🗑️).</li> </ul>`, 'configuracoes': `<h3>⚙️ Ajustes e Configurações</h3> <p>Personalize o aplicativo e gerencie seus dados.</p> <h4>Configurações Gerais:</h4> <ul> <li><strong>Nome Ateliê/Firma e Seu Nome:</strong> Define os nomes que aparecem no topo e rodapé do app. Clique em "Salvar Nomes" após alterar.</li> <li><strong>Modo da Interface:</strong> <ul> <li><strong>✨ Completo:</strong> Mostra todos os campos e funcionalidades (gráficos, processos, materiais, horas, anotações).</li> <li><strong>👌 Simples:</strong> Oculta campos mais avançados para um fluxo mais direto (foco em data, peça, quantidade, valor e pagamento na Produção).</li> </ul> </li> <li><strong>Estilo da Barra de Navegação:</strong> <ul> <li><strong>↔️ Rolagem Lateral:</strong> Mostra todas as abas em uma única linha na parte inferior. Use as setas < > ou arraste com o dedo/mouse para ver as abas ocultas.</li> <li><strong>↕️ Expandir/Recolher:</strong> Mostra as 4 abas principais e um botão com seta (🔼/🔽). Clique na seta para mostrar/ocultar as abas restantes em um painel acima.</li> </ul> </li> </ul> <h4>Editor de Tema Visual:</h4> <ul> <li>Escolha um <strong>Tema Predefinido</strong> na lista para mudar as cores rapidamente.</li> <li>Selecione <strong>✨ Personalizado ✨</strong> para habilitar os seletores de cores abaixo.</li> <li>Clique nos quadrados coloridos para escolher suas <strong>Cores Personalizadas</strong>. A prévia é aplicada em tempo real.</li> <li>Clique em <strong>Salvar Tema Personalizado</strong> para guardar suas escolhas.</li> </ul> <div class="modo-completo-item"> <h4>Registrar Horas (Modo Completo):</h4> <ul><li>Informe a <strong>Data</strong> e a <strong>Quantidade</strong> de horas trabalhadas no dia.</li><li>O total do mês é exibido abaixo e também no Painel (Dashboard).</li></ul> <h4>Anotações Rápidas (Modo Completo):</h4> <ul><li>Use para lembretes, ideias, listas, etc.</li><li>Digite um <strong>Título</strong> (opcional) e o <strong>Conteúdo</strong> da anotação.</li><li>Suas anotações salvas aparecerão abaixo do formulário.</li></ul> </div> <h4>Gerenciamento de Dados:</h4> <ul> <li><strong>📤 Exportar Dados:</strong> ESSENCIAL! Clique para gerar um arquivo de backup (.json) com TODOS os seus dados (produções, clientes, configurações, etc.). Salve este arquivo em um local seguro (computador, nuvem). Faça backups regularmente!</li> <li><strong>📥 Importar Dados:</strong> Use para restaurar dados de um arquivo de backup (.json) que você exportou anteriormente. <strong>CUIDADO:</strong> Isso SUBSTITUIRÁ todos os dados atuais no aplicativo pelos dados do arquivo importado. Use apenas se tiver certeza ou para restaurar um backup.</li> </ul>` };
             // ... (links específicos mantidos) ...
             conteudosAjuda['horas'] = conteudosAjuda.configuracoes?.split('<h4')[3] || "Registro de horas trabalhadas."; conteudosAjuda['anotacoes'] = conteudosAjuda.configuracoes?.split('<h4')[4] || "Suas anotações rápidas."; conteudosAjuda['config-dados'] = conteudosAjuda.configuracoes?.split('<h4')[5] || "Gerenciamento de dados, importação e exportação."; conteudosAjuda['config-tema'] = conteudosAjuda.configuracoes?.split('<h4')[2]?.split('<h4')[0] || "Personalização do tema visual."; conteudosAjuda['config-geral'] = conteudosAjuda.configuracoes?.split('<h4')[1]?.split('<h4')[0] || "Configurações gerais do aplicativo.";

            // --- FUNÇÕES UTILITÁRIAS (Mantidas) ---
            // ... (formatarMoeda, formatarData, etc.) ...
             const formatarMoeda = (valor = 0) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); const formatarData = (dataStr) => { if (!dataStr || dataStr.length < 10) return ''; try { const [y, m, d] = dataStr.split('-'); return `${d}/${m}/${y}`; } catch (e) { console.error("Erro ao formatar data:", dataStr, e); return ''; } }; const hojeFormatado = () => new Date().toISOString().split('T')[0]; const mesAnoAtualFormatado = () => new Date().toISOString().slice(0, 7); const primeiroDiaMesAtualFormatado = () => { try { const hoje = new Date(); return new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0]; } catch (e) { console.error("Erro ao obter primeiro dia do mês:", e); return hojeFormatado(); } }; const ultimoDiaMesAtualFormatado = () => { try { const hoje = new Date(); return new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0]; } catch (e) { console.error("Erro ao obter último dia do mês:", e); return hojeFormatado(); } }; const hexToRgba = (hex, alpha) => { if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) return `rgba(0,0,0,${alpha})`; try { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(0,0,0,${alpha})`; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } catch (e) { console.error("Erro ao converter HEX para RGBA:", hex, e); return `rgba(0,0,0,${alpha})`; } }; const validarCorCSS = (corString) => { if (!corString) return null; if (/^(#([0-9a-f]{3}){1,2}|(rgb|hsl)a?\([0-9.,\s%]+\)|[a-z]+)$/i.test(corString.trim())) return corString.trim(); return null; }; function mostrarMensagemGlobal(texto, tipo = 'sucesso', duracao = 3500) { if (!mensagemGlobalEl) return; mensagemGlobalEl.textContent = texto; mensagemGlobalEl.className = `mensagem-feedback ${tipo}`; mensagemGlobalEl.style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' }); setTimeout(() => { mensagemGlobalEl.style.display = 'none'; mensagemGlobalEl.textContent = ''; }, duracao); }

            // --- NAVEGAÇÃO E ABAS (Corrigida e com escolha de estilo) ---
            // ... (lógica de navegação atualizada) ...
             const scrollAmount = 100; let isDragging = false; let startX; let scrollLeftStart;
             function updateArrowVisibility() { if (!bottomNavScrollWrapper || !navScrollPrev || !navScrollNext) return; try { const { scrollLeft, scrollWidth, clientWidth } = bottomNavScrollWrapper; navScrollPrev.disabled = scrollLeft <= 1; navScrollNext.disabled = scrollLeft + clientWidth >= scrollWidth - 1; } catch(e){ console.error("Erro ao atualizar setas:", e);}}
             if (navScrollPrev) { navScrollPrev.addEventListener('click', () => { if (bottomNavScrollWrapper) { bottomNavScrollWrapper.scrollLeft -= scrollAmount; setTimeout(updateArrowVisibility, 50); } }); }
             if (navScrollNext) { navScrollNext.addEventListener('click', () => { if (bottomNavScrollWrapper) { bottomNavScrollWrapper.scrollLeft += scrollAmount; setTimeout(updateArrowVisibility, 50); } }); }
             function startDrag(e) { if(!bottomNavScrollWrapper) return; isDragging = true; startX = e.pageX || e.touches[0].pageX; scrollLeftStart = bottomNavScrollWrapper.scrollLeft; bottomNavScrollWrapper.style.cursor = 'grabbing'; bottomNavScrollWrapper.style.scrollBehavior = 'auto'; }
             function doDrag(e) { if (!isDragging || !bottomNavScrollWrapper) return; e.preventDefault(); const x = e.pageX || e.touches[0].pageX; const walk = (x - startX); bottomNavScrollWrapper.scrollLeft = scrollLeftStart - walk; }
             function stopDrag() { if (!isDragging || !bottomNavScrollWrapper) return; isDragging = false; bottomNavScrollWrapper.style.cursor = 'grab'; bottomNavScrollWrapper.style.scrollBehavior = 'smooth'; updateArrowVisibility(); }
             if (bottomNavScrollWrapper) { bottomNavScrollWrapper.addEventListener('mousedown', startDrag); bottomNavScrollWrapper.addEventListener('touchstart', startDrag, { passive: true }); bottomNavScrollWrapper.addEventListener('mousemove', doDrag); bottomNavScrollWrapper.addEventListener('touchmove', doDrag, { passive: false }); /* Prevent default scroll vertical on touchmove */ bottomNavScrollWrapper.addEventListener('mouseup', stopDrag); bottomNavScrollWrapper.addEventListener('mouseleave', stopDrag); bottomNavScrollWrapper.addEventListener('touchend', stopDrag); bottomNavScrollWrapper.addEventListener('scroll', updateArrowVisibility); }

             function ativarAba(targetTabId, clickedButton) { try { allBottomNavItems.forEach(i => i.classList.remove('active')); document.querySelectorAll(`.bottom-nav-item[data-tab="${targetTabId}"]`).forEach(btn => btn.classList.add('active')); tabContents.forEach(content => content.classList.remove('active')); const activeTabElement = document.getElementById(targetTabId); if (activeTabElement) { activeTabElement.classList.add('active'); let tituloAbaTexto = clickedButton.title || clickedButton.textContent.replace(clickedButton.querySelector('.icon')?.textContent || '', '').trim(); const iconeAba = clickedButton.querySelector('.icon'); subHeaderTituloAbaEl.textContent = (iconeAba ? iconeAba.textContent + ' ' : '') + tituloAbaTexto; if (btnAjudaSubHeader) { const helpKeyForTab = activeTabElement.dataset.helpKey || targetTabId.replace('tab-', ''); btnAjudaSubHeader.dataset.helpTarget = helpKeyForTab; } if (appData.configuracoes.navBarStyle === 'scroll' && clickedButton.closest('#nav-scroll-container')) { clickedButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); setTimeout(updateArrowVisibility, 350); } /* Removido auto-recolher: if (appData.configuracoes.navBarStyle === 'expand' && secondaryNavPanel?.classList.contains('visible')) { secondaryNavPanel.classList.remove('visible'); bodyEl.classList.remove('nav-expand-visible'); const iconExpand = btnExpandNav?.querySelector('.icon-expand'); if (iconExpand) iconExpand.textContent = '🔼'; } */ } else { console.error("Elemento da aba não encontrado:", targetTabId); } if (targetTabId === "tab-dashboard") renderizarDashboard(); else if (targetTabId === "tab-producao") { renderizarTabelaProducao(); popularSelectClientesRelatorio(); } else if (targetTabId === "tab-despesas") { renderizarTabelaDespesas(); popularCategoriasDespesaFiltro(); } else if (targetTabId === "tab-pecas-modelos") renderizarTabelaPecasModelos(); else if (targetTabId === "tab-clientes") renderizarTabelaClientes(); else if (targetTabId === "tab-maquinas") renderizarListaMaquinas(); else if (targetTabId === "tab-contatos") renderizarTabelaContatosUteis(); else if (targetTabId === "tab-reparos") renderizarTabelaReparos(); else if (targetTabId === "tab-configuracoes") { if (appData.configuracoes.modoInterface === 'completo') { renderizarHorasTrabalhadas(); renderizarAnotacoes(); } } } catch (e) { console.error("Erro ao ativar aba:", e); mostrarMensagemGlobal("Erro ao carregar aba.", "erro"); } }
             allBottomNavItems.forEach(item => { if (item.id === 'btn-expand-nav') return; item.addEventListener('click', (e) => { const targetTabId = e.currentTarget.dataset.tab; ativarAba(targetTabId, e.currentTarget); }); });

             if(btnExpandNav) { const iconExpand = btnExpandNav.querySelector('.icon-expand'); const textExpand = btnExpandNav.querySelector('.text-expand'); btnExpandNav.addEventListener('click', () => { if(secondaryNavPanel) { const isVisible = secondaryNavPanel.classList.toggle('visible'); bodyEl.classList.toggle('nav-expand-visible', isVisible); if(iconExpand) iconExpand.textContent = isVisible ? '🔽' : '🔼'; if(textExpand) textExpand.textContent = isVisible ? 'Menos' : 'Mais'; } }); }

             function aplicarEstiloNavegacao() { const estilo = appData.configuracoes.navBarStyle || 'scroll'; if(estilo === 'expand') { bodyEl.classList.remove('nav-scroll'); bodyEl.classList.add('nav-expand'); if (secondaryNavPanel) secondaryNavPanel.classList.remove('visible'); bodyEl.classList.remove('nav-expand-visible'); if(btnExpandNav) { const icon = btnExpandNav.querySelector('.icon-expand'); if(icon) icon.textContent = '🔼'; const text = btnExpandNav.querySelector('.text-expand'); if(text) text.textContent = 'Mais'; } } else { bodyEl.classList.remove('nav-expand'); bodyEl.classList.add('nav-scroll'); bodyEl.classList.remove('nav-expand-visible'); updateArrowVisibility(); } if(configNavStyleSelect) configNavStyleSelect.value = estilo; }
             if(configNavStyleSelect) { configNavStyleSelect.addEventListener('change', (e) => { appData.configuracoes.navBarStyle = e.target.value; aplicarEstiloNavegacao(); salvarDados(); if (e.target.value === 'expand' && secondaryNavPanel) { secondaryNavPanel.classList.remove('visible'); bodyEl.classList.remove('nav-expand-visible'); const iconExpand = btnExpandNav?.querySelector('.icon-expand'); if (iconExpand) iconExpand.textContent = '🔼'; const textExpand = btnExpandNav?.querySelector('.text-expand'); if (textExpand) textExpand.textContent = 'Mais'; } }); }

             window.addEventListener('scroll', () => { if (window.scrollY > 30) { bodyEl.classList.add('scrolled'); } else { bodyEl.classList.remove('scrolled'); } });
             const resizeObserver = new ResizeObserver(updateArrowVisibility); if (bottomNavScrollWrapper) resizeObserver.observe(bottomNavScrollWrapper);

             // --- MODAL DE AJUDA (Mantido) ---
             // ... (abrirModalAjuda e listeners mantidos) ...
              function abrirModalAjuda(chaveAjuda) { /* ... (Mantida com conteúdo detalhado) ... */ const conteudo = conteudosAjuda[chaveAjuda]; if (conteudo) { let tituloModal = "Ajuda"; const abaAtivaElement = document.querySelector('.bottom-nav-item.active'); if(abaAtivaElement) { let nomeAba = abaAtivaElement.title || abaAtivaElement.textContent.replace(abaAtivaElement.querySelector('.icon')?.textContent || '', '').trim(); tituloModal = `Ajuda: ${nomeAba}`; } modalAjudaTitulo.textContent = tituloModal; let cP = conteudo; if (appData.configuracoes.modoInterface === 'simples') { cP = cP.replace(/class="modo-completo-item"/g, 'style="display:none;"'); } else { cP = cP.replace(/class="modo-completo-item"/g, ''); } modalAjudaConteudo.innerHTML = cP; modalAjuda.style.display = 'block'; } else { console.warn("Conteúdo de ajuda não encontrado para:", chaveAjuda); mostrarMensagemGlobal(`Ajuda para "${chaveAjuda}" não encontrada.`, 'erro'); } }
              if (btnAjudaSubHeader) { btnAjudaSubHeader.addEventListener('click', (e) => { /* ... (Mantida) ... */ e.stopPropagation(); const helpKey = e.currentTarget.dataset.helpTarget; if (helpKey) { abrirModalAjuda(helpKey); } else { const activeTab = document.querySelector('.tab-content.active'); const fallbackKey = activeTab ? (activeTab.dataset.helpKey || activeTab.id.replace('tab-','')) : 'geral'; console.warn("Chave de ajuda não definida no botão, usando fallback:", fallbackKey); abrirModalAjuda(fallbackKey); } }); }
              if (modalAjudaFechar) modalAjudaFechar.addEventListener('click', () => modalAjuda.style.display = 'none');
              window.addEventListener('click', (event) => { if (event.target == modalAjuda) modalAjuda.style.display = 'none'; });

             // Modais Máquina
             if(modalDetalhesMaquinaFechar) modalDetalhesMaquinaFechar.addEventListener('click', () => modalDetalhesMaquina.style.display = 'none');
             if(modalFormManutReparoFechar) modalFormManutReparoFechar.addEventListener('click', () => modalFormManutReparo.style.display = 'none');
             window.addEventListener('click', (event) => { if (event.target == modalDetalhesMaquina) modalDetalhesMaquina.style.display = 'none'; if (event.target == modalFormManutReparo) modalFormManutReparo.style.display = 'none'; });
             if(btnNovaManutencaoModal) btnNovaManutencaoModal.addEventListener('click', () => abrirModalFormManutReparo('manutencao'));
             if(btnNovoReparoMaquinaModal) btnNovoReparoMaquinaModal.addEventListener('click', () => abrirModalFormManutReparo('reparo'));

            // --- PERSISTÊNCIA DE DADOS (Mantida) ---
            // ... (salvarDados e carregarDados mantidos e adaptados) ...
             function salvarDados() { try { localStorage.setItem('atelieAppData_vNavManutFinal', JSON.stringify(appData)); } catch (e) { console.error("Erro ao salvar dados:", e); } } // Nova chave
             function carregarDados() { const dadosSalvos = localStorage.getItem('atelieAppData_vNavManutFinal'); const defaultInicio = primeiroDiaMesAtualFormatado(); const defaultFim = hojeFormatado(); const defaultConfig = { nomeAtelie: "Meu Ateliê", nomeCostureira: "Costureira", temaPredefinido: "theme-classic-rose", temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' }, modoInterface: "completo", navBarStyle: "scroll", filtroPeriodoDashboard: { inicio: defaultInicio, fim: defaultFim, expandido: false }, filtroPeriodoProducao: { inicio: defaultInicio, fim: defaultFim, expandido: false }, filtroPeriodoDespesas: { inicio: defaultInicio, fim: defaultFim, expandido: false } }; const defaultAppData = { configuracoes: defaultConfig, pecasModelos: [], producoes: [], clientes: [], contatosUteis: [], maquinas: [], manutencoes: [], reparosMaquinas: [], despesas: [], reparos: [], horasTrabalhadas: [], anotacoes: [] }; if (dadosSalvos) { try { const parsedData = JSON.parse(dadosSalvos); const mergedConfig = { ...defaultConfig, ...(parsedData.configuracoes || {}) }; mergedConfig.temaPersonalizado = { ...defaultConfig.temaPersonalizado, ...(parsedData.configuracoes?.temaPersonalizado || {}) }; mergedConfig.filtroPeriodoDashboard = { ...defaultConfig.filtroPeriodoDashboard, ...(parsedData.configuracoes?.filtroPeriodoDashboard || {}) }; mergedConfig.filtroPeriodoProducao = { ...defaultConfig.filtroPeriodoProducao, ...(parsedData.configuracoes?.filtroPeriodoProducao || {}) }; mergedConfig.filtroPeriodoDespesas = { ...defaultConfig.filtroPeriodoDespesas, ...(parsedData.configuracoes?.filtroPeriodoDespesas || {}) }; ['filtroPeriodoDashboard', 'filtroPeriodoProducao', 'filtroPeriodoDespesas'].forEach(key => { if (!mergedConfig[key]?.inicio) mergedConfig[key].inicio = defaultInicio; if (!mergedConfig[key]?.fim) mergedConfig[key].fim = defaultFim; }); appData = { ...defaultAppData, ...parsedData, configuracoes: mergedConfig }; Object.keys(defaultAppData).forEach(key => { if (Array.isArray(defaultAppData[key]) && !Array.isArray(appData[key])) { appData[key] = []; } }); } catch(e) { console.error("Erro ao parsear dados salvos, usando defaults:", e); appData = defaultAppData; } } else { appData = defaultAppData; } aplicarModoInterface(); aplicarTema(); aplicarEstiloNavegacao(); preencherFormConfiguracoesNomes(); preencherFormConfigTema(); preencherSeletorModoInterface(); configurarFiltroPeriodo('dashboard', appData.configuracoes.filtroPeriodoDashboard, camposFiltroPeriodoDashboard, btnToggleFiltroPeriodoDashboard, filtroDataInicioDashboard, filtroDataFimDashboard, btnAplicarFiltroPeriodoDashboard, btnResetarFiltroPeriodoDashboard, btnMesAtualDashboard, periodoAtualDashboardEl, renderizarDashboard); configurarFiltroPeriodo('producao', appData.configuracoes.filtroPeriodoProducao, camposFiltroPeriodoProducao, btnToggleFiltroPeriodoProducao, filtroDataInicioProducao, filtroDataFimProducao, btnAplicarFiltroPeriodoProducao, btnResetarFiltroPeriodoProducao, btnMesAtualProducao, periodoAtualProducaoEl, renderizarTabelaProducao); configurarFiltroPeriodo('despesas', appData.configuracoes.filtroPeriodoDespesas, camposFiltroPeriodoDespesas, btnToggleFiltroPeriodoDespesas, filtroDataInicioDespesas, filtroDataFimDespesas, btnAplicarFiltroPeriodoDespesas, btnResetarFiltroPeriodoDespesas, btnMesAtualDespesas, periodoAtualDespesasEl, renderizarTabelaDespesas); }

             // --- FILTROS DE PERÍODO (Mantido) ---
             // ... (configurarFiltroPeriodo e atualizarDisplayPeriodo mantidos) ...
              function configurarFiltroPeriodo(tipo, configFiltro, camposDiv, btnToggle, inputInicio, inputFim, btnAplicar, btnResetar, btnMesAtual, displayEl, callbackRender) { if (!camposDiv || !btnToggle || !inputInicio || !inputFim || !btnAplicar || !btnResetar || !btnMesAtual || !displayEl) { console.error(`Elementos do filtro de período '${tipo}' não encontrados.`); return; } configFiltro.inicio = configFiltro.inicio || primeiroDiaMesAtualFormatado(); configFiltro.fim = configFiltro.fim || hojeFormatado(); inputInicio.value = configFiltro.inicio; inputFim.value = configFiltro.fim; camposDiv.style.display = configFiltro.expandido ? 'flex' : 'none'; btnToggle.querySelector('.arrow').textContent = configFiltro.expandido ? '▲' : '▼'; atualizarDisplayPeriodo(displayEl, configFiltro); btnToggle.addEventListener('click', () => { configFiltro.expandido = !configFiltro.expandido; camposDiv.style.display = configFiltro.expandido ? 'flex' : 'none'; btnToggle.querySelector('.arrow').textContent = configFiltro.expandido ? '▲' : '▼'; salvarDados(); }); btnAplicar.addEventListener('click', () => { if (!inputInicio.value || !inputFim.value) { mostrarMensagemGlobal("Selecione data de início e fim.", "erro"); return; } try { if (new Date(inputInicio.value) > new Date(inputFim.value)) { mostrarMensagemGlobal("Data de início não pode ser maior que a data de fim.", "erro"); return; } } catch (e) { mostrarMensagemGlobal("Datas inválidas.", "erro"); return; } configFiltro.inicio = inputInicio.value; configFiltro.fim = inputFim.value; configFiltro.expandido = false; camposDiv.style.display = 'none'; btnToggle.querySelector('.arrow').textContent = '▼'; salvarDados(); atualizarDisplayPeriodo(displayEl, configFiltro); if (callbackRender) callbackRender(); }); btnMesAtual.addEventListener('click', () => { configFiltro.inicio = primeiroDiaMesAtualFormatado(); configFiltro.fim = hojeFormatado(); inputInicio.value = configFiltro.inicio; inputFim.value = configFiltro.fim; configFiltro.expandido = false; camposDiv.style.display = 'none'; btnToggle.querySelector('.arrow').textContent = '▼'; salvarDados(); atualizarDisplayPeriodo(displayEl, configFiltro); if (callbackRender) callbackRender(); }); btnResetar.addEventListener('click', () => { configFiltro.inicio = primeiroDiaMesAtualFormatado(); configFiltro.fim = hojeFormatado(); inputInicio.value = configFiltro.inicio; inputFim.value = configFiltro.fim; configFiltro.expandido = false; camposDiv.style.display = 'none'; btnToggle.querySelector('.arrow').textContent = '▼'; salvarDados(); atualizarDisplayPeriodo(displayEl, configFiltro); if (callbackRender) callbackRender(); }); }
              function atualizarDisplayPeriodo(displayEl, configFiltro) { if(!displayEl) return; if (configFiltro.inicio && configFiltro.fim) { displayEl.textContent = `Período: ${formatarData(configFiltro.inicio)} a ${formatarData(configFiltro.fim)}`; } else { displayEl.textContent = 'Período não definido.'; } }

             // --- TEMA E MODO (Mantido) ---
             // ... (Funções mantidas) ...
             function aplicarModoInterface() { /* ... (Mantida) ... */ if (appData.configuracoes.modoInterface === 'simples') { bodyEl.classList.remove('modo-completo'); bodyEl.classList.add('modo-simples'); } else { bodyEl.classList.remove('modo-simples'); bodyEl.classList.add('modo-completo'); } const vMP = prodValorManualInput?.closest('.campo-grupo'); const pPD = processosParaProducaoDiv; const vTCP = prodValorTotalCalculadoInput?.closest('.campo-grupo'); if (vMP && pPD && vTCP) { if (appData.configuracoes.modoInterface === 'simples') { vMP.style.display = 'block'; pPD.style.display = 'none'; vTCP.style.display = 'none'; } else { vMP.style.display = 'none'; pPD.style.display = 'block'; vTCP.style.display = 'block'; } } }
             function preencherSeletorModoInterface() { /* ... (Mantida) ... */ if(configModoInterfaceSelect) configModoInterfaceSelect.value = appData.configuracoes.modoInterface; }
             if(configModoInterfaceSelect) configModoInterfaceSelect.addEventListener('change', (e) => { /* ... (Mantida) ... */ appData.configuracoes.modoInterface = e.target.value; aplicarModoInterface(); salvarDados(); mostrarMensagemGlobal(`Modo da interface: ${e.target.value === 'simples' ? 'Simples' : 'Completo'}.`, 'info'); const aT = document.querySelector('.tab-content.active'); if(aT){ const nIA = document.querySelector(`.bottom-nav-item[data-tab="${aT.id}"]`); if(nIA) ativarAba(nIA.dataset.tab, nIA); } }); // Usa ativarAba
             function aplicarTema() { /* ... (Mantida) ... */ const { temaPredefinido, temaPersonalizado, nomeAtelie, nomeCostureira } = appData.configuracoes; const rS = document.documentElement.style; bodyEl.className = bodyEl.className.replace(/theme-\w+|nav-scroll|nav-expand|nav-expand-visible/g, '').trim(); if(appData.configuracoes.modoInterface === 'simples') bodyEl.classList.add('modo-simples'); else bodyEl.classList.add('modo-completo'); bodyEl.classList.add(appData.configuracoes.navBarStyle === 'expand' ? 'nav-expand' : 'nav-scroll'); const aC = (c) => { try { rS.setProperty('--cor-primaria', c.primaria); rS.setProperty('--cor-secundaria', c.secundaria); rS.setProperty('--cor-fundo-app', c.fundoApp); rS.setProperty('--cor-fundo-container', c.fundoContainer); rS.setProperty('--cor-texto', c.texto); rS.setProperty('--cor-destaque', c.destaque); } catch(e){ console.error("Erro ao aplicar cores:", c, e); }}; if (temaPredefinido === 'custom' && temaPersonalizado) { aC(temaPersonalizado); } else if (temaPredefinido) { bodyEl.classList.add(temaPredefinido); ['--cor-primaria', '--cor-secundaria', '--cor-fundo-app', '--cor-fundo-container', '--cor-texto', '--cor-destaque'].forEach(v => rS.removeProperty(v)); setTimeout(() => { try { const cS = getComputedStyle(document.documentElement); const cC = { primaria: cS.getPropertyValue('--cor-primaria').trim(), secundaria: cS.getPropertyValue('--cor-secundaria').trim(), fundoApp: cS.getPropertyValue('--cor-fundo-app').trim(), fundoContainer: cS.getPropertyValue('--cor-fundo-container').trim(), texto: cS.getPropertyValue('--cor-texto').trim(), destaque: cS.getPropertyValue('--cor-destaque').trim(), }; Object.keys(colorPickers).forEach(k => { if(colorPickers[k] && cC[k]) colorPickers[k].value = cC[k];}); } catch(e){ console.error("Erro ao obter/aplicar cores computadas:", e); }}, 50); } try { const cPA = getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim(); rS.setProperty('--cor-primaria-transparente', hexToRgba(cPA, 0.25)); } catch(e) { console.error("Erro ao definir cor primária transparente:", e); } if(appTitle) appTitle.textContent = `${nomeAtelie || "Ateliê"} - Gestor Pro`; if(nomeAtelieHeader) nomeAtelieHeader.textContent = nomeAtelie || "Seu Ateliê"; if(footerNomeAtelie) footerNomeAtelie.textContent = nomeAtelie || "Seu Ateliê"; if(nomeCostureiraHeader) nomeCostureiraHeader.textContent = nomeCostureira || "Costureira"; }
             function preencherFormConfiguracoesNomes() { /* ... (Mantida) ... */ if(configNomeAtelieInput) configNomeAtelieInput.value = appData.configuracoes.nomeAtelie; if(configNomeCostureiraInput) configNomeCostureiraInput.value = appData.configuracoes.nomeCostureira; }
             function preencherFormConfigTema() { /* ... (Mantida) ... */ if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.value = appData.configuracoes.temaPredefinido; const cT = appData.configuracoes.temaPersonalizado; Object.keys(colorPickers).forEach(k => { if(colorPickers[k] && cT[k]) colorPickers[k].value = cT[k];}); if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = appData.configuracoes.temaPredefinido === 'custom' ? 'block' : 'none'; }
             if(formConfiguracoesNomesEl) formConfiguracoesNomesEl.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); appData.configuracoes.nomeAtelie = configNomeAtelieInput.value.trim() || "Meu Ateliê"; appData.configuracoes.nomeCostureira = configNomeCostureiraInput.value.trim() || "Costureira"; aplicarTema(); salvarDados(); mostrarMensagemGlobal('Nomes salvos!', 'sucesso'); });
             if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.addEventListener('change', (e) => { /* ... (Mantida) ... */ appData.configuracoes.temaPredefinido = e.target.value; if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = e.target.value === 'custom' ? 'block' : 'none'; aplicarTema(); salvarDados(); });
             Object.keys(colorPickers).forEach(key => { if(colorPickers[key]) colorPickers[key].addEventListener('input', (e) => { /* ... (Mantida) ... */ if (appData.configuracoes.temaPredefinido !== 'custom') { if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.value = 'custom'; appData.configuracoes.temaPredefinido = 'custom'; if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = 'block'; } const cssVarName = `--cor-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`; document.documentElement.style.setProperty(cssVarName, e.target.value); if (key === 'primaria') { try { document.documentElement.style.setProperty('--cor-primaria-transparente', hexToRgba(e.target.value, 0.25)); } catch(er){ console.error("Erro hexToRgba:", er); } } }); });
             if(btnSalvarTemaPersonalizado) btnSalvarTemaPersonalizado.addEventListener('click', () => { /* ... (Mantida) ... */ Object.keys(colorPickers).forEach(key => { if(appData.configuracoes.temaPersonalizado && colorPickers[key]) appData.configuracoes.temaPersonalizado[key] = colorPickers[key].value; }); appData.configuracoes.temaPredefinido = 'custom'; if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.value = 'custom'; aplicarTema(); salvarDados(); mostrarMensagemGlobal('Tema personalizado salvo!', 'sucesso'); });


            // --- CRUDs (Peças, Clientes, Contatos, Produção, Reparos, Horas, Anotações - Mantidos) ---
            // ... (Lógicas CRUD mantidas) ...
             let processosTemporariosPecaModelo = []; function renderizarInputProcessoPecaModelo(processo = { id: Date.now(), nome: '', valor: 0 }) { const div = document.createElement('div'); div.classList.add('processo-item'); div.dataset.id = processo.id; div.innerHTML = `<input type="text" placeholder="Nome Processo" value="${processo.nome}" data-field="nome-processo-peca"><input type="number" step="0.01" placeholder="Valor (R$)" value="${processo.valor}" data-field="valor-processo-peca"><button type="button" class="btn btn-pequeno btn-perigo btn-remover-processo-temp">X</button>`; if(listaProcessosPecaDiv) listaProcessosPecaDiv.appendChild(div); const btnRemover = div.querySelector('.btn-remover-processo-temp'); if(btnRemover) btnRemover.addEventListener('click', () => { processosTemporariosPecaModelo = processosTemporariosPecaModelo.filter(p => p.id !== processo.id); div.remove(); }); div.querySelectorAll('input').forEach(input => { input.addEventListener('input', () => { const idProc = parseInt(div.dataset.id); const nomeInput = div.querySelector('input[data-field="nome-processo-peca"]').value.trim(); const valorInput = parseFloat(div.querySelector('input[data-field="valor-processo-peca"]').value); const index = processosTemporariosPecaModelo.findIndex(p => p.id === idProc); if (index > -1) { processosTemporariosPecaModelo[index].nome = nomeInput; processosTemporariosPecaModelo[index].valor = isNaN(valorInput) ? 0 : valorInput; } }); });}
             if(btnAddProcessoPeca) btnAddProcessoPeca.addEventListener('click', () => { const nP = { id: Date.now(), nome: '', valor: 0 }; processosTemporariosPecaModelo.push(nP); renderizarInputProcessoPecaModelo(nP); });
             if(formPecaModelo) formPecaModelo.addEventListener('submit', (e) => { e.preventDefault(); const n = pecaModeloNomeInput.value.trim(); const cPP = pecaModeloCobraParCheckbox.checked; const m = pecaModeloMateriaisTextarea.value.trim(); const iE = pecaModeloIdEditInput.value; if (!n) { mostrarMensagemGlobal('Nome da peça/modelo obrigatório.', 'erro'); return; } const pVS = processosTemporariosPecaModelo.filter(p => p.nome.trim() !== '' && typeof p.valor === 'number' && !isNaN(p.valor) && p.valor >= 0); const pMD = { nome:n, cobraPorPar:cPP, processos: pVS, materiais:m }; if (iE) { const idx = appData.pecasModelos.findIndex(pm => pm.id == iE); if (idx > -1) appData.pecasModelos[idx] = { ...appData.pecasModelos[idx], ...pMD }; } else { pMD.id = Date.now(); appData.pecasModelos.push(pMD); } salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); limparFormPecaModelo(); mostrarMensagemGlobal(`Peça/Modelo ${iE ? 'atualizado' : 'salvo'}!`, 'sucesso'); });
             function limparFormPecaModelo() { if(formPecaModelo) formPecaModelo.reset(); if(pecaModeloIdEditInput) pecaModeloIdEditInput.value = ''; if(listaProcessosPecaDiv) listaProcessosPecaDiv.innerHTML = ''; processosTemporariosPecaModelo = []; if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.style.display = 'none'; if(pecaModeloNomeInput) pecaModeloNomeInput.focus(); }
             if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.addEventListener('click', limparFormPecaModelo);
             function carregarPecaModeloParaEdicao(id) { const pM = appData.pecasModelos.find(pm => pm.id == id); if (pM) { if(pecaModeloIdEditInput) pecaModeloIdEditInput.value = pM.id; if(pecaModeloNomeInput) pecaModeloNomeInput.value = pM.nome; if(pecaModeloCobraParCheckbox) pecaModeloCobraParCheckbox.checked = pM.cobraPorPar; if(pecaModeloMateriaisTextarea) pecaModeloMateriaisTextarea.value = pM.materiais || ''; if(listaProcessosPecaDiv) listaProcessosPecaDiv.innerHTML = ''; processosTemporariosPecaModelo = JSON.parse(JSON.stringify(pM.processos || [])); processosTemporariosPecaModelo.forEach(p => renderizarInputProcessoPecaModelo(p)); if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-pecas-modelos"]')?.click(); setTimeout(() => { if(pecaModeloNomeInput) pecaModeloNomeInput.focus()}, 100); } }
             function excluirPecaModelo(id) { if (confirm('Excluir peça/modelo?')) { appData.pecasModelos = appData.pecasModelos.filter(pm => pm.id != id); salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); mostrarMensagemGlobal('Peça/Modelo excluído.', 'info'); } }
             function renderizarTabelaPecasModelos() { if (!corpoTabelaPecasModelos) return; corpoTabelaPecasModelos.innerHTML = ''; if (appData.pecasModelos.length === 0) { if(semPecasModelosMsg) semPecasModelosMsg.style.display = 'block'; if(corpoTabelaPecasModelos.parentElement) corpoTabelaPecasModelos.parentElement.style.display = 'none'; return; } if(semPecasModelosMsg) semPecasModelosMsg.style.display = 'none'; if(corpoTabelaPecasModelos.parentElement) corpoTabelaPecasModelos.parentElement.style.display = 'table'; appData.pecasModelos.forEach(pm => { const tr = document.createElement('tr'); const vTP = (pm.processos || []).reduce((s, p) => s + (p.valor || 0), 0); tr.innerHTML = `<td>${pm.nome}</td><td class="modo-completo-item">${(pm.processos && pm.processos.length > 0) ? (pm.processos || []).map(p => `${p.nome} (${formatarMoeda(p.valor || 0)})`).join('<br>') + `<hr style="margin:3px 0;"><small>Total: ${formatarMoeda(vTP)}</small>` : 'S/ Processos'}</td><td>${pm.cobraPorPar ? 'Par' : 'Unid.'}</td><td class="modo-completo-item">${(pm.materiais || '-').substring(0,30)}${(pm.materiais && pm.materiais.length > 30) ? '...' : ''}</td><td><button class="btn btn-pequeno btn-aviso btn-editar-peca-modelo" data-id="${pm.id}">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-peca-modelo" data-id="${pm.id}">🗑️</button></td>`; corpoTabelaPecasModelos.appendChild(tr); }); corpoTabelaPecasModelos.querySelectorAll('.btn-editar-peca-modelo').forEach(b => b.addEventListener('click', (e) => carregarPecaModeloParaEdicao(e.target.dataset.id))); corpoTabelaPecasModelos.querySelectorAll('.btn-excluir-peca-modelo').forEach(b => b.addEventListener('click', (e) => excluirPecaModelo(e.target.dataset.id))); aplicarModoInterface(); }
             function atualizarSelectPecaModeloProducao() { if (!prodPecaModeloSelect) return; prodPecaModeloSelect.innerHTML = '<option value="">Selecione...</option>'; appData.pecasModelos.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(pm => { const o = document.createElement('option'); o.value = pm.id; o.textContent = pm.nome; prodPecaModeloSelect.appendChild(o); }); }
             function popularPecasModelosExemploLingerie() { const exs = [ { id:Date.now()+1, nome:"Sutiã Básico Exemplo", cobraPorPar:false, processos:[{id:Date.now()+2,nome:"Cortar Ex.",valor:0.8},{id:Date.now()+3,nome:"Costurar Bojo Ex.",valor:1.5}], materiais:"Microfibra, Bojo" }, { id:Date.now()+4, nome:"Calcinha Básica Exemplo", cobraPorPar:false, processos:[{id:Date.now()+5,nome:"Cortar Ex.",valor:0.5},{id:Date.now()+6,nome:"Elástico Pernas Ex.",valor:0.9}], materiais:"Algodão, Elástico"} ]; exs.forEach(ex => { if (!appData.pecasModelos.find(pm => pm.nome === ex.nome)) appData.pecasModelos.push(ex); }); salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); mostrarMensagemGlobal('Exemplos adicionados (se não existiam)!', 'info'); }
             if(btnAdicionarExemplosPecasModelos) btnAdicionarExemplosPecasModelos.addEventListener('click', () => { if (appData.pecasModelos.length === 0 || confirm("Adicionar exemplos mesmo com modelos existentes (não duplicará nomes idênticos)?")) { popularPecasModelosExemploLingerie(); } });
             if(formCliente) formCliente.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id=clienteIdEditInput.value; const n=clienteNomeInput.value.trim(); const t=clienteTelefoneInput.value.trim(); const em=clienteEmailInput.value.trim(); const end=clienteEnderecoTextarea.value.trim(); const o=clienteObservacoesTextarea.value.trim(); if(!n){mostrarMensagemGlobal('Nome do cliente obrigatório.','erro'); return;} const cD={nome:n,telefone:t,email:em,endereco:end,observacoes:o}; if(id){const idx=appData.clientes.findIndex(c=>c.id==id); if(idx>-1)appData.clientes[idx]={...appData.clientes[idx],...cD};}else{cD.id=Date.now();appData.clientes.push(cD);} salvarDados(); renderizarTabelaClientes(); popularSelectClientesProducao(); limparFormCliente(); mostrarMensagemGlobal(`Cliente ${id?'atualizado':'salvo'}!`,'sucesso');});
             function limparFormCliente() { /* ... (Mantida) ... */ if(formCliente) formCliente.reset(); if(clienteIdEditInput) clienteIdEditInput.value=''; if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.style.display='none'; if(clienteNomeInput) clienteNomeInput.focus(); }
             if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.addEventListener('click', limparFormCliente);
             function carregarClienteParaEdicao(id) { /* ... (Mantida) ... */ const c=appData.clientes.find(cl=>cl.id==id); if(c){ if(clienteIdEditInput) clienteIdEditInput.value=c.id; if(clienteNomeInput) clienteNomeInput.value=c.nome; if(clienteTelefoneInput) clienteTelefoneInput.value=c.telefone||''; if(clienteEmailInput) clienteEmailInput.value=c.email||''; if(clienteEnderecoTextarea) clienteEnderecoTextarea.value=c.endereco||''; if(clienteObservacoesTextarea) clienteObservacoesTextarea.value=c.observacoes||''; if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-clientes"]')?.click(); setTimeout(()=>{ if(clienteNomeInput) clienteNomeInput.focus()},100);}}
             function excluirCliente(id) { /* ... (Mantida) ... */ if(confirm('Excluir cliente?')){appData.clientes=appData.clientes.filter(c=>c.id!=id); salvarDados(); renderizarTabelaClientes(); popularSelectClientesProducao(); mostrarMensagemGlobal('Cliente excluído.','info');}}
             function renderizarTabelaClientes() { /* ... (Mantida) ... */ if(!tabelaClientesBody || !filtroClientesInput) return; tabelaClientesBody.innerHTML=''; const tF=filtroClientesInput.value.toLowerCase(); const cFil=appData.clientes.filter(c=>c.nome.toLowerCase().includes(tF)||(c.telefone&&c.telefone.includes(tF))).sort((a,b)=>a.nome.localeCompare(b.nome)); if(cFil.length===0){ if(semClientesMsg) semClientesMsg.style.display='block'; if(tabelaClientesBody.parentElement) tabelaClientesBody.parentElement.style.display='none'; return;} if(semClientesMsg) semClientesMsg.style.display='none'; if(tabelaClientesBody.parentElement) tabelaClientesBody.parentElement.style.display='table'; cFil.forEach(c=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td>${c.telefone||'-'}${c.email?`<br><small>${c.email}</small>`:''}</td><td class="modo-completo-item">${(c.observacoes||'-').substring(0,40)}${(c.observacoes&&c.observacoes.length>40)?'...':''}</td><td>${c.telefone?`<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" class="btn btn-pequeno btn-whatsapp" title="WhatsApp">📞</a>`:''}<button class="btn btn-pequeno btn-aviso btn-editar-cliente" data-id="${c.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-cliente" data-id="${c.id}" title="Excluir">🗑️</button></td>`; tabelaClientesBody.appendChild(tr);}); tabelaClientesBody.querySelectorAll('.btn-editar-cliente').forEach(b=>b.addEventListener('click',(e)=>carregarClienteParaEdicao(e.target.dataset.id))); tabelaClientesBody.querySelectorAll('.btn-excluir-cliente').forEach(b=>b.addEventListener('click',(e)=>excluirCliente(e.target.dataset.id))); aplicarModoInterface();}
             if(filtroClientesInput) filtroClientesInput.addEventListener('input', renderizarTabelaClientes);
             function popularSelectClientesProducao() { /* ... (Mantida) ... */ if(!prodClienteSelect) return; prodClienteSelect.innerHTML='<option value="">Nenhum cliente</option>'; appData.clientes.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nome;prodClienteSelect.appendChild(o);});}
             if(formContatoUtil) formContatoUtil.addEventListener('submit', (e)=>{ /* ... (Mantida) ... */ e.preventDefault(); const id=contatoUtilIdEditInput.value; const n=contatoUtilNomeInput.value.trim(); const tipo=contatoUtilTipoSelect.value; const tel=contatoUtilTelefoneInput.value.trim(); const email=contatoUtilEmailInput.value.trim(); const obs=contatoUtilObservacoesTextarea.value.trim(); if(!n||!tipo){mostrarMensagemGlobal('Nome e tipo são obrigatórios.','erro'); return;} const cUData={nome:n,tipo,telefone:tel,email,observacoes:obs}; if(id){const idx=appData.contatosUteis.findIndex(cu=>cu.id==id); if(idx>-1)appData.contatosUteis[idx]={...appData.contatosUteis[idx],...cUData};}else{cUData.id=Date.now();appData.contatosUteis.push(cUData);} salvarDados();renderizarTabelaContatosUteis();limparFormContatoUtil();mostrarMensagemGlobal(`Contato ${id?'atualizado':'salvo'}!`,'sucesso');});
             function limparFormContatoUtil(){ /* ... (Mantida) ... */ if(formContatoUtil) formContatoUtil.reset(); if(contatoUtilIdEditInput) contatoUtilIdEditInput.value=''; if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.style.display='none'; if(contatoUtilNomeInput) contatoUtilNomeInput.focus();}
             if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.addEventListener('click', limparFormContatoUtil);
             function carregarContatoUtilParaEdicao(id){ /* ... (Mantida) ... */ const cu=appData.contatosUteis.find(c=>c.id==id); if(cu){ if(contatoUtilIdEditInput) contatoUtilIdEditInput.value=cu.id; if(contatoUtilNomeInput) contatoUtilNomeInput.value=cu.nome; if(contatoUtilTipoSelect) contatoUtilTipoSelect.value=cu.tipo; if(contatoUtilTelefoneInput) contatoUtilTelefoneInput.value=cu.telefone||''; if(contatoUtilEmailInput) contatoUtilEmailInput.value=cu.email||''; if(contatoUtilObservacoesTextarea) contatoUtilObservacoesTextarea.value=cu.observacoes||''; if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-contatos"]')?.click(); setTimeout(()=>{ if(contatoUtilNomeInput) contatoUtilNomeInput.focus()},100);}}
             function excluirContatoUtil(id){ /* ... (Mantida) ... */ if(confirm('Excluir este contato útil?')){appData.contatosUteis=appData.contatosUteis.filter(cu=>cu.id!=id); salvarDados(); renderizarTabelaContatosUteis(); mostrarMensagemGlobal('Contato útil excluído.','info');}}
             function renderizarTabelaContatosUteis(){ /* ... (Mantida) ... */ if(!tabelaContatosUteisBody || !filtroContatosInput) return; tabelaContatosUteisBody.innerHTML=''; const tF=filtroContatosInput.value.toLowerCase(); const cUFil=appData.contatosUteis.filter(cu=>cu.nome.toLowerCase().includes(tF)||cu.tipo.toLowerCase().includes(tF)||(cu.telefone&&cu.telefone.includes(tF))).sort((a,b)=>a.nome.localeCompare(b.nome)); if(cUFil.length===0){ if(semContatosUteisMsg) semContatosUteisMsg.style.display='block'; if(tabelaContatosUteisBody.parentElement) tabelaContatosUteisBody.parentElement.style.display='none'; return;} if(semContatosUteisMsg) semContatosUteisMsg.style.display='none'; if(tabelaContatosUteisBody.parentElement) tabelaContatosUteisBody.parentElement.style.display='table'; cUFil.forEach(cu=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${cu.nome}</td><td>${cu.tipo}</td><td>${cu.telefone||'-'}${cu.email?`<br><small>${cu.email}</small>`:''}</td><td class="modo-completo-item">${(cu.observacoes||'-').substring(0,40)}${(cu.observacoes&&cu.observacoes.length>40)?'...':''}</td><td>${cu.telefone?`<a href="https://wa.me/55${cu.telefone.replace(/\D/g,'')}" target="_blank" class="btn btn-pequeno btn-whatsapp" title="WhatsApp">📞</a>`:''}<button class="btn btn-pequeno btn-aviso btn-editar-contato-util" data-id="${cu.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-contato-util" data-id="${cu.id}" title="Excluir">🗑️</button></td>`; tabelaContatosUteisBody.appendChild(tr);}); tabelaContatosUteisBody.querySelectorAll('.btn-editar-contato-util').forEach(b=>b.addEventListener('click',(e)=>carregarContatoUtilParaEdicao(e.target.dataset.id))); tabelaContatosUteisBody.querySelectorAll('.btn-excluir-contato-util').forEach(b=>b.addEventListener('click',(e)=>excluirContatoUtil(e.target.dataset.id))); aplicarModoInterface();}
             if(filtroContatosInput) filtroContatosInput.addEventListener('input', renderizarTabelaContatosUteis);
             if(prodPecaModeloSelect) prodPecaModeloSelect.addEventListener('change', () => { /* ... (Mantida) ... */ const pMID = prodPecaModeloSelect.value; if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = ''; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value = ''; if (pMID) { const pM = appData.pecasModelos.find(pm => pm.id == pMID); if (pM && pM.processos && pM.processos.length > 0) { pM.processos.forEach(pr => { const d = document.createElement('div'); d.innerHTML = `<label class="checkbox-label"><input type="checkbox" name="processo-producao" value="${pr.id}" data-valor="${pr.valor}">${pr.nome} (${formatarMoeda(pr.valor)})</label>`; if(processosParaProducaoDiv) processosParaProducaoDiv.appendChild(d); }); if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]').forEach(c => c.addEventListener('change', calcularValorTotalProducao)); calcularValorTotalProducao(); } else { if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = '<p class="info-text">Sem processos para este modelo.</p>'; } } else { if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = '<p class="info-text">Selecione Peça/Modelo Base.</p>'; } });
             function calcularValorTotalProducao() { /* ... (Mantida) ... */ let vSP = 0; if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]:checked').forEach(c => { vSP += parseFloat(c.dataset.valor); }); const q = parseInt(prodQuantidadeInput?.value) || 1; const vT = vSP * q; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value = formatarMoeda(vT); return vT; }
             if(prodQuantidadeInput) prodQuantidadeInput.addEventListener('input', calcularValorTotalProducao);
             if(formProducao) formProducao.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id=producaoIdInput.value; const d=prodDataInput.value; const pMID=prodPecaModeloSelect.value; const pMObj=appData.pecasModelos.find(pm=>pm.id==pMID); const nPM=pMObj?pMObj.nome:'(Modelo Base Deletado)'; const cPP=pMObj?pMObj.cobraPorPar:false; const mD=prodModeloDescricaoInput.value.trim(); const cP=prodCorPecaInput.value.trim(); const cID=prodClienteSelect.value; const q=parseInt(prodQuantidadeInput.value); const pg=prodPagoCheckbox.checked; const obs=prodObservacoesTextarea.value.trim(); const mats=prodMateriaisTextarea.value.trim(); let pSel=[]; let vTI=0; if(appData.configuracoes.modoInterface==='simples'){vTI=parseFloat(prodValorManualInput.value)||0;}else{ if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]:checked').forEach(c=>{const pID=c.value; if(pMObj && pMObj.processos){ const pOrig=pMObj.processos.find(p=>p.id==pID); if(pOrig)pSel.push({id:pOrig.id,nome:pOrig.nome,valor:pOrig.valor});}}); vTI=calcularValorTotalProducao();} if(!d||!pMID||isNaN(q)||q<=0){mostrarMensagemGlobal('Preencha data, peça base e quantidade.','erro');return;} const pData={data:d,pecaModeloId:pMID,nomePecaModelo:nPM,cobraPorPar:cPP,modeloDescricao:mD,corPeca:cP,corPecaHTML:validarCorCSS(cP),clienteId:cID,quantidade:q,processos:pSel,valorTotalItem:vTI,pago:pg,observacoes:obs,materiais:mats}; if(id){const idx=appData.producoes.findIndex(p=>p.id==id); if(idx>-1)appData.producoes[idx]={...appData.producoes[idx],...pData};}else{pData.id=Date.now();appData.producoes.push(pData);} salvarDados();renderizarTabelaProducao();renderizarDashboard();limparFormProducao();mostrarMensagemGlobal(`Produção ${id?'atualizada':'adicionada'}!`,'sucesso');});
             function limparFormProducao(){ /* ... (Mantida) ... */ if(formProducao) formProducao.reset(); if(producaoIdInput) producaoIdInput.value=''; if(prodDataInput) prodDataInput.value=hojeFormatado(); if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML='<p class="info-text">Selecione Peça/Modelo Base.</p>'; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value=''; if(prodValorManualInput) prodValorManualInput.value=''; if(btnLimparFormProd) btnLimparFormProd.style.display='none'; if(prodPecaModeloSelect) prodPecaModeloSelect.focus();}
             if(btnLimparFormProd) btnLimparFormProd.addEventListener('click',limparFormProducao);
             function carregarProducaoParaEdicao(id){ /* ... (Mantida) ... */ const p=appData.producoes.find(pr=>pr.id==id); if(p){ if(producaoIdInput) producaoIdInput.value=p.id; if(prodDataInput) prodDataInput.value=p.data; if(prodPecaModeloSelect) prodPecaModeloSelect.value=p.pecaModeloId; const ev=new Event('change'); if(prodPecaModeloSelect) prodPecaModeloSelect.dispatchEvent(ev); setTimeout(()=>{ if(processosParaProducaoDiv) (p.processos||[]).forEach(pS=>{const chk=processosParaProducaoDiv.querySelector(`input[value="${pS.id}"]`); if(chk)chk.checked=true;}); if(appData.configuracoes.modoInterface==='simples'){ if(prodValorManualInput) prodValorManualInput.value=p.valorTotalItem;}else{calcularValorTotalProducao();} },150); if(prodModeloDescricaoInput) prodModeloDescricaoInput.value=p.modeloDescricao; if(prodCorPecaInput) prodCorPecaInput.value=p.corPeca||''; if(prodClienteSelect) prodClienteSelect.value=p.clienteId||''; if(prodQuantidadeInput) prodQuantidadeInput.value=p.quantidade; if(prodMateriaisTextarea) prodMateriaisTextarea.value=p.materiais||''; if(prodPagoCheckbox) prodPagoCheckbox.checked=p.pago; if(prodObservacoesTextarea) prodObservacoesTextarea.value=p.observacoes; if(btnLimparFormProd) btnLimparFormProd.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-producao"]')?.click(); setTimeout(()=>{ if(prodPecaModeloSelect) prodPecaModeloSelect.focus()},100);}}
             function excluirProducao(id){ /* ... (Mantida) ... */ if(confirm('Excluir registro de produção?')){appData.producoes=appData.producoes.filter(p=>p.id!=id);salvarDados();renderizarTabelaProducao();renderizarDashboard();mostrarMensagemGlobal('Produção excluída.','info');}}
             function alternarStatusPagamentoProducao(id){ /* ... (Mantida) ... */ const idx=appData.producoes.findIndex(p=>p.id==id);if(idx>-1){appData.producoes[idx].pago=!appData.producoes[idx].pago;salvarDados();renderizarTabelaProducao();renderizarDashboard();mostrarMensagemGlobal('Status de pagamento atualizado.','sucesso');}}
             function renderizarTabelaProducao(){ /* ... (Mantida) ... */ if(!corpoTabelaProducao) return; corpoTabelaProducao.innerHTML=''; const configFiltro = appData.configuracoes.filtroPeriodoProducao; const sF = filtroStatusPagamento ? filtroStatusPagamento.value : 'todos'; let inicioFiltro = new Date((configFiltro.inicio || primeiroDiaMesAtualFormatado()) + "T00:00:00Z"); let fimFiltro = new Date((configFiltro.fim || hojeFormatado()) + "T23:59:59Z"); const pFil = appData.producoes.filter(p => { const dataProducao = new Date(p.data + "T00:00:00Z"); let dataValida = dataProducao >= inicioFiltro && dataProducao <= fimFiltro; let statusValido = (sF === 'todos') ? true : (sF === 'pago' && p.pago) || (sF === 'pendente' && !p.pago); return dataValida && statusValido; }).sort((a,b) => new Date(b.data) - new Date(a.data) || b.id - a.id); if(pFil.length === 0){ if(semProducaoMsg) semProducaoMsg.textContent='Nenhuma produção encontrada para este período/status.'; if(semProducaoMsg) semProducaoMsg.style.display='block'; if(corpoTabelaProducao.parentElement) corpoTabelaProducao.parentElement.style.display='none'; return; } if(semProducaoMsg) semProducaoMsg.style.display='none'; if(corpoTabelaProducao.parentElement) corpoTabelaProducao.parentElement.style.display='table'; pFil.forEach(p=>{ const tr=document.createElement('tr'); const pN=(p.processos||[]).map(pr=>pr.nome).join(', '); const cliP=appData.clientes.find(c=>c.id==p.clienteId); const nCliP=cliP?cliP.nome:'N/A'; tr.innerHTML=`<td>${formatarData(p.data)}</td><td>${p.nomePecaModelo||'(Base Deletada)'}${p.cobraPorPar?'(Par)':''}${p.corPeca?`<br><small style="font-size:0.85em;">${p.corPecaHTML?`<span class="cor-peca-preview" style="background-color:${p.corPecaHTML};"></span>`:''} ${p.corPeca}</small>`:''}</td><td class="modo-completo-item">${nCliP}</td><td>${p.modeloDescricao || '-'}</td><td>${p.quantidade}</td><td class="modo-completo-item" title="${(p.processos||[]).map(pr=>`${pr.nome}: ${formatarMoeda(pr.valor||0)}`).join('\n')}">${pN.substring(0,25)}${pN.length>25?'...':''}</td><td>${formatarMoeda(p.valorTotalItem)}</td><td><button class="btn btn-pequeno ${p.pago?'btn-sucesso':'btn-aviso'} btn-toggle-pago" data-id="${p.id}">${p.pago?'✔️ Pago':'⌛ Pend.'}</button></td><td><button class="btn btn-pequeno btn-aviso btn-editar-producao" data-id="${p.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-producao" data-id="${p.id}" title="Excluir">🗑️</button><button class="btn btn-pequeno btn-info btn-gerar-comprovante" data-id="${p.id}" title="Gerar Comprovante">🧾</button><button class="btn btn-pequeno btn-whatsapp btn-share-whatsapp" data-id="${p.id}" title="Compartilhar no WhatsApp">💬</button></td>`; corpoTabelaProducao.appendChild(tr); }); corpoTabelaProducao.querySelectorAll('.btn-editar-producao').forEach(b=>b.addEventListener('click',(e)=>carregarProducaoParaEdicao(e.target.dataset.id))); corpoTabelaProducao.querySelectorAll('.btn-excluir-producao').forEach(b=>b.addEventListener('click',(e)=>excluirProducao(e.target.dataset.id))); corpoTabelaProducao.querySelectorAll('.btn-toggle-pago').forEach(b=>b.addEventListener('click',(e)=>alternarStatusPagamentoProducao(e.target.dataset.id))); corpoTabelaProducao.querySelectorAll('.btn-gerar-comprovante').forEach(b => b.addEventListener('click', (e) => gerarComprovanteProducao(e.target.dataset.id))); corpoTabelaProducao.querySelectorAll('.btn-share-whatsapp').forEach(b => b.addEventListener('click', (e) => compartilharProducaoWhatsApp(e.target.dataset.id))); aplicarModoInterface();}
             if(filtroStatusPagamento) filtroStatusPagamento.addEventListener('change',renderizarTabelaProducao); 
             if(formReparo) formReparo.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id = reparoIdInput.value; const dataEntrada = reparoDataEntradaInput.value; const origem = reparoOrigemTextoInput.value.trim(); const descricao = reparoDescricaoTextarea.value.trim(); const valor = parseFloat(reparoValorInput.value) || 0; const status = reparoStatusSelect.value; if (!dataEntrada) { mostrarMensagemGlobal('Data de entrada é obrigatória para o reparo.', 'erro'); return; } const reparoData = { dataEntrada, origem, descricao, valor, status }; if (id) { const index = appData.reparos.findIndex(r => r.id == id); if (index > -1) appData.reparos[index] = { ...appData.reparos[index], ...reparoData }; } else { reparoData.id = Date.now(); appData.reparos.push(reparoData); } salvarDados(); renderizarTabelaReparos(); limparFormReparo(); mostrarMensagemGlobal(`Reparo ${id ? 'atualizado' : 'registrado'}!`, 'sucesso'); });
             function limparFormReparo() { /* ... (Mantida) ... */ if(formReparo) formReparo.reset(); if(reparoIdInput) reparoIdInput.value = ''; if(reparoDataEntradaInput) reparoDataEntradaInput.value = hojeFormatado(); if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.style.display = 'none'; if(reparoDescricaoTextarea) reparoDescricaoTextarea.focus(); }
             if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.addEventListener('click', limparFormReparo);
             function carregarReparoParaEdicao(id) { /* ... (Mantida) ... */ const reparo = appData.reparos.find(r => r.id == id); if (reparo) { if(reparoIdInput) reparoIdInput.value = reparo.id; if(reparoDataEntradaInput) reparoDataEntradaInput.value = reparo.dataEntrada; if(reparoOrigemTextoInput) reparoOrigemTextoInput.value = reparo.origem || ''; if(reparoDescricaoTextarea) reparoDescricaoTextarea.value = reparo.descricao; if(reparoValorInput) reparoValorInput.value = reparo.valor; if(reparoStatusSelect) reparoStatusSelect.value = reparo.status; if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-reparos"]')?.click(); setTimeout(() => {if(reparoDescricaoTextarea) reparoDescricaoTextarea.focus()}, 100); } }
             function excluirReparo(id) { /* ... (Mantida) ... */ if (confirm('Excluir este registro de reparo?')) { appData.reparos = appData.reparos.filter(r => r.id != id); salvarDados(); renderizarTabelaReparos(); mostrarMensagemGlobal('Reparo excluído.', 'info'); } }
             function renderizarTabelaReparos() { /* ... (Mantida) ... */ if(!corpoTabelaReparos) return; corpoTabelaReparos.innerHTML = ''; const reparosOrdenados = [...appData.reparos].sort((a,b) => new Date(b.dataEntrada) - new Date(a.dataEntrada)); if (reparosOrdenados.length === 0) { if(semReparosMsg) semReparosMsg.style.display = 'block'; if(corpoTabelaReparos.parentElement) corpoTabelaReparos.parentElement.style.display = 'none'; return; } if(semReparosMsg) semReparosMsg.style.display = 'none'; if(corpoTabelaReparos.parentElement) corpoTabelaReparos.parentElement.style.display = 'table'; reparosOrdenados.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${formatarData(r.dataEntrada)}</td><td>${r.origem || '-'}</td><td>${r.descricao || '-'}</td><td>${formatarMoeda(r.valor)}</td><td>${r.status}</td><td><button class="btn btn-pequeno btn-aviso btn-editar-reparo" data-id="${r.id}">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-reparo" data-id="${r.id}">🗑️</button></td>`; corpoTabelaReparos.appendChild(tr); }); corpoTabelaReparos.querySelectorAll('.btn-editar-reparo').forEach(btn => btn.addEventListener('click', (e) => carregarReparoParaEdicao(e.target.dataset.id))); corpoTabelaReparos.querySelectorAll('.btn-excluir-reparo').forEach(btn => btn.addEventListener('click', (e) => excluirReparo(e.target.dataset.id))); }
             if(formHoras) formHoras.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const data = horasDataInput.value; const horas = parseFloat(horasQuantidadeInput.value); if (!data || isNaN(horas) || horas <= 0) { mostrarMensagemGlobal('Data e horas válidas são obrigatórias.', 'erro'); return; } const indexExistente = appData.horasTrabalhadas.findIndex(h => h.data === data); if (indexExistente > -1) appData.horasTrabalhadas[indexExistente].horas = horas; else appData.horasTrabalhadas.push({ data, horas }); salvarDados(); renderizarHorasTrabalhadas(); renderizarDashboard(); formHoras.reset(); if(horasDataInput) horasDataInput.value = hojeFormatado(); mostrarMensagemGlobal('Horas registradas!', 'sucesso'); });
             function excluirHoras(data) { /* ... (Mantida) ... */ if (confirm(`Excluir horas de ${formatarData(data)}?`)) { appData.horasTrabalhadas = appData.horasTrabalhadas.filter(h => h.data !== data); salvarDados(); renderizarHorasTrabalhadas(); renderizarDashboard(); mostrarMensagemGlobal('Registro de horas excluído.', 'info'); } }
             function renderizarHorasTrabalhadas() { /* ... (Mantida) ... */ const mesAnoSelecionado = filtroMesHoras?.value || mesAnoAtualFormatado(); if(!listaHorasRegistradasUl) return; listaHorasRegistradasUl.innerHTML = ''; const horasDoMes = appData.horasTrabalhadas.filter(h => h.data.startsWith(mesAnoSelecionado)).sort((a,b) => new Date(a.data) - new Date(b.data)); let totalHoras = 0; if (horasDoMes.length === 0) { if(semHorasMsg) semHorasMsg.style.display = 'block'; } else { if(semHorasMsg) semHorasMsg.style.display = 'none'; horasDoMes.forEach(h => { const li = document.createElement('li'); li.innerHTML = `<span>${formatarData(h.data)}: <strong>${h.horas.toFixed(1).replace('.',',')}h</strong></span><button class="btn btn-pequeno btn-perigo btn-excluir-horas" data-data="${h.data}">🗑️</button>`; listaHorasRegistradasUl.appendChild(li); totalHoras += h.horas; }); listaHorasRegistradasUl.querySelectorAll('.btn-excluir-horas').forEach(btn => { btn.addEventListener('click', (e) => excluirHoras(e.target.dataset.data)); }); } if(totalHorasMesSpan) totalHorasMesSpan.textContent = `${totalHoras.toFixed(1).replace('.',',')}h`; }
             if(filtroMesHoras) filtroMesHoras.addEventListener('change', renderizarHorasTrabalhadas);
             if(formAnotacao) formAnotacao.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id = anotacaoIdInput.value; const titulo = anotacaoTituloInput.value.trim(); const conteudo = anotacaoConteudoTextarea.value.trim(); if (!conteudo && !titulo) { mostrarMensagemGlobal('Título ou conteúdo da anotação é obrigatório.', 'erro'); return; } const anotacao = { titulo, conteudo, dataModificacao: hojeFormatado() }; if (id) { const index = appData.anotacoes.findIndex(a => a.id == id); if (index > -1) appData.anotacoes[index] = { ...appData.anotacoes[index], ...anotacao }; } else { anotacao.id = Date.now(); anotacao.dataCriacao = hojeFormatado(); appData.anotacoes.push(anotacao); } salvarDados(); renderizarAnotacoes(); limparFormAnotacao(); mostrarMensagemGlobal(`Anotação ${id ? 'atualizada' : 'salva'}!`, 'sucesso'); });
             function limparFormAnotacao() { /* ... (Mantida) ... */ if(formAnotacao) formAnotacao.reset(); if(anotacaoIdInput) anotacaoIdInput.value = ''; if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.style.display = 'none'; } 
             if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.addEventListener('click', limparFormAnotacao);
             function carregarAnotacaoParaEdicao(id) { /* ... (Mantida) ... */ const anotacao = appData.anotacoes.find(a => a.id == id); if (anotacao) { if(anotacaoIdInput) anotacaoIdInput.value = anotacao.id; if(anotacaoTituloInput) anotacaoTituloInput.value = anotacao.titulo; if(anotacaoConteudoTextarea) anotacaoConteudoTextarea.value = anotacao.conteudo; if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-configuracoes"]')?.click(); setTimeout(() => {const anCont = document.getElementById('anotacao-conteudo'); if(anCont) anCont.focus();}, 150);}}
             function excluirAnotacao(id) { /* ... (Mantida) ... */ if (confirm('Excluir esta anotação?')) { appData.anotacoes = appData.anotacoes.filter(a => a.id != id); salvarDados(); renderizarAnotacoes(); mostrarMensagemGlobal('Anotação excluída.', 'info'); } }
             function renderizarAnotacoes() { /* ... (Mantida) ... */ if(!listaAnotacoesDiv) return; listaAnotacoesDiv.innerHTML = ''; const anotacoesOrdenadas = [...appData.anotacoes].sort((a,b) => new Date(b.dataModificacao) - new Date(a.dataModificacao) || b.id - a.id); if (anotacoesOrdenadas.length === 0) { if(semAnotacoesMsg) semAnotacoesMsg.style.display = 'block'; return; } if(semAnotacoesMsg) semAnotacoesMsg.style.display = 'none'; anotacoesOrdenadas.forEach(a => { const div = document.createElement('div'); div.className = 'secao'; div.style.marginBottom = '10px'; div.innerHTML = `${a.titulo ? `<h3>${a.titulo}</h3>` : ''}<p style="white-space: pre-wrap;">${a.conteudo}</p><small>Modificado: ${formatarData(a.dataModificacao)}</small><div style="margin-top: 10px;"><button class="btn btn-pequeno btn-aviso btn-editar-anotacao" data-id="${a.id}">✏️ Editar</button><button class="btn btn-pequeno btn-perigo btn-excluir-anotacao" data-id="${a.id}">🗑️ Excluir</button></div>`; listaAnotacoesDiv.appendChild(div); }); listaAnotacoesDiv.querySelectorAll('.btn-editar-anotacao').forEach(btn => btn.addEventListener('click', (e) => carregarAnotacaoParaEdicao(e.target.dataset.id))); listaAnotacoesDiv.querySelectorAll('.btn-excluir-anotacao').forEach(btn => btn.addEventListener('click', (e) => excluirAnotacao(e.target.dataset.id))); }

            // --- CRUD: MÁQUINAS (Mantido) ---
             // ... (Funções CRUD e de Modal mantidas) ...
             if(formMaquina) formMaquina.addEventListener('submit', (e) => { e.preventDefault(); const id = maquinaIdInput.value; const nome = maquinaNomeInput.value.trim(); if (!nome) { mostrarMensagemGlobal('Nome/Apelido da máquina é obrigatório.', 'erro'); return; } const maquinaData = { nome: nome, marca: maquinaMarcaInput.value.trim(), modelo: maquinaModeloInput.value.trim(), tipo: maquinaTipoSelect.value, dataCompra: maquinaDataCompraInput.value, valorCompra: parseFloat(maquinaValorCompraInput.value) || 0, status: maquinaStatusSelect.value, fotoUrl: maquinaFotoUrlInput.value.trim(), notas: maquinaNotasTextarea.value.trim() }; if (id) { const index = appData.maquinas.findIndex(m => m.id == id); if (index > -1) appData.maquinas[index] = { ...appData.maquinas[index], ...maquinaData }; } else { maquinaData.id = Date.now(); appData.maquinas.push(maquinaData); } salvarDados(); renderizarListaMaquinas(); limparFormMaquina(); mostrarMensagemGlobal(`Máquina ${id ? 'atualizada' : 'salva'}!`, 'sucesso'); });
             function limparFormMaquina() { if(formMaquina) formMaquina.reset(); if(maquinaIdInput) maquinaIdInput.value = ''; if(btnCancelarEdicaoMaquina) btnCancelarEdicaoMaquina.style.display = 'none'; if(maquinaNomeInput) maquinaNomeInput.focus(); }
             if(btnCancelarEdicaoMaquina) btnCancelarEdicaoMaquina.addEventListener('click', limparFormMaquina);
             function carregarMaquinaParaEdicao(id) { const maq = appData.maquinas.find(m => m.id == id); if (maq) { if(maquinaIdInput) maquinaIdInput.value = maq.id; if(maquinaNomeInput) maquinaNomeInput.value = maq.nome; if(maquinaMarcaInput) maquinaMarcaInput.value = maq.marca || ''; if(maquinaModeloInput) maquinaModeloInput.value = maq.modelo || ''; if(maquinaTipoSelect) maquinaTipoSelect.value = maq.tipo || ''; if(maquinaDataCompraInput) maquinaDataCompraInput.value = maq.dataCompra || ''; if(maquinaValorCompraInput) maquinaValorCompraInput.value = maq.valorCompra || ''; if(maquinaStatusSelect) maquinaStatusSelect.value = maq.status || 'Ativa'; if(maquinaFotoUrlInput) maquinaFotoUrlInput.value = maq.fotoUrl || ''; if(maquinaNotasTextarea) maquinaNotasTextarea.value = maq.notas || ''; if(btnCancelarEdicaoMaquina) btnCancelarEdicaoMaquina.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-maquinas"]')?.click(); setTimeout(() => { if(maquinaNomeInput) maquinaNomeInput.focus() }, 100); } }
             function excluirMaquina(id) { if (confirm('Excluir esta máquina e todo o seu histórico de manutenção/reparos? Isso não pode ser desfeito.')) { appData.maquinas = appData.maquinas.filter(m => m.id != id); appData.manutencoes = appData.manutencoes.filter(m => m.maquinaId != id); appData.reparosMaquinas = appData.reparosMaquinas.filter(r => r.maquinaId != id); salvarDados(); renderizarListaMaquinas(); mostrarMensagemGlobal('Máquina e seu histórico excluídos.', 'info'); } }
             function renderizarListaMaquinas() { if (!corpoTabelaMaquinas) return; corpoTabelaMaquinas.innerHTML = ''; const maquinasOrdenadas = [...appData.maquinas].sort((a, b) => a.nome.localeCompare(b.nome)); if (maquinasOrdenadas.length === 0) { if(semMaquinasMsg) semMaquinasMsg.style.display = 'block'; if(corpoTabelaMaquinas.parentElement) corpoTabelaMaquinas.parentElement.style.display = 'none'; return; } if(semMaquinasMsg) semMaquinasMsg.style.display = 'none'; if(corpoTabelaMaquinas.parentElement) corpoTabelaMaquinas.parentElement.style.display = 'table'; maquinasOrdenadas.forEach(m => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${m.nome}</td> <td>${m.tipo || '-'}</td> <td>${m.marca || '-'}${m.modelo ? ` / ${m.modelo}` : ''}</td> <td style="text-align: center;">${m.status || 'Ativa'}</td> <td style="text-align: center;"> <button class="btn btn-pequeno btn-info btn-ver-maquina" data-id="${m.id}" title="Ver Detalhes/Histórico">👁️</button> <button class="btn btn-pequeno btn-aviso btn-editar-maquina" data-id="${m.id}" title="Editar Máquina">✏️</button> <button class="btn btn-pequeno btn-perigo btn-excluir-maquina" data-id="${m.id}" title="Excluir Máquina">🗑️</button></td>`; corpoTabelaMaquinas.appendChild(tr); }); corpoTabelaMaquinas.querySelectorAll('.btn-editar-maquina').forEach(btn => btn.addEventListener('click', (e) => carregarMaquinaParaEdicao(e.target.dataset.id))); corpoTabelaMaquinas.querySelectorAll('.btn-excluir-maquina').forEach(btn => btn.addEventListener('click', (e) => excluirMaquina(e.target.dataset.id))); corpoTabelaMaquinas.querySelectorAll('.btn-ver-maquina').forEach(btn => btn.addEventListener('click', (e) => mostrarDetalhesMaquina(e.target.dataset.id))); }

             // --- CRUD: Manutenção/Reparos de Máquinas (Mantido) ---
              function mostrarDetalhesMaquina(maquinaId) { /* ... (Mantida) ... */ currentMachineIdForModal = maquinaId; const maq = appData.maquinas.find(m => m.id == maquinaId); if (!maq || !modalDetalhesMaquina) return; if(modalDetalhesMaquinaTitulo) modalDetalhesMaquinaTitulo.textContent = `Detalhes: ${maq.nome}`; if(modalDetalhesMaquinaInfo) { modalDetalhesMaquinaInfo.innerHTML = `<p><strong>Tipo:</strong> ${maq.tipo || '-'}</p> <p><strong>Marca:</strong> ${maq.marca || '-'}</p> <p><strong>Modelo:</strong> ${maq.modelo || '-'}</p> <p><strong>Data Compra:</strong> ${maq.dataCompra ? formatarData(maq.dataCompra) : '-'}</p> <p><strong>Valor Compra:</strong> ${formatarMoeda(maq.valorCompra)}</p> <p><strong>Status:</strong> ${maq.status || '-'}</p> ${maq.fotoUrl ? `<p><strong>Foto:</strong> <a href="${maq.fotoUrl}" target="_blank">Ver Foto</a></p>` : ''} ${maq.notas ? `<p><strong>Notas:</strong> ${maq.notas}</p>` : ''} `; } renderizarHistoricoManutencao(maquinaId); renderizarHistoricoReparosMaquina(maquinaId); modalDetalhesMaquina.style.display = 'block'; }
              function renderizarHistoricoManutencao(maquinaId) { /* ... (Mantida) ... */ if (!corpoTabelaHistoricoManutencao) return; corpoTabelaHistoricoManutencao.innerHTML = ''; const historico = appData.manutencoes.filter(m => m.maquinaId == maquinaId).sort((a, b) => new Date(b.data) - new Date(a.data)); if (historico.length === 0) { if(semManutencoesMsg) semManutencoesMsg.style.display = 'block'; return; } if(semManutencoesMsg) semManutencoesMsg.style.display = 'none'; historico.forEach(m => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${formatarData(m.data)}</td> <td>${m.tipo}</td> <td>${formatarMoeda(m.custo)}</td> <td>${m.realizadoPor || '-'}</td> <td>${m.proximaData ? formatarData(m.proximaData) : '-'}</td> <td><button class="btn btn-pequeno btn-perigo btn-excluir-manutencao" data-id="${m.id}">🗑️</button></td>`; corpoTabelaHistoricoManutencao.appendChild(tr); }); corpoTabelaHistoricoManutencao.querySelectorAll('.btn-excluir-manutencao').forEach(btn => btn.addEventListener('click', (e) => excluirManutencao(e.target.dataset.id))); }
              function renderizarHistoricoReparosMaquina(maquinaId) { /* ... (Mantida) ... */ if (!corpoTabelaHistoricoReparosMaq) return; corpoTabelaHistoricoReparosMaq.innerHTML = ''; const historico = appData.reparosMaquinas.filter(r => r.maquinaId == maquinaId).sort((a, b) => new Date(b.data) - new Date(a.data)); if (historico.length === 0) { if(semReparosMaqMsg) semReparosMaqMsg.style.display = 'block'; return; } if(semReparosMaqMsg) semReparosMaqMsg.style.display = 'none'; historico.forEach(r => { const custoTotal = (r.custoPecas || 0) + (r.custoMO || 0); const tr = document.createElement('tr'); tr.innerHTML = `<td>${formatarData(r.data)}</td> <td>${r.problema}</td> <td>${r.pecas || '-'}</td> <td>${formatarMoeda(custoTotal)}</td> <td>${r.realizadoPor || '-'}</td> <td><button class="btn btn-pequeno btn-perigo btn-excluir-reparo-maq" data-id="${r.id}">🗑️</button></td>`; corpoTabelaHistoricoReparosMaq.appendChild(tr); }); corpoTabelaHistoricoReparosMaq.querySelectorAll('.btn-excluir-reparo-maq').forEach(btn => btn.addEventListener('click', (e) => excluirReparoMaquina(e.target.dataset.id))); }
              function abrirModalFormManutReparo(tipo, idParaEditar = null) { /* ... (Mantida) ... */ if (!modalFormManutReparo || !currentMachineIdForModal) return; if(formManutencaoMaquina) formManutencaoMaquina.reset(); if(formReparoMaquina) formReparoMaquina.reset(); if(manutencaoIdInput) manutencaoIdInput.value = ''; if(reparoMaquinaIdInput) reparoMaquinaIdInput.value = ''; if(manutencaoDataInput) manutencaoDataInput.value = hojeFormatado(); if(reparoMaquinaDataInput) reparoMaquinaDataInput.value = hojeFormatado(); if (tipo === 'manutencao') { if(modalFormManutReparoTitulo) modalFormManutReparoTitulo.textContent = "Registrar Manutenção Preventiva"; if(manutencaoMaquinaIdInput) manutencaoMaquinaIdInput.value = currentMachineIdForModal; if(formManutencaoMaquina) formManutencaoMaquina.style.display = 'block'; if(formReparoMaquina) formReparoMaquina.style.display = 'none'; } else if (tipo === 'reparo') { if(modalFormManutReparoTitulo) modalFormManutReparoTitulo.textContent = "Registrar Reparo Corretivo"; if(reparoMaquinaMaquinaIdInput) reparoMaquinaMaquinaIdInput.value = currentMachineIdForModal; if(formManutencaoMaquina) formManutencaoMaquina.style.display = 'none'; if(formReparoMaquina) formReparoMaquina.style.display = 'block'; } modalFormManutReparo.style.display = 'block'; }
              if(formManutencaoMaquina) formManutencaoMaquina.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const manutData = { id: parseInt(manutencaoIdInput.value) || Date.now(), maquinaId: parseInt(manutencaoMaquinaIdInput.value), data: manutencaoDataInput.value, tipo: manutencaoTipoInput.value.trim(), custo: parseFloat(manutencaoCustoInput.value) || 0, proximaData: manutencaoProximaDataInput.value || null, realizadoPor: manutencaoRealizadoInput.value.trim(), notas: manutencaoNotasTextarea.value.trim() }; if (!manutData.data || !manutData.tipo || !manutData.maquinaId) { mostrarMensagemGlobal("Data, Tipo e ID da Máquina são obrigatórios.", "erro"); return; } const index = appData.manutencoes.findIndex(m => m.id === manutData.id); if (index > -1) appData.manutencoes[index] = manutData; else appData.manutencoes.push(manutData); salvarDados(); renderizarHistoricoManutencao(manutData.maquinaId); modalFormManutReparo.style.display = 'none'; mostrarMensagemGlobal("Manutenção salva!", "sucesso"); });
              if(formReparoMaquina) formReparoMaquina.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const reparoData = { id: parseInt(reparoMaquinaIdInput.value) || Date.now(), maquinaId: parseInt(reparoMaquinaMaquinaIdInput.value), data: reparoMaquinaDataInput.value, problema: reparoMaquinaProblemaTextarea.value.trim(), pecas: reparoMaquinaPecasInput.value.trim(), custoPecas: parseFloat(reparoMaquinaCustoPecasInput.value) || 0, custoMO: parseFloat(reparoMaquinaCustoMoInput.value) || 0, realizadoPor: reparoMaquinaRealizadoInput.value.trim(), notas: reparoMaquinaNotasTextarea.value.trim() }; if (!reparoData.data || !reparoData.problema || !reparoData.maquinaId) { mostrarMensagemGlobal("Data, Problema e ID da Máquina são obrigatórios.", "erro"); return; } const index = appData.reparosMaquinas.findIndex(r => r.id === reparoData.id); if (index > -1) appData.reparosMaquinas[index] = reparoData; else appData.reparosMaquinas.push(reparoData); salvarDados(); renderizarHistoricoReparosMaquina(reparoData.maquinaId); modalFormManutReparo.style.display = 'none'; mostrarMensagemGlobal("Reparo salvo!", "sucesso"); });
             function excluirManutencao(id) { /* ... (Mantida) ... */ if (confirm('Excluir este registro de manutenção?')) { const manut = appData.manutencoes.find(m=>m.id==id); appData.manutencoes = appData.manutencoes.filter(m => m.id != id); salvarDados(); if(manut) renderizarHistoricoManutencao(manut.maquinaId); mostrarMensagemGlobal('Manutenção excluída.', 'info'); }}
             function excluirReparoMaquina(id) { /* ... (Mantida) ... */ if (confirm('Excluir este registro de reparo?')) { const rep = appData.reparosMaquinas.find(r=>r.id==id); appData.reparosMaquinas = appData.reparosMaquinas.filter(r => r.id != id); salvarDados(); if(rep) renderizarHistoricoReparosMaquina(rep.maquinaId); mostrarMensagemGlobal('Reparo excluído.', 'info'); }}

             // --- CRUD: DESPESAS (Mantido) ---
             // ... (Funções CRUD Despesas mantidas) ...
             const categoriasDespesas = [ "Materiais/Insumos", "Contas Fixas", "Contas Variáveis", "Manutenção de Máquinas", "Marketing/Publicidade", "Impostos/Taxas", "Serviços de Terceiros", "Transporte/Entregas", "Despesas Bancárias", "Pró-labore/Salário", "Outros" ]; function popularCategoriasDespesa() { if (!despesaCategoriaSelect) return; despesaCategoriaSelect.innerHTML = '<option value="">Selecione...</option>'; categoriasDespesas.forEach(cat => { despesaCategoriaSelect.innerHTML += `<option value="${cat}">${cat}</option>`; }); } function popularCategoriasDespesaFiltro() { if (!filtroCategoriaDespesaSelect) return; const valorAtual = filtroCategoriaDespesaSelect.value; filtroCategoriaDespesaSelect.innerHTML = '<option value="todas">Todas</option>'; categoriasDespesas.forEach(cat => { filtroCategoriaDespesaSelect.innerHTML += `<option value="${cat}">${cat}</option>`; }); filtroCategoriaDespesaSelect.value = valorAtual; }
             if(formDespesa) formDespesa.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id = despesaIdInput.value; const data = despesaDataInput.value; const valor = parseFloat(despesaValorInput.value); const descricao = despesaDescricaoInput.value.trim(); const categoria = despesaCategoriaSelect.value; if (!data || isNaN(valor) || valor <= 0 || !descricao || !categoria) { mostrarMensagemGlobal('Preencha Data, Valor, Descrição e Categoria.', 'erro'); return; } const despesaData = { data, valor, descricao, categoria, notas: despesaNotasTextarea.value.trim() }; if (id) { const index = appData.despesas.findIndex(d => d.id == id); if (index > -1) appData.despesas[index] = { ...appData.despesas[index], ...despesaData }; } else { despesaData.id = Date.now(); appData.despesas.push(despesaData); } salvarDados(); renderizarTabelaDespesas(); renderizarDashboard(); limparFormDespesa(); mostrarMensagemGlobal(`Despesa ${id ? 'atualizada' : 'salva'}!`, 'sucesso'); });
             function limparFormDespesa() { /* ... (Mantida) ... */ if(formDespesa) formDespesa.reset(); if(despesaIdInput) despesaIdInput.value = ''; if(despesaDataInput) despesaDataInput.value = hojeFormatado(); if(btnCancelarEdicaoDespesa) btnCancelarEdicaoDespesa.style.display = 'none'; if(despesaDescricaoInput) despesaDescricaoInput.focus(); }
             if(btnCancelarEdicaoDespesa) btnCancelarEdicaoDespesa.addEventListener('click', limparFormDespesa);
             function carregarDespesaParaEdicao(id) { /* ... (Mantida) ... */ const desp = appData.despesas.find(d => d.id == id); if (desp) { if(despesaIdInput) despesaIdInput.value = desp.id; if(despesaDataInput) despesaDataInput.value = desp.data; if(despesaValorInput) despesaValorInput.value = desp.valor; if(despesaDescricaoInput) despesaDescricaoInput.value = desp.descricao; if(despesaCategoriaSelect) despesaCategoriaSelect.value = desp.categoria; if(despesaNotasTextarea) despesaNotasTextarea.value = desp.notas || ''; if(btnCancelarEdicaoDespesa) btnCancelarEdicaoDespesa.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-despesas"]')?.click(); setTimeout(() => {if(despesaDescricaoInput) despesaDescricaoInput.focus()}, 100); } }
             function excluirDespesa(id) { /* ... (Mantida) ... */ if (confirm('Excluir esta despesa?')) { appData.despesas = appData.despesas.filter(d => d.id != id); salvarDados(); renderizarTabelaDespesas(); renderizarDashboard(); mostrarMensagemGlobal('Despesa excluída.', 'info'); } }
             function renderizarTabelaDespesas() { /* ... (Adaptada) ... */ if (!corpoTabelaDespesas) return; corpoTabelaDespesas.innerHTML = ''; const configFiltro = appData.configuracoes.filtroPeriodoDespesas; const catFiltro = filtroCategoriaDespesaSelect ? filtroCategoriaDespesaSelect.value : 'todas'; let inicioFiltro = new Date((configFiltro.inicio || primeiroDiaMesAtualFormatado()) + "T00:00:00Z"); let fimFiltro = new Date((configFiltro.fim || hojeFormatado()) + "T23:59:59Z"); let totalDespesas = 0; const dFil = appData.despesas.filter(d => { const dataDespesa = new Date(d.data + "T00:00:00Z"); let dataValida = dataDespesa >= inicioFiltro && dataDespesa <= fimFiltro; let categoriaValida = (catFiltro === 'todas') ? true : d.categoria === catFiltro; return dataValida && categoriaValida; }).sort((a, b) => new Date(b.data) - new Date(a.data) || b.id - a.id); if (dFil.length === 0) { /* ... (Resto mantido) ... */ if(semDespesasMsg) semDespesasMsg.style.display = 'block'; if(corpoTabelaDespesas.parentElement) corpoTabelaDespesas.parentElement.style.display = 'none'; if(totalDespesasPeriodoEl) totalDespesasPeriodoEl.textContent = "Total Despesas (Período): R$ 0,00"; return; } if(semDespesasMsg) semDespesasMsg.style.display = 'none'; if(corpoTabelaDespesas.parentElement) corpoTabelaDespesas.parentElement.style.display = 'table'; dFil.forEach(d => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${formatarData(d.data)}</td> <td>${d.descricao}</td> <td>${d.categoria}</td> <td style="text-align: right;">${formatarMoeda(d.valor)}</td> <td style="text-align: center;"> <button class="btn btn-pequeno btn-aviso btn-editar-despesa" data-id="${d.id}">✏️</button> <button class="btn btn-pequeno btn-perigo btn-excluir-despesa" data-id="${d.id}">🗑️</button> </td>`; corpoTabelaDespesas.appendChild(tr); totalDespesas += d.valor; }); if(totalDespesasPeriodoEl) totalDespesasPeriodoEl.textContent = `Total Despesas (Período): ${formatarMoeda(totalDespesas)}`; corpoTabelaDespesas.querySelectorAll('.btn-editar-despesa').forEach(btn => btn.addEventListener('click', (e) => carregarDespesaParaEdicao(e.target.dataset.id))); corpoTabelaDespesas.querySelectorAll('.btn-excluir-despesa').forEach(btn => btn.addEventListener('click', (e) => excluirDespesa(e.target.dataset.id))); }
             if(filtroCategoriaDespesaSelect) filtroCategoriaDespesaSelect.addEventListener('change', renderizarTabelaDespesas);


            // --- IMPORT/EXPORT (Mantido) ---
             if(btnExportarDados) btnExportarDados.addEventListener('click', () => { /* ... (Mantida) ... */ const dJ = JSON.stringify(appData, null, 2); const b = new Blob([dJ],{type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); const nA = `backup_atelie_${(appData.configuracoes.nomeAtelie||'atelie').replace(/\s+/g,'_')}_${hojeFormatado()}.json`; a.href=u; a.download=nA; document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);mostrarMensagemGlobal('Dados exportados!','sucesso');});
             if(inputImportarDados) inputImportarDados.addEventListener('change', (event) => { /* ... (Adaptada para novas estruturas) ... */ const f = event.target.files[0]; if (f) { if (!confirm("ATENÇÃO: Importar substituirá TODOS os dados atuais. Continuar?")) { inputImportarDados.value = ''; return; } const r = new FileReader(); r.onload = (e) => { try { const dI = JSON.parse(e.target.result); if (dI.configuracoes && Array.isArray(dI.pecasModelos) && Array.isArray(dI.producoes) && Array.isArray(dI.maquinas) && Array.isArray(dI.despesas) && Array.isArray(dI.manutencoes) && Array.isArray(dI.reparosMaquinas) ) { const defConf = { /* ... (defaultConfig mantido) ... */ nomeAtelie: "Meu Ateliê", nomeCostureira: "Costureira", temaPredefinido: "theme-classic-rose", temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' }, modoInterface: "completo", navBarStyle: "scroll", filtroPeriodoDashboard: { inicio: primeiroDiaMesAtualFormatado(), fim: hojeFormatado(), expandido: false }, filtroPeriodoProducao: { inicio: primeiroDiaMesAtualFormatado(), fim: hojeFormatado(), expandido: false }, filtroPeriodoDespesas: { inicio: primeiroDiaMesAtualFormatado(), fim: hojeFormatado(), expandido: false } }; const mConf = { ...defConf, ...(dI.configuracoes || {}), filtroPeriodoDashboard: { ...defConf.filtroPeriodoDashboard, ...((dI.configuracoes || {}).filtroPeriodoDashboard || {}) }, filtroPeriodoProducao: { ...defConf.filtroPeriodoProducao, ...((dI.configuracoes || {}).filtroPeriodoProducao || {}) }, filtroPeriodoDespesas: { ...defConf.filtroPeriodoDespesas, ...((dI.configuracoes || {}).filtroPeriodoDespesas || {}) } }; mConf.temaPersonalizado = { ...defConf.temaPersonalizado, ...((dI.configuracoes || {}).temaPersonalizado || {}) }; const defaultAppData = { configuracoes: mConf, pecasModelos: [], producoes: [], clientes: [], contatosUteis: [], maquinas: [], manutencoes: [], reparosMaquinas: [], despesas: [], reparos: [], horasTrabalhadas: [], anotacoes: [] }; appData = { ...defaultAppData, ...dI }; Object.keys(defaultAppData).forEach(key => { if (Array.isArray(defaultAppData[key]) && !Array.isArray(appData[key])) { appData[key] = []; } }); salvarDados(); aplicarTema(); aplicarEstiloNavegacao(); preencherFormConfiguracoesNomes(); preencherFormConfigTema(); preencherSeletorModoInterface(); configurarFiltroPeriodo('dashboard', appData.configuracoes.filtroPeriodoDashboard, camposFiltroPeriodoDashboard, btnToggleFiltroPeriodoDashboard, filtroDataInicioDashboard, filtroDataFimDashboard, btnAplicarFiltroPeriodoDashboard, btnResetarFiltroPeriodoDashboard, btnMesAtualDashboard, periodoAtualDashboardEl, renderizarDashboard); configurarFiltroPeriodo('producao', appData.configuracoes.filtroPeriodoProducao, camposFiltroPeriodoProducao, btnToggleFiltroPeriodoProducao, filtroDataInicioProducao, filtroDataFimProducao, btnAplicarFiltroPeriodoProducao, btnResetarFiltroPeriodoProducao, btnMesAtualProducao, periodoAtualProducaoEl, renderizarTabelaProducao); configurarFiltroPeriodo('despesas', appData.configuracoes.filtroPeriodoDespesas, camposFiltroPeriodoDespesas, btnToggleFiltroPeriodoDespesas, filtroDataInicioDespesas, filtroDataFimDespesas, btnAplicarFiltroPeriodoDespesas, btnResetarFiltroPeriodoDespesas, btnMesAtualDespesas, periodoAtualDespesasEl, renderizarTabelaDespesas); inicializarTodasAsRenderizacoes(); mostrarMensagemGlobal('Dados importados! App recarregado.', 'sucesso'); } else { throw new Error("Arquivo JSON inválido ou faltando arrays essenciais (maquinas, despesas, manutencoes, reparosMaquinas)."); } } catch (err) { console.error("Erro ao importar:", err); mostrarMensagemGlobal(`Erro ao importar: ${err.message}`, 'erro'); } finally { inputImportarDados.value = ''; } }; r.readAsText(f); } });
            
            // --- DASHBOARD E GRÁFICOS (Adaptado) ---
             function getPeriodoAtivoDashboard() { /* ... (Mantida) ... */ const configFiltro = appData.configuracoes.filtroPeriodoDashboard; const inicio = configFiltro.inicio || primeiroDiaMesAtualFormatado(); const fim = configFiltro.fim || hojeFormatado(); return { inicio: inicio, fim: fim }; }
             function renderizarGraficoGanhosMensais() { /* ... (Mantida) ... */ if (!graficoGanhosMensaisDiv || appData.configuracoes.modoInterface === 'simples') { if (graficoGanhosMensaisDiv) graficoGanhosMensaisDiv.innerHTML = ''; return; } graficoGanhosMensaisDiv.innerHTML = ''; const periodoDashboard = getPeriodoAtivoDashboard(); const dataFimPeriodo = new Date(periodoDashboard.fim + "T23:59:59Z"); let ganhosPorMes = {}; for (let i = 5; i >= 0; i--) { const dBase = new Date(dataFimPeriodo.getUTCFullYear(), dataFimPeriodo.getUTCMonth() - i, 1); const mesAno = dBase.toISOString().slice(0, 7); ganhosPorMes[mesAno] = { nome: dBase.toLocaleDateString('pt-BR', {month:'short', timeZone: 'UTC'}), total: 0 }; } appData.producoes.forEach(p => { const dataProducao = new Date(p.data + "T00:00:00Z"); const inicioPeriodoDate = new Date(periodoDashboard.inicio + "T00:00:00Z"); if (dataProducao >= inicioPeriodoDate && dataProducao <= dataFimPeriodo) { const mesAnoProd = p.data.slice(0, 7); if (ganhosPorMes[mesAnoProd]) { ganhosPorMes[mesAnoProd].total += p.valorTotalItem; } } }); const valores = Object.values(ganhosPorMes).map(m => m.total); const maxValor = Math.max(...valores, 1); Object.values(ganhosPorMes).forEach(mes => { const alturaPercent = (mes.total / maxValor) * 100; const barra = document.createElement('div'); barra.className = 'barra'; barra.style.height = `${alturaPercent}%`; barra.innerHTML = `<span>${mes.nome}<br>${formatarMoeda(mes.total)}</span>`; graficoGanhosMensaisDiv.appendChild(barra); }); }
             function renderizarTopPecas() { /* ... (Mantida) ... */ if(!listaTopPecasUl || appData.configuracoes.modoInterface === 'simples') { if(listaTopPecasUl) listaTopPecasUl.innerHTML = ''; return; } listaTopPecasUl.innerHTML = ''; const periodoDashboard = getPeriodoAtivoDashboard(); const contagemPecas = {}; appData.producoes.filter(p => { const dataProducao = new Date(p.data + "T00:00:00Z"); return dataProducao >= new Date(periodoDashboard.inicio + "T00:00:00Z") && dataProducao <= new Date(periodoDashboard.fim + "T23:59:59Z"); }).forEach(p => { const nomePeca = p.nomePecaModelo || "Desconhecida"; contagemPecas[nomePeca] = (contagemPecas[nomePeca] || 0) + p.quantidade; }); const topArray = Object.entries(contagemPecas).sort(([,a],[,b]) => b-a).slice(0, 5); if(topArray.length === 0) { listaTopPecasUl.innerHTML = '<li>Nenhuma peça produzida no período.</li>'; return; } topArray.forEach(([nome, qtd]) => { const li = document.createElement('li'); li.textContent = `${nome}: ${qtd} unid.`; listaTopPecasUl.appendChild(li); }); }
             function renderizarDashboard() { /* ... (Adaptada para Despesas/Lucro) ... */ const hj = hojeFormatado(); const periodo = getPeriodoAtivoDashboard(); let dataInicioFiltro = new Date(periodo.inicio + "T00:00:00Z"); let dataFimFiltro = new Date(periodo.fim + "T23:59:59Z"); let gD = 0, gP = 0, tRP = 0, tPP = 0, pPP = 0, hTP = 0, totalDespesasP = 0; appData.producoes.forEach(p => { const dataProducao = new Date(p.data + "T00:00:00Z"); if (p.data === hj) gD += p.valorTotalItem; if (dataProducao >= dataInicioFiltro && dataProducao <= dataFimFiltro) { gP += p.valorTotalItem; pPP += p.quantidade; if (p.pago) tRP += p.valorTotalItem; else tPP += p.valorTotalItem; } }); appData.despesas.forEach(d => { const dataDespesa = new Date(d.data + "T00:00:00Z"); if (dataDespesa >= dataInicioFiltro && dataDespesa <= dataFimFiltro) { totalDespesasP += d.valor; } }); appData.horasTrabalhadas.forEach(h => { const dataHora = new Date(h.data + "T00:00:00Z"); if (dataHora >= dataInicioFiltro && dataHora <= dataFimFiltro) { hTP += h.horas; } }); const lucroLiquidoP = gP - totalDespesasP; if(dashValorCard1) dashValorCard1.textContent = formatarMoeda(gD); if(dashValorCard2) dashValorCard2.textContent = formatarMoeda(gP); if(dashValorCardDespesas) dashValorCardDespesas.textContent = formatarMoeda(totalDespesasP); if(dashValorCardLucro) dashValorCardLucro.textContent = formatarMoeda(lucroLiquidoP); if(dashValorCard3) dashValorCard3.textContent = formatarMoeda(tRP); if(dashValorCard4) dashValorCard4.textContent = formatarMoeda(tPP); if(dashValorCard5) dashValorCard5.textContent = pPP; if(dashValorCard6) dashValorCard6.textContent = `${hTP.toFixed(1).replace('.',',')}h`; if (appData.configuracoes.modoInterface === 'completo') { renderizarGraficoGanhosMensais(); renderizarTopPecas(); } else { if (graficoGanhosMensaisDiv) graficoGanhosMensaisDiv.innerHTML = ''; if (listaTopPecasUl) listaTopPecasUl.innerHTML = '<li>Gráficos disponíveis no Modo Completo.</li>'; } }

            // --- GERAR COMPROVANTE E RELATÓRIO (Mantido) ---
            // ... (Funções gerarComprovanteProducao, compartilharProducaoWhatsApp, gerarRelatorioProducaoPeriodo, popularSelectClientesRelatorio mantidas) ...
              function gerarComprovanteProducao(producaoId) { /* ... (Mantida) ... */ const p = appData.producoes.find(item => item.id == producaoId); if (!p) { mostrarMensagemGlobal("Produção não encontrada.", "erro"); return; } const cliente = p.clienteId ? appData.clientes.find(c => c.id == p.clienteId) : null; const pecaBase = appData.pecasModelos.find(pm => pm.id == p.pecaModeloId); let html = `<div id="comprovante-para-impressao">`; html += `<h1>Comprovante de Produção</h1>`; html += `<p style="text-align:center; margin-bottom:20px;"><strong>${appData.configuracoes.nomeAtelie}</strong></p>`; html += `<h2>Detalhes da Produção</h2>`; html += `<p><strong>Data:</strong> ${formatarData(p.data)}</p>`; if (cliente) html += `<p><strong>Cliente:</strong> ${cliente.nome}</p>`; html += `<p><strong>Peça Base:</strong> ${p.nomePecaModelo || (pecaBase ? pecaBase.nome : '(Não informado)')}</p>`; html += `<p><strong>Descrição Detalhada:</strong> ${p.modeloDescricao || '(Não informado)'}</p>`; if (p.corPeca) html += `<p><strong>Cor:</strong> ${p.corPeca}</p>`; html += `<p><strong>Quantidade:</strong> ${p.quantidade}</p>`; if (appData.configuracoes.modoInterface === 'completo' && p.processos && p.processos.length > 0) { html += `<h3>Processos Realizados e Custos</h3><ul>`; p.processos.forEach(proc => { html += `<li>${proc.nome || '(Processo sem nome)'}: ${formatarMoeda(proc.valor || 0)}</li>`; }); html += `</ul>`; } if (appData.configuracoes.modoInterface === 'completo' && p.materiais) { html += `<h3>Materiais Utilizados</h3><p>${p.materiais.replace(/\n/g, '<br>')}</p>`;} html += `<hr>`; if(p.quantidade > 0 && p.valorTotalItem !== 0 ) { html += `<p><strong>Valor Unitário Estimado: ${formatarMoeda(p.valorTotalItem / p.quantidade)}</strong> (x${p.quantidade})</p>`; } html += `<h2 style="margin-top:10px;">Valor Total: ${formatarMoeda(p.valorTotalItem)}</h2>`; html += `<p><strong>Status Pagamento:</strong> ${p.pago ? 'Pago' : 'Pendente'}</p>`; if (p.observacoes) html += `<p><strong>Observações:</strong> ${p.observacoes.replace(/\n/g, '<br>')}</p>`; html += `<hr><p id="rodape-comprovante">Gerado por: ${appData.configuracoes.nomeAtelie || 'Gestor de Ateliê Pro'}</p>`; html += `</div>`; if(comprovanteContainerHidden) comprovanteContainerHidden.innerHTML = html; requestAnimationFrame(() => { requestAnimationFrame(() => { window.print(); }); }); }
              function compartilharProducaoWhatsApp(producaoId) { /* ... (Mantida) ... */ const p = appData.producoes.find(item => item.id == producaoId); if (!p) { mostrarMensagemGlobal("Produção não encontrada.", "erro"); return; } const cliente = p.clienteId ? appData.clientes.find(c => c.id == p.clienteId) : null; let msg = `*Resumo da Produção - ${appData.configuracoes.nomeAtelie}*\n\n`; msg += `Data: ${formatarData(p.data)}\n`; if (cliente) msg += `Cliente: ${cliente.nome}\n`; msg += `Peça: ${p.nomePecaModelo} - ${p.modeloDescricao || '(Sem descrição detalhada)'}\n`; if (p.corPeca) msg += `Cor: ${p.corPeca}\n`; msg += `Quantidade: ${p.quantidade}\n`; msg += `*Valor Total: ${formatarMoeda(p.valorTotalItem)}*\n`; msg += `Status: ${p.pago ? 'Pago' : 'Pendente'}\n`; if (p.observacoes) msg += `\nObservações: ${p.observacoes}\n`; const encodedMsg = encodeURIComponent(msg); let whatsappLink = `https://api.whatsapp.com/send?text=${encodedMsg}`; if (cliente && cliente.telefone) { whatsappLink = `https://api.whatsapp.com/send?phone=55${cliente.telefone.replace(/\D/g,'')}&text=${encodedMsg}`; } window.open(whatsappLink, '_blank'); }
              function gerarRelatorioProducaoPeriodo() { /* ... (Mantida) ... */ const configFiltroProducao = appData.configuracoes.filtroPeriodoProducao; let dataInicioStr = configFiltroProducao.inicio; let dataFimStr = configFiltroProducao.fim; const clienteIdSelecionado = filtroRelatorioCliente ? filtroRelatorioCliente.value : ''; const dataInicio = new Date(dataInicioStr + "T00:00:00Z"); const dataFim = new Date(dataFimStr + "T23:59:59Z"); if (dataInicio > dataFim) { mostrarMensagemGlobal("A Data Início não pode ser posterior à Data Fim.", "erro"); return; } let producoesFiltradas = appData.producoes.filter(p => { const dataProducao = new Date(p.data + "T00:00:00Z"); let atendeData = dataProducao >= dataInicio && dataProducao <= dataFim; let atendeCliente = true; if (clienteIdSelecionado) { atendeCliente = p.clienteId == clienteIdSelecionado; } return atendeData && atendeCliente; }); if (producoesFiltradas.length === 0) { mostrarMensagemGlobal("Nenhuma produção encontrada para o período e cliente selecionados.", "info"); return; } producoesFiltradas.sort((a, b) => new Date(a.data) - new Date(b.data)); const clienteSelecionadoObj = clienteIdSelecionado ? appData.clientes.find(c => c.id == clienteIdSelecionado) : null; let totalGeralRelatorio = 0; let html = `<div id="comprovante-para-impressao">`; html += `<h1>Relatório de Produção por Período</h1>`; html += `<p style="text-align:center; margin-bottom:10px;"><strong>${appData.configuracoes.nomeAtelie}</strong></p>`; html += `<p><strong>Período:</strong> ${formatarData(dataInicioStr)} a ${formatarData(dataFimStr)}</p>`; if (clienteSelecionadoObj) { html += `<p><strong>Cliente:</strong> ${clienteSelecionadoObj.nome}</p>`; } html += `<hr>`; html += `<table><thead><tr><th>Data</th><th>Peça Base</th><th>Descrição Detalhada</th><th>Qtd</th><th>Valor Item</th><th>Valor Total</th></tr></thead><tbody>`; producoesFiltradas.forEach(p => { const valorUnitario = p.quantidade > 0 ? (p.valorTotalItem / p.quantidade) : 0; html += `<tr><td>${formatarData(p.data)}</td><td>${p.nomePecaModelo || '-'} ${p.corPeca ? `(${p.corPeca})` : ''}</td><td>${p.modeloDescricao || '-'}</td><td style="text-align:center;">${p.quantidade}</td><td style="text-align:right;">${formatarMoeda(valorUnitario)}</td><td style="text-align:right;">${formatarMoeda(p.valorTotalItem)}</td></tr>`; totalGeralRelatorio += p.valorTotalItem; }); html += `</tbody></table>`; html += `<hr>`; html += `<h2 style="text-align:right; margin-top:15px;">Total Geral do Período: ${formatarMoeda(totalGeralRelatorio)}</h2>`; html += `<p id="rodape-comprovante">Gerado por: Gestor de Ateliê Pro em ${formatarData(hojeFormatado())}</p>`; html += `</div>`; if(comprovanteContainerHidden) comprovanteContainerHidden.innerHTML = html; requestAnimationFrame(() => { requestAnimationFrame(() => { window.print(); }); }); }
              if(btnGerarRelatorioPeriodo) btnGerarRelatorioPeriodo.addEventListener('click', gerarRelatorioProducaoPeriodo);
              function popularSelectClientesRelatorio() { /* ... (Mantida) ... */ if(!filtroRelatorioCliente) return; filtroRelatorioCliente.innerHTML = '<option value="">Todos os Clientes</option>'; appData.clientes.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = c.nome; filtroRelatorioCliente.appendChild(option); }); }


            // --- INICIALIZAÇÃO ---
            function inicializarTodasAsRenderizacoes() {
                if(anoAtualEl) anoAtualEl.textContent = new Date().getFullYear();
                if(prodDataInput) prodDataInput.value = hojeFormatado();
                if(reparoDataEntradaInput) reparoDataEntradaInput.value = hojeFormatado();
                if(horasDataInput) horasDataInput.value = hojeFormatado();
                if(maquinaDataCompraInput) maquinaDataCompraInput.value = hojeFormatado();
                if(despesaDataInput) despesaDataInput.value = hojeFormatado();
                if(manutencaoDataInput) manutencaoDataInput.value = hojeFormatado();
                if(reparoMaquinaDataInput) reparoMaquinaDataInput.value = hojeFormatado();
                if(filtroMesHoras) filtroMesHoras.value = mesAnoAtualFormatado();

                popularCategoriasDespesa();
                renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao();
                renderizarTabelaClientes(); popularSelectClientesProducao(); popularSelectClientesRelatorio();
                renderizarTabelaContatosUteis();
                renderizarListaMaquinas();
                renderizarTabelaDespesas(); popularCategoriasDespesaFiltro();
                renderizarTabelaProducao();
                renderizarTabelaReparos();
                if (appData.configuracoes.modoInterface === 'completo') { renderizarHorasTrabalhadas(); renderizarAnotacoes(); }
                renderizarDashboard();

                if (btnAdicionarExemplosPecasModelos) { btnAdicionarExemplosPecasModelos.style.display = appData.pecasModelos.length === 0 ? 'block' : 'inline-block'; }
                updateArrowVisibility();
            }

            // --- Início da Execução ---
            carregarDados();
            inicializarTodasAsRenderizacoes();
            // Ativa a primeira aba (Dashboard) ao carregar
            const primeiroBotaoNav = document.querySelector('.bottom-nav-item[data-tab="tab-dashboard"]');
            if (primeiroBotaoNav) {
                 ativarAba("tab-dashboard", primeiroBotaoNav);
            }
             // Atualiza as setas após um pequeno delay
            setTimeout(updateArrowVisibility, 150);

            console.log("App Ateliê Gestor Pro - vNavConfigManutAjustada - JS Finalizado.");

        } catch (error) {
            console.error("Erro GERAL na inicialização ou execução do script:", error);
            const errorMsgDiv = document.getElementById('mensagem-global') || document.createElement('div'); if (!document.getElementById('mensagem-global')) { errorMsgDiv.id = 'mensagem-global'; errorMsgDiv.className = 'mensagem-feedback erro'; errorMsgDiv.style.margin = '20px'; document.body.prepend(errorMsgDiv); } errorMsgDiv.textContent = `Ocorreu um erro crítico. Por favor, recarregue a página ou contate o suporte. Detalhes: ${error.message}`; errorMsgDiv.style.display = 'block';
        }
    });
    </script>
</body>
</html>