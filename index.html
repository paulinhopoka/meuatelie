<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title id="app-title">Gestor de Ateliê Pro</title>
    <!-- Link para o Web App Manifest -->
    <link rel="manifest" href="./manifest.json">
    <style>
        :root {
            --cor-primaria: #E91E63; /* Rosa Padrão */
            --cor-secundaria: #AD1457; /* Rosa Escuro Padrão */
            --cor-fundo-app: #F4F6F9; /* Um cinza um pouco mais suave */
            --cor-fundo-container: #FFFFFF; /* Branco */
            --cor-texto: #343A40; /* Cinza Escuro */
            --cor-texto-claro: #FFFFFF; /* Branco */
            --cor-destaque: #FFC107; /* Amarelo */
            --cor-sucesso: #28A745; /* Verde */
            --cor-erro: #DC3545; /* Vermelho */
            --cor-info: #17A2B8; /* Azul Ciano */
            --cor-aviso: #FF7F0E; /* Laranja */
            --cor-borda: #DEE2E6; /* Cinza Claro */
            --sombra-padrao: 0 3px 10px rgba(0, 0, 0, 0.08);
            --borda-arredondada: 10px;
            --padding-padrao: 16px;
            --altura-bottom-nav: 65px;
            --altura-header: 60px;
            --altura-subheader: 45px;
            --cor-primaria-transparente: rgba(233, 30, 99, 0.25);
        }

        /* TEMAS */
        body.theme-classic-rose { /* Padrão */ }
        body.theme-ocean-breeze { --cor-primaria: #007BFF; --cor-secundaria: #0056B3; --cor-fundo-app: #E7F3FF; --cor-fundo-container: #FDFEFF; --cor-texto: #212529; --cor-destaque: #FFC107; --cor-primaria-transparente: rgba(0, 123, 255, 0.25); }
        body.theme-forest-haven { --cor-primaria: #28A745; --cor-secundaria: #19692C; --cor-fundo-app: #EAF6EC; --cor-fundo-container: #FBFCFA; --cor-texto: #155724; --cor-destaque: #FD7E14; --cor-primaria-transparente: rgba(40, 167, 69, 0.25); }
        body.theme-sunset-glow { --cor-primaria: #FD7E14; --cor-secundaria: #B3590D; --cor-fundo-app: #FFF3E0; --cor-fundo-container: #FFFCF5; --cor-texto: #592E00; --cor-destaque: #007BFF; --cor-primaria-transparente: rgba(253, 126, 20, 0.25); }
        body.theme-lavender-dream { --cor-primaria: #6F42C1; --cor-secundaria: #4A2C82; --cor-fundo-app: #F0E6FF; --cor-fundo-container: #F9F5FF; --cor-texto: #3D2370; --cor-destaque: #20C997; --cor-primaria-transparente: rgba(111, 66, 193, 0.25); }
        body.theme-dark-mode { --cor-primaria: #BB86FC; --cor-secundaria: #3700B3; --cor-fundo-app: #121212; --cor-fundo-container: #1E1E1E; --cor-texto: #E0E0E0; --cor-texto-claro: #121212; --cor-destaque: #03DAC6; --cor-borda: #444444; --cor-primaria-transparente: rgba(187, 134, 252, 0.25); }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--cor-fundo-app); color: var(--cor-texto); line-height: 1.6;
            padding: calc(var(--altura-header) + var(--altura-subheader) + 15px) 15px calc(var(--altura-bottom-nav) + 20px) 15px;
            transition: background-color 0.3s ease, color 0.3s ease; min-height: 100vh;
        }
        .app-header-fixed { position: fixed; top: 0; left: 0; width: 100%; z-index: 999; background-color: var(--cor-fundo-container); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header#app-main-header { height: var(--altura-header); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px var(--padding-padrao); border-bottom: 1px solid var(--cor-borda); }
        header#app-main-header h1 { color: var(--cor-primaria); font-size: 1.5em; margin-bottom: 0; line-height: 1.2; }
        #nome-atelie-header { font-style: italic; }
        header#app-main-header p { font-size: 0.8em; color: var(--cor-texto); opacity: 0.7; margin-top: 2px; line-height: 1.2; }
        
        .sub-header-fixed {
            height: var(--altura-subheader);
            display: flex;
            align-items: center;
            padding: 0 var(--padding-padrao);
            background-color: var(--cor-fundo-app);
            border-bottom: 1px solid var(--cor-borda);
            transition: font-size 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        .sub-header-fixed h2#sub-header-titulo-aba {
            flex-grow: 1;
            text-align: center;
            font-size: 1.1em;
            color: var(--cor-secundaria);
            margin: 0;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 40px; 
            padding-left: 40px;
        }
        button#btn-ajuda-sub-header {
            background: none;
            border: none;
            color: var(--cor-info);
            font-size: 1.4em;
            cursor: pointer;
            padding: 3px 5px;
            line-height: 1;
            position: absolute; 
            right: var(--padding-padrao); 
            top: 50%; 
            transform: translateY(-50%); 
        }
        button#btn-ajuda-sub-header:hover { color: var(--cor-primaria); opacity: 1; }

        body.scrolled .sub-header-fixed { box-shadow: var(--sombra-padrao); }
        body.scrolled .sub-header-fixed h2 { font-size: 0.95em; }
        .container-principal { max-width: 1200px; margin: 0 auto; width: 100%; background-color: transparent; padding: 0; box-shadow: none; border-radius: 0; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--altura-bottom-nav); background-color: var(--cor-fundo-container); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -3px 12px rgba(0,0,0,0.1); z-index: 1000; border-top: 1px solid var(--cor-borda); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 6px 2px; cursor: pointer; border: none; background: transparent; color: var(--cor-texto); opacity: 0.7; font-size: 0.65em; text-align: center; transition: color 0.2s ease, opacity 0.2s ease, border-top-color 0.2s ease; border-top: 3px solid transparent; }
        .bottom-nav-item .icon { font-size: 1.6em; margin-bottom: 1px; }
        .bottom-nav-item.active { color: var(--cor-primaria); opacity: 1; font-weight: 600; border-top-color: var(--cor-primaria); }
        .tab-content { display: none; animation: fadeInTab 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeInTab { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .secao { 
            margin-bottom: 25px; 
            padding: var(--padding-padrao); 
            background-color: var(--cor-fundo-container); 
            border-radius: var(--borda-arredondada); 
            border: 1px solid var(--cor-borda); 
            box-shadow: var(--sombra-padrao); 
        }
        /* Ajuste para quando o primeiro elemento NÃO é H3 (ex: formulário) */
        .secao > *:first-child { margin-top: 0; }
        .secao h3 { color: var(--cor-primaria); margin: 18px 0 10px 0; font-size: 1.25em; }
        /* Garante que H3 após o filtro tenha margem */
        .secao > .filtro-periodo-container + h3, 
        .secao > .filtros-container + h3 { margin-top: 18px; } 

        label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--cor-texto); font-size: 0.9em; }
        input[type="text"], input[type="number"], input[type="date"], input[type="tel"], input[type="email"], input[type="time"], input[type="month"], input[type="color"], select, textarea { width: 100%; padding: 12px; margin-bottom: 14px; border: 1px solid var(--cor-borda); border-radius: calc(var(--borda-arredondada) - 5px); font-size: 1em; background-color: var(--cor-fundo-app); color: var(--cor-texto); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--cor-primaria); box-shadow: 0 0 0 3px var(--cor-primaria-transparente); }
        input[type="color"] { padding: 2px; height: 45px; }
        textarea { min-height: 80px; resize: vertical; }
        .checkbox-label { font-weight: normal; display: flex; align-items: center; margin-bottom: 10px; font-size: 1em; }
        input[type="checkbox"] { margin-right: 8px; transform: scale(1.3); }
        .campo-grupo { margin-bottom: 14px; }
        .grid-2-col, .grid-3-col { display: grid; gap: 14px; }
        .grid-2-col { grid-template-columns: 1fr; }
        .grid-3-col { grid-template-columns: 1fr; }
        @media (min-width: 600px) { .grid-2-col { grid-template-columns: 1fr 1fr; } .grid-3-col { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));} }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; font-size: 1em; font-weight: bold; color: var(--cor-texto-claro); background-color: var(--cor-primaria); border: none; border-radius: var(--borda-arredondada); cursor: pointer; text-align: center; transition: all 0.2s ease; text-decoration: none; }
        .btn:hover { filter: brightness(115%); transform: translateY(-1px); }
        .btn:active { transform: translateY(0px) scale(0.98); filter: brightness(100%);}
        .btn .icon { font-size: 1.1em; }
        .btn-secundario { background-color: var(--cor-texto); opacity:0.8; } .btn-secundario:hover { opacity:1; }
        .btn-sucesso { background-color: var(--cor-sucesso); } .btn-perigo { background-color: var(--cor-erro); }
        .btn-aviso { background-color: var(--cor-aviso); } .btn-info { background-color: var(--cor-info); }
        .btn-pequeno { padding: 6px 12px; font-size: 0.85em; }
        .btn-full-width { width: 100%; display: flex; margin-top: 8px; }
        
        .tabela-responsiva { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--cor-borda); padding: 10px 12px; text-align: left; vertical-align: middle; font-size: 0.9em; line-height: 1.4; }
        th { background-color: var(--cor-secundaria); color: var(--cor-texto-claro); font-weight: bold; }
        tr:nth-child(even) td { background-color: #f9f9f9; }
        tr:hover td { background-color: #f1f1f1; }
        td .btn { margin-right: 5px; margin-bottom: 5px; }
        
        #tabela-producao th:nth-child(1), #tabela-producao td:nth-child(1) { min-width: 80px; } /* Data */
        #tabela-producao th:nth-child(2), #tabela-producao td:nth-child(2) { min-width: 130px; } /* Peça Base/Cor */
        #tabela-producao th:nth-child(3), #tabela-producao td:nth-child(3) { min-width: 120px; } /* Cliente */
        #tabela-producao th:nth-child(4), #tabela-producao td:nth-child(4) { min-width: 150px; white-space: normal; } /* Descrição Detalhada */
        #tabela-producao th:nth-child(5), #tabela-producao td:nth-child(5) { min-width: 50px; text-align: center; } /* Qtd */
        #tabela-producao th:nth-child(6), #tabela-producao td:nth-child(6) { min-width: 130px; white-space: normal; } /* Processos */
        #tabela-producao th:nth-child(7), #tabela-producao td:nth-child(7) { min-width: 90px; text-align: right; } /* Valor */
        #tabela-producao th:nth-child(8), #tabela-producao td:nth-child(8) { min-width: 90px; text-align: center; } /* Status */
        #tabela-producao th:nth-child(9), #tabela-producao td:nth-child(9) { min-width: 180px; text-align: center; } /* Ações */

        .dashboard-cards { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
        @media (min-width: 500px) { .dashboard-cards { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 900px) { .dashboard-cards { grid-template-columns: 1fr 1fr 1fr; } }
        .card { background-color: var(--cor-primaria); color: var(--cor-texto-claro); padding: var(--padding-padrao); border-radius: var(--borda-arredondada); text-align: center; box-shadow: var(--sombra-padrao); display: flex; flex-direction: column; justify-content: center; min-height: 110px; }
        .card.destaque { background-color: var(--cor-destaque); color: var(--cor-texto); }
        .card.info { background-color: var(--cor-info); }
        .card h3 { 
            margin-bottom: 8px; 
            font-size: 0.85em; 
            font-weight: 600; 
            opacity: 1; 
            color: inherit; 
            letter-spacing: 0.2px; 
        }
        .card p { 
            font-size: 1.8em; 
            font-weight: bold; 
            line-height: 1.2; 
        }

        .mensagem-feedback { padding: var(--padding-padrao); margin: 15px 0; border-radius: var(--borda-arredondada); text-align: center; font-weight: 500; display: none; border: 1px solid; }
        .mensagem-feedback.sucesso { background-color: #d4edda; color: #155724; border-color: #c3e6cb; display: block; }
        .mensagem-feedback.erro { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; display: block; }
        .mensagem-feedback.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; display: block; }
        
        /* Filtro de Status (Produção) - Mantido */
        #filtro-status-producao-container { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; padding: 12px; background-color: var(--cor-fundo-app); border-radius: var(--borda-arredondada); }
        #filtro-status-producao-container label { margin-bottom: 0; font-size: 0.85em; }
        #filtro-status-producao-container select { margin-bottom: 0; width: auto; min-width: 140px; padding: 8px; font-size: 0.9em;}
        
        .filtro-periodo-container {
            background-color: var(--cor-fundo-app);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: var(--borda-arredondada);
            border: 1px solid var(--cor-borda);
        }
        .filtro-periodo-container .controles-superiores-filtro {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        .filtro-periodo-container .btn-toggle-filtro {
            flex-grow: 1;
        }
        .filtro-periodo-container .btn-mes-atual {
            padding: 6px 10px;
            font-size: 0.9em;
            flex-shrink: 0; /* Evita que encolha demais */
        }

        .campos-filtro-periodo {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--cor-borda);
        }
        .campos-filtro-periodo label {
            margin-bottom: 0;
            font-size: 0.85em;
        }
        .campos-filtro-periodo input[type="date"] {
            padding: 8px;
            font-size: 0.9em;
            width: auto;
            min-width: 130px;
            margin-bottom: 0;
        }
        .campos-filtro-periodo .btn { 
            margin-left: auto; 
        }
        .periodo-selecionado-display {
            font-size: 0.8em;
            color: var(--cor-texto);
            opacity: 0.8;
            margin-top: 8px;
            text-align: center;
        }


        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModal 0.3s ease-out; }
        .modal-conteudo { background-color: var(--cor-fundo-container); margin: 8% auto; padding: 25px; border: 1px solid var(--cor-borda); width: 90%; max-width: 700px; border-radius: var(--borda-arredondada); box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; color: var(--cor-texto); }
        .modal-fechar { color: var(--cor-texto); opacity: 0.7; position: absolute; top: 10px; right: 20px; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-fechar:hover { opacity: 1; color: var(--cor-erro); }
        @keyframes fadeInModal { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1;transform: translateY(0px);}}
        .modal h2 { margin-top: 0; color: var(--cor-primaria); } .modal ul { list-style: inside; padding-left: 5px; margin-top:10px; }
        .modal li { margin-bottom: 8px; } .modal p { margin-bottom: 10px; }
        .theme-editor-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 10px; }
        @media (min-width: 500px) { .theme-editor-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
        .theme-editor-grid .campo-grupo label { display: flex; align-items: center; justify-content: space-between; }
        .theme-editor-grid input[type="color"] { width: 50px; height: 30px; padding: 0; margin-left: 10px; }
        .cor-peca-preview { display: inline-block; width: 16px; height: 16px; border-radius: 50%; margin-right: 6px; border: 1px solid #ccc; vertical-align: middle; }
        .modo-completo-item { display: none; } body.modo-completo .modo-completo-item { display: block; }
        .modo-simples-item { display: block; } body.modo-completo .modo-simples-item { display: none; }
        .grafico-barras-simples { display: flex; gap: 5px; align-items: flex-end; height: 150px; border-left: 2px solid var(--cor-borda); border-bottom: 2px solid var(--cor-borda); padding: 5px; margin-top:15px; overflow-x: auto; }
        .grafico-barras-simples .barra { background-color: var(--cor-primaria); flex-shrink: 0; width: 40px; text-align: center; color: var(--cor-texto-claro); font-size: 0.7em; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2px; }
        .grafico-barras-simples .barra span { writing-mode: vertical-rl; text-orientation: mixed; white-space:nowrap; transform: rotate(180deg); margin-bottom: 5px; }
        .btn-whatsapp { background-color: #25D366; } .btn-whatsapp:hover { background-color: #1DAE54; }
        #page-footer { text-align: center; margin-top: 30px; padding: 15px 0; border-top: 1px solid var(--cor-borda); color: var(--cor-texto); opacity:0.7; font-size: 0.85em; }
        #lista-processos-peca .processo-item { display: flex; gap: 10px; align-items: center; padding: 8px; border: 1px solid var(--cor-borda); margin-bottom: 8px; border-radius: calc(var(--borda-arredondada) - 4px); }
        #lista-processos-peca .processo-item input[type="text"], #lista-processos-peca .processo-item input[type="number"] { margin-bottom: 0; flex-grow: 1; }
        #lista-processos-peca .processo-item .btn-remover-processo-temp { padding: 6px 10px; font-size: 0.9em; line-height: 1; }

        /* ESTILOS DE IMPRESSÃO MELHORADOS */
        @media print {
            body { padding: 0 !important; margin: 0 !important; font-size: 10pt; }
            .nao-imprimir, .bottom-nav, .app-header-fixed, #page-footer, #btn-ajuda-sub-header, #mensagem-global, #filtro-status-producao-container, #filtro-periodo-container-dashboard, #filtro-periodo-container-producao, #btn-adicionar-exemplos-tipos-peca, #form-producao button, #form-tipo-peca button, #form-cliente button, #form-contato-util button, #form-reparo button, #form-horas button, #form-anotacao button, #tabela-producao .btn-editar-producao, #tabela-producao .btn-excluir-producao, #tabela-producao .btn-toggle-pago, #tabela-producao .btn-share-whatsapp, #tabela-tipos-peca .btn, #tabela-clientes .btn, #tabela-contatos-uteis .btn, #tabela-reparos .btn, .btn-editar-peca-modelo, .btn-excluir-peca-modelo, .btn-editar-cliente, .btn-excluir-cliente, .btn-editar-contato-util, .btn-excluir-contato-util, .btn-editar-reparo, .btn-excluir-reparo, #form-configuracoes-nomes button, #config-modo-interface, #config-tema-predefinido, #editor-tema-personalizado, #btn-exportar-dados, #input-importar-dados, #filtro-relatorio-cliente, #btn-gerar-relatorio-periodo  { display: none !important; }
            .container-principal { box-shadow: none; border: none; padding: 0; margin: 0; max-width: 100%; }
            .secao { box-shadow: none; border: none; margin-bottom: 10px; padding: 0;}
            .tab-content { display: none !important; }
            #comprovante-para-impressao-container { display: block !important; }
            #comprovante-para-impressao, #comprovante-para-impressao * { visibility: visible !important; color: #000 !important; background-color: #fff !important; }
            #comprovante-para-impressao { margin: 10mm; padding:0; font-size: 10pt; line-height: 1.4;}
            #comprovante-para-impressao h1 { font-size: 16pt; margin-bottom: 15px; text-align: center; }
            #comprovante-para-impressao h2 { font-size: 13pt; margin-top: 12px; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 3px;}
            #comprovante-para-impressao h3 { font-size: 11pt; margin-top: 10px; margin-bottom: 6px; font-weight: bold; }
            #comprovante-para-impressao p, #comprovante-para-impressao li { margin-bottom: 5px; }
            #comprovante-para-impressao p strong { font-weight: bold; }
            #comprovante-para-impressao ul { list-style: disc; padding-left: 20px; margin-top: 3px; }
            #comprovante-para-impressao hr { border: none; border-top: 1px dashed #999; margin: 12px 0; }
            #comprovante-para-impressao table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size:9pt; }
            #comprovante-para-impressao th, #comprovante-para-impressao td { border: 1px solid #666; padding: 5px; text-align: left; word-break: break-word;}
            #comprovante-para-impressao th { background-color: #eaeaea; font-weight: bold; }
            #rodape-comprovante { font-size: 8pt; text-align: center; margin-top: 15px; color: #444 !important; }
            a[href^="http"]:after { content: ""; } a {text-decoration: none; color: inherit;}
        }
        .comprovante-container-hidden { display: none; }

    </style>
</head>
<body class="modo-completo">
    <div class="app-header-fixed">
         <header id="app-main-header">
            <h1 id="nome-atelie-header">Gestor de Ateliê</h1>
            <p>Olá, <span id="nome-costureira-header">Costureira</span>! ❤️</p>
        </header>
        <div class="sub-header-fixed">
            <h2 id="sub-header-titulo-aba">Painel</h2>
            <button class="nao-imprimir" id="btn-ajuda-sub-header" title="Ajuda da Aba">❓</button>
        </div>
    </div>

    <div class="container-principal">
        <div id="mensagem-global" class="mensagem-feedback"></div>
        <main id="main-content">
            <!-- Tab: Dashboard -->
            <div id="tab-dashboard" class="tab-content active" data-help-key="dashboard">
                <section class="secao">
                    <div class="filtro-periodo-container" id="filtro-periodo-container-dashboard">
                        <div class="controles-superiores-filtro">
                            <button id="btn-toggle-filtro-periodo-dashboard" class="btn btn-pequeno btn-info btn-toggle-filtro">
                                🗓️ Definir Período <span class="arrow">▼</span>
                            </button>
                            <button id="btn-mes-atual-dashboard" class="btn btn-pequeno btn-info btn-mes-atual" title="Mês Atual">🔄 Mês Atual</button>
                        </div>
                        <div id="campos-filtro-periodo-dashboard" class="campos-filtro-periodo" style="display:none;">
                            <label for="filtro-data-inicio-dashboard">Início:</label>
                            <input type="date" id="filtro-data-inicio-dashboard">
                            <label for="filtro-data-fim-dashboard">Fim:</label>
                            <input type="date" id="filtro-data-fim-dashboard">
                            <button id="btn-aplicar-filtro-periodo-dashboard" class="btn btn-pequeno btn-sucesso">Aplicar</button>
                            <button id="btn-resetar-filtro-periodo-dashboard" class="btn btn-pequeno btn-secundario">Resetar Período</button> <!-- Renomeado -->
                        </div>
                        <p id="periodo-atual-dashboard" class="periodo-selecionado-display"></p>
                    </div>

                    <div class="dashboard-cards">
                        <div class="card"><h3>Ganhos do Dia</h3><p id="dash-valor-card1">R$ 0,00</p></div>
                        <div class="card destaque"><h3>Ganhos do Período</h3><p id="dash-valor-card2">R$ 0,00</p></div>
                        <div class="card"><h3>Total Recebido (Período)</h3><p id="dash-valor-card3">R$ 0,00</p></div>
                        <div class="card info"><h3>Total Pendente (Período)</h3><p id="dash-valor-card4">R$ 0,00</p></div>
                        <div class="card"><h3>Peças Produzidas (Período)</h3><p id="dash-valor-card5">0</p></div>
                        <div class="card"><h3>Horas Trabalhadas (Período)</h3><p id="dash-valor-card6">0h</p></div>
                    </div>
                    <div class="modo-completo-item">
                        <h3>📈 Ganhos Mensais (Últimos 6 Meses Referentes ao Fim do Período)</h3>
                        <div id="grafico-ganhos-mensais" class="grafico-barras-simples"></div>
                        <h3 style="margin-top:20px;">⭐ Peças Mais Produzidas (Período Selecionado)</h3>
                        <ul id="lista-top-pecas" class="lista-simples"></ul>
                    </div>
                </section>
            </div>

            <!-- Tab: Produção -->
            <div id="tab-producao" class="tab-content" data-help-key="producao">
                <section class="secao">
                     <form id="form-producao">
                        <!-- Conteúdo do formulário mantido -->
                        <input type="hidden" id="producao-id">
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="prod-data">Data:</label><input type="date" id="prod-data" required></div>
                            <div class="campo-grupo"><label for="prod-tipo-peca">Peça/Modelo Base:</label><select id="prod-tipo-peca" required></select></div>
                        </div>
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="prod-modelo-descricao">Descrição Detalhada (Item Específico):</label><input type="text" id="prod-modelo-descricao" placeholder="Ex: Renda frufru, Algodão cliente X"></div>
                            <div class="campo-grupo"><label for="prod-cor-peca">Cor da Peça:</label><input type="text" id="prod-cor-peca" placeholder="Ex: Preto, Rosa Bebê, Estampado Floral"></div>
                        </div>
                         <div class="campo-grupo modo-completo-item">
                            <label for="prod-cliente">Cliente (Opcional):</label>
                            <select id="prod-cliente"><option value="">Nenhum cliente específico</option></select>
                        </div>
                        <div class="modo-completo-item">
                            <h3>Processos Realizados:</h3>
                            <div id="processos-para-producao" class="campo-grupo"><p class="info-text">Selecione Peça/Modelo Base.</p></div>
                        </div>
                         <div class="campo-grupo modo-simples-item">
                            <label for="prod-valor-manual">Valor Total do Item (R$):</label>
                            <input type="number" id="prod-valor-manual" step="0.01" placeholder="Para modo simples sem processos">
                        </div>
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="prod-quantidade">Quantidade:</label><input type="number" id="prod-quantidade" min="1" value="1" required></div>
                            <div class="campo-grupo modo-completo-item">
                                <label for="prod-valor-total-calculado">Valor Total Processos (R$):</label>
                                <input type="text" id="prod-valor-total-calculado" readonly placeholder="Automático (Processos x Qtd)">
                            </div>
                        </div>
                        <div class="campo-grupo modo-completo-item">
                            <label for="prod-materiais">Materiais Utilizados (Opcional):</label>
                            <textarea id="prod-materiais" placeholder="Ex: Linha XYZ cor A, Tecido ABC, 2m elástico Z..."></textarea>
                        </div>
                        <div class="campo-grupo"><label class="checkbox-label"><input type="checkbox" id="prod-pago"> Pagamento Recebido</label></div>
                        <div class="campo-grupo"><label for="prod-observacoes">Observações:</label><textarea id="prod-observacoes"></textarea></div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Produção</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-limpar-form-prod" style="display:none;">Cancelar Edição</button>
                     </form>
                </section>
                <section class="secao">
                    <div class="filtro-periodo-container" id="filtro-periodo-container-producao">
                         <div class="controles-superiores-filtro">
                            <button id="btn-toggle-filtro-periodo-producao" class="btn btn-pequeno btn-info btn-toggle-filtro">
                                🗓️ Definir Período <span class="arrow">▼</span>
                            </button>
                             <button id="btn-mes-atual-producao" class="btn btn-pequeno btn-info btn-mes-atual" title="Mês Atual">🔄 Mês Atual</button>
                        </div>
                        <div id="campos-filtro-periodo-producao" class="campos-filtro-periodo" style="display:none;">
                            <label for="filtro-data-inicio-producao">Início:</label>
                            <input type="date" id="filtro-data-inicio-producao">
                            <label for="filtro-data-fim-producao">Fim:</label>
                            <input type="date" id="filtro-data-fim-producao">
                            <button id="btn-aplicar-filtro-periodo-producao" class="btn btn-pequeno btn-sucesso">Aplicar</button>
                            <button id="btn-resetar-filtro-periodo-producao" class="btn btn-pequeno btn-secundario">Resetar Período</button> <!-- Renomeado -->
                        </div>
                        <p id="periodo-atual-producao" class="periodo-selecionado-display"></p>
                    </div>

                     <div id="filtro-status-producao-container"> <!-- Era .filtros-container -->
                        <label for="filtro-status-pagamento">Status Pag.:</label>
                        <select id="filtro-status-pagamento"><option value="todos">Todos</option><option value="pago">Pago</option><option value="pendente">Pendente</option></select>
                    </div>
                    <div class="tabela-responsiva">
                        <table id="tabela-producao">
                            <thead>
                                <tr>
                                    <th class="col-data">Data</th>
                                    <th class="col-peca">Peça Base/Cor</th>
                                    <th class="modo-completo-item col-cliente">Cliente</th>
                                    <th class="col-descricao">Descrição Detalhada</th>
                                    <th class="col-qtd">Qtd</th>
                                    <th class="modo-completo-item col-processos">Processos</th>
                                    <th class="col-valor">Valor</th>
                                    <th class="col-status">Status</th>
                                    <th class="col-acoes">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpo-tabela-producao"></tbody>
                        </table>
                    </div>
                    <p id="sem-producao-msg" class="mensagem-feedback info" style="display:none;">Nenhuma produção encontrada.</p>

                    <h3 style="margin-top: 30px;">Gerar Relatório Detalhado</h3>
                    <div class="filtros-container" id="filtros-relatorio-periodo">
                        <p style="font-size:0.9em; margin-bottom:5px;">O relatório usará o período definido acima. Você pode refinar por cliente:</p>
                        <div class="modo-completo-item"><label for="filtro-relatorio-cliente">Cliente (Opcional):</label><select id="filtro-relatorio-cliente"><option value="">Todos os Clientes</option></select></div>
                        <button class="btn btn-sucesso" id="btn-gerar-relatorio-periodo" style="padding: 8px 15px;"><span class="icon">🧾</span>Gerar Relatório</button>
                    </div>
                </section>
            </div>

            <!-- Tab: Peças/Modelos -->
            <div id="tab-pecas-modelos" class="tab-content" data-help-key="pecas">
                 <section class="secao">
                    <form id="form-tipo-peca">
                        <!-- Conteúdo do formulário mantido -->
                        <input type="hidden" id="tipo-peca-id-edit">
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="tipo-peca-nome">Nome da Peça/Modelo:</label><input type="text" id="tipo-peca-nome" placeholder="Ex: Sutiã Reforçado Alça Larga" required></div>
                            <div class="campo-grupo" style="align-self: end;"><label class="checkbox-label"><input type="checkbox" id="tipo-peca-cobra-par"> Cobrado por Par</label></div>
                        </div>
                        <div class="modo-completo-item">
                            <h3>Processos desta Peça/Modelo:</h3>
                            <div id="lista-processos-peca"></div>
                            <button type="button" class="btn btn-pequeno btn-info" id="btn-add-processo-peca" style="margin:5px 0 15px 0;">+ Processo</button>
                        </div>
                        <div class="campo-grupo modo-completo-item">
                            <label for="tipo-peca-materiais">Materiais Padrão Sugeridos (Opcional):</label>
                            <textarea id="tipo-peca-materiais" placeholder="Ex: Renda X, Microfibra Y, Bojo Z..."></textarea>
                        </div>
                        <br>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Peça/Modelo</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-tipo-peca" style="display:none;">Cancelar Edição</button>
                    </form>
                    <button class="btn btn-info btn-full-width" id="btn-adicionar-exemplos-tipos-peca" style="margin-top: 15px;">+ Adicionar Exemplos Iniciais</button>
                </section>
                <section class="secao">
                    <div class="tabela-responsiva">
                        <table id="tabela-tipos-peca">
                            <thead><tr><th>Nome</th><th class="modo-completo-item">Processos (Valor Total)</th><th>Cobrado Por</th><th class="modo-completo-item">Materiais</th><th>Ações</th></tr></thead>
                            <tbody id="corpo-tabela-tipos-peca"></tbody>
                        </table>
                    </div>
                    <p id="sem-tipos-peca-msg" class="mensagem-feedback info" style="display:none;">Nenhuma peça/modelo cadastrado.</p>
                </section>
            </div>

            <!-- Tab: Clientes -->
            <div id="tab-clientes" class="tab-content" data-help-key="clientes">
                  <section class="secao">
                     <form id="form-cliente">
                        <!-- Conteúdo do formulário mantido -->
                        <input type="hidden" id="cliente-id-edit">
                        <div class="campo-grupo"><label for="cliente-nome">Nome Completo:</label><input type="text" id="cliente-nome" required></div>
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="cliente-telefone">Telefone/WhatsApp:</label><input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"></div>
                            <div class="campo-grupo"><label for="cliente-email">Email (Opcional):</label><input type="email" id="cliente-email"></div>
                        </div>
                        <div class="campo-grupo modo-completo-item"><label for="cliente-endereco">Endereço (Opcional):</label><textarea id="cliente-endereco" placeholder="Rua, Número, Bairro, Cidade..."></textarea></div>
                        <div class="campo-grupo"><label for="cliente-observacoes">Observações (Preferências, etc.):</label><textarea id="cliente-observacoes"></textarea></div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Cliente</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-cliente" style="display:none;">Cancelar Edição</button>
                     </form>
                </section>
                <section class="secao">
                    <input type="text" id="filtro-clientes" placeholder="🔎 Buscar cliente por nome..." style="margin-bottom:15px;">
                    <div class="tabela-responsiva">
                        <table id="tabela-clientes">
                            <thead><tr><th>Nome</th><th>Contato</th><th class="modo-completo-item">Observações</th><th>Ações</th></tr></thead>
                            <tbody id="corpo-tabela-clientes"></tbody>
                        </table>
                    </div>
                    <p id="sem-clientes-msg" class="mensagem-feedback info" style="display:none;">Nenhum cliente cadastrado.</p>
                </section>
            </div>

            <!-- Tab: Contatos Úteis -->
            <div id="tab-contatos" class="tab-content" data-help-key="contatos">
                  <section class="secao">
                     <form id="form-contato-util">
                        <!-- Conteúdo do formulário mantido -->
                         <input type="hidden" id="contato-util-id-edit">
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="contato-util-nome">Nome:</label><input type="text" id="contato-util-nome" required></div>
                            <div class="campo-grupo"><label for="contato-util-tipo">Tipo:</label>
                                <select id="contato-util-tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="Fornecedor">Fornecedor</option><option value="Mecânico Máquina">Mecânico Máquina</option>
                                    <option value="Entregador">Entregador</option><option value="Parceiro">Parceiro</option><option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="contato-util-telefone">Telefone/WhatsApp:</label><input type="tel" id="contato-util-telefone" placeholder="(XX) XXXXX-XXXX"></div>
                            <div class="campo-grupo"><label for="contato-util-email">Email (Opcional):</label><input type="email" id="contato-util-email"></div>
                        </div>
                        <div class="campo-grupo"><label for="contato-util-observacoes">Observações (Serviços, etc.):</label><textarea id="contato-util-observacoes"></textarea></div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Contato</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-contato-util" style="display:none;">Cancelar Edição</button>
                     </form>
                </section>
                <section class="secao">
                    <input type="text" id="filtro-contatos" placeholder="🔎 Buscar contato..." style="margin-bottom:15px;">
                    <div class="tabela-responsiva">
                        <table id="tabela-contatos-uteis">
                            <thead><tr><th>Nome</th><th>Tipo</th><th>Contato</th><th class="modo-completo-item">Observações</th><th>Ações</th></tr></thead>
                            <tbody id="corpo-tabela-contatos-uteis"></tbody>
                        </table>
                    </div>
                    <p id="sem-contatos-uteis-msg" class="mensagem-feedback info" style="display:none;">Nenhum contato útil cadastrado.</p>
                </section>
            </div>
            
            <!-- Tab: Reparos/Consertos -->
            <div id="tab-reparos" class="tab-content" data-help-key="reparos">
                  <section class="secao">
                     <form id="form-reparo">
                        <!-- Conteúdo do formulário mantido -->
                        <input type="hidden" id="reparo-id">
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="reparo-data-entrada">Data Entrada:</label><input type="date" id="reparo-data-entrada" required></div>
                            <div class="campo-grupo"><label for="reparo-origem-texto">Cliente/Origem:</label><input type="text" id="reparo-origem-texto" placeholder="Nome do cliente ou 'Produção Interna'"></div>
                        </div>
                        <div class="campo-grupo"><label for="reparo-descricao">Descrição Problema/Serviço:</label><textarea id="reparo-descricao"></textarea> </div>
                        <div class="grid-2-col">
                            <div class="campo-grupo"><label for="reparo-valor">Valor (R$):</label><input type="number" id="reparo-valor" step="0.01" value="0"></div>
                            <div class="campo-grupo"><label for="reparo-status">Status:</label>
                                <select id="reparo-status"><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option><option value="Entregue">Entregue</option></select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Reparo</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-reparo" style="display:none;">Cancelar Edição</button>
                     </form>
                </section>
                <section class="secao">
                    <div class="tabela-responsiva">
                        <table id="tabela-reparos">
                            <thead><tr><th>Data</th><th>Origem</th><th>Descrição</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="corpo-tabela-reparos"></tbody>
                        </table>
                    </div>
                     <p id="sem-reparos-msg" class="mensagem-feedback info" style="display:none;">Nenhum reparo registrado.</p>
                </section>
            </div>

            <!-- Tab: Configurações -->
             <div id="tab-configuracoes" class="tab-content" data-help-key="configuracoes">
                <section class="secao">
                    <form id="form-configuracoes-nomes">
                        <!-- Conteúdo do formulário mantido -->
                        <div class="campo-grupo"><label for="config-nome-atelie">Nome Ateliê/Firma:</label><input type="text" id="config-nome-atelie"></div>
                        <div class="campo-grupo"><label for="config-nome-costureira">Seu Nome:</label><input type="text" id="config-nome-costureira"></div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Nomes</button>
                    </form>
                     <div class="campo-grupo" style="margin-top:20px;">
                        <label for="config-modo-interface">Modo da Interface:</label>
                        <select id="config-modo-interface">
                            <option value="completo">✨ Completo (Todas as Funcionalidades)</option>
                            <option value="simples">👌 Simples (Foco no Essencial)</option>
                        </select>
                    </div>
                </section>
                <section class="secao">
                    <div class="campo-grupo">
                        <label for="config-tema-predefinido">Temas Predefinidos:</label>
                        <select id="config-tema-predefinido">
                            <option value="theme-classic-rose">Rosa Clássico</option><option value="theme-ocean-breeze">Brisa do Oceano</option>
                            <option value="theme-forest-haven">Refúgio da Floresta</option><option value="theme-sunset-glow">Brilho do Pôr do Sol</option>
                            <option value="theme-lavender-dream">Sonho de Lavanda</option><option value="theme-dark-mode">Modo Escuro</option>
                            <option value="custom">✨ Personalizado ✨</option>
                        </select>
                    </div>
                    <div id="editor-tema-personalizado" style="display:none;">
                        <h3>Personalizar Cores (Prévia em tempo real):</h3>
                        <div class="theme-editor-grid">
                            <div class="campo-grupo"><label for="cor-primaria-picker">Cor Primária <input type="color" id="cor-primaria-picker"></label></div>
                            <div class="campo-grupo"><label for="cor-secundaria-picker">Cor Secundária <input type="color" id="cor-secundaria-picker"></label></div>
                            <div class="campo-grupo"><label for="cor-fundo-app-picker">Fundo App <input type="color" id="cor-fundo-app-picker"></label></div>
                            <div class="campo-grupo"><label for="cor-fundo-container-picker">Fundo Conteúdo <input type="color" id="cor-fundo-container-picker"></label></div>
                            <div class="campo-grupo"><label for="cor-texto-picker">Cor do Texto <input type="color" id="cor-texto-picker"></label></div>
                            <div class="campo-grupo"><label for="cor-destaque-picker">Cor Destaque <input type="color" id="cor-destaque-picker"></label></div>
                        </div>
                        <button class="btn btn-sucesso btn-full-width" id="btn-salvar-tema-personalizado" style="margin-top:10px;"><span class="icon">💾</span>Salvar Tema Personalizado</button>
                    </div>
                </section>
                <section class="secao modo-completo-item">
                    <form id="form-horas">
                        <!-- Conteúdo do formulário mantido -->
                         <div class="grid-2-col">
                            <div class="campo-grupo"><label for="horas-data">Data:</label><input type="date" id="horas-data" required></div>
                            <div class="campo-grupo"><label for="horas-quantidade">Horas Trabalhadas:</label><input type="number" id="horas-quantidade" step="0.1" min="0.1" required></div>
                        </div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Registrar Horas</button>
                    </form>
                    <h3 style="margin-top:20px;">Registro de Horas (Mês Atual)</h3>
                    <div class="filtros-container"><label for="filtro-mes-horas">Mês/Ano:</label><input type="month" id="filtro-mes-horas"></div>
                    <ul id="lista-horas-registradas" class="lista-simples"></ul>
                    <p id="sem-horas-msg" class="mensagem-feedback info" style="display:none;">Nenhuma hora neste mês.</p>
                    <h4>Total Horas Mês: <span id="total-horas-mes" style="color: var(--cor-primaria);">0h</span></h4>
                </section>
                 <section class="secao modo-completo-item">
                    <form id="form-anotacao">
                        <!-- Conteúdo do formulário mantido -->
                        <input type="hidden" id="anotacao-id">
                        <div class="campo-grupo"><label for="anotacao-titulo">Título (Opcional):</label><input type="text" id="anotacao-titulo"></div>
                        <div class="campo-grupo"><label for="anotacao-conteudo">Anotação:</label><textarea id="anotacao-conteudo"></textarea></div>
                        <button type="submit" class="btn btn-sucesso btn-full-width"><span class="icon">💾</span>Salvar Anotação</button>
                        <button type="button" class="btn btn-secundario btn-full-width" id="btn-cancelar-edicao-anotacao" style="display:none;">Cancelar</button>
                    </form>
                    <h3 style="margin-top:20px;">Suas Anotações</h3>
                    <div id="lista-anotacoes"></div>
                    <p id="sem-anotacoes-msg" class="mensagem-feedback info" style="display:none;">Nenhuma anotação.</p>
                </section>
                <section class="secao">
                    <p>Faça backups regulares dos seus dados para segurança.</p>
                    <div class="grid-2-col" style="margin-top:10px;">
                        <button class="btn btn-info btn-full-width" id="btn-exportar-dados"><span class="icon">📤</span>Exportar Dados</button>
                        <div>
                            <label for="input-importar-dados" class="btn btn-aviso btn-full-width" style="display:flex; text-align:center;"><span class="icon">📥</span>Importar (Substitui!)</label>
                            <input type="file" id="input-importar-dados" accept=".json" style="display:none;">
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer id="page-footer">
            <p>&copy; <span id="ano-atual"></span> <span id="footer-nome-atelie">Seu Ateliê</span>. Feito com amor e carinho!</p>
        </footer>
    </div>

    <nav class="bottom-nav">
        <button class="bottom-nav-item active" data-tab="tab-dashboard" title="Painel"><span class="icon">📊</span>Painel</button>
        <button class="bottom-nav-item" data-tab="tab-producao" title="Produção"><span class="icon">🧵</span>Produção</button>
        <button class="bottom-nav-item" data-tab="tab-pecas-modelos" title="Modelos"><span class="icon">✂️</span>Modelos</button>
        <button class="bottom-nav-item" data-tab="tab-clientes" title="Clientes"><span class="icon">👥</span>Clientes</button>
        <button class="bottom-nav-item" data-tab="tab-contatos" title="Contatos"><span class="icon">📞</span>Contatos</button>
        <button class="bottom-nav-item" data-tab="tab-reparos" title="Reparos"><span class="icon">🛠️</span>Reparos</button>
        <button class="bottom-nav-item" data-tab="tab-configuracoes" title="Ajustes"><span class="icon">⚙️</span>Ajustes</button>
    </nav>

    <div id="modal-ajuda" class="modal">
        <div class="modal-conteudo">
            <span class="modal-fechar" id="modal-ajuda-fechar">&times;</span>
            <h2 id="modal-ajuda-titulo">Ajuda</h2>
            <div id="modal-ajuda-conteudo"><p>Conteúdo da ajuda aqui...</p></div>
        </div>
    </div>

    <!-- Container para impressão, permanece oculto -->
    <div id="comprovante-para-impressao-container" class="comprovante-container-hidden" aria-hidden="true"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        try { // Adiciona um try...catch geral para capturar erros de inicialização
            console.log("App Ateliê Gestor Pro - vFinalCorrigidaFuncional - JS Iniciado");

            // --- ELEMENTOS GLOBAIS DO DOM ---
            const appTitle = document.getElementById('app-title');
            const nomeAtelieHeader = document.getElementById('nome-atelie-header');
            const nomeCostureiraHeader = document.getElementById('nome-costureira-header');
            const footerNomeAtelie = document.getElementById('footer-nome-atelie');
            const anoAtualEl = document.getElementById('ano-atual');
            const mensagemGlobalEl = document.getElementById('mensagem-global');
            const bodyEl = document.body;
            const subHeaderTituloAbaEl = document.getElementById('sub-header-titulo-aba');
            const btnAjudaSubHeader = document.getElementById('btn-ajuda-sub-header');
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            const modalAjuda = document.getElementById('modal-ajuda');
            const modalAjudaFechar = document.getElementById('modal-ajuda-fechar');
            const modalAjudaTitulo = document.getElementById('modal-ajuda-titulo');
            const modalAjudaConteudo = document.getElementById('modal-ajuda-conteudo');

            const dashValorCard1 = document.getElementById('dash-valor-card1');
            const dashValorCard2 = document.getElementById('dash-valor-card2');
            const dashValorCard3 = document.getElementById('dash-valor-card3');
            const dashValorCard4 = document.getElementById('dash-valor-card4');
            const dashValorCard5 = document.getElementById('dash-valor-card5');
            const dashValorCard6 = document.getElementById('dash-valor-card6');
            const graficoGanhosMensaisDiv = document.getElementById('grafico-ganhos-mensais');
            const listaTopPecasUl = document.getElementById('lista-top-pecas');
            const btnToggleFiltroPeriodoDashboard = document.getElementById('btn-toggle-filtro-periodo-dashboard');
            const camposFiltroPeriodoDashboard = document.getElementById('campos-filtro-periodo-dashboard');
            const filtroDataInicioDashboard = document.getElementById('filtro-data-inicio-dashboard');
            const filtroDataFimDashboard = document.getElementById('filtro-data-fim-dashboard');
            const btnAplicarFiltroPeriodoDashboard = document.getElementById('btn-aplicar-filtro-periodo-dashboard');
            const btnResetarFiltroPeriodoDashboard = document.getElementById('btn-resetar-filtro-periodo-dashboard'); // Corrigido
            const btnMesAtualDashboard = document.getElementById('btn-mes-atual-dashboard');
            const periodoAtualDashboardEl = document.getElementById('periodo-atual-dashboard');

            const formProducao = document.getElementById('form-producao');
            const producaoIdInput = document.getElementById('producao-id');
            const prodDataInput = document.getElementById('prod-data');
            const prodPecaModeloSelect = document.getElementById('prod-tipo-peca');
            const prodModeloDescricaoInput = document.getElementById('prod-modelo-descricao');
            const prodCorPecaInput = document.getElementById('prod-cor-peca');
            const prodClienteSelect = document.getElementById('prod-cliente');
            const processosParaProducaoDiv = document.getElementById('processos-para-producao');
            const prodValorManualInput = document.getElementById('prod-valor-manual');
            const prodQuantidadeInput = document.getElementById('prod-quantidade');
            const prodValorTotalCalculadoInput = document.getElementById('prod-valor-total-calculado');
            const prodMateriaisTextarea = document.getElementById('prod-materiais');
            const prodPagoCheckbox = document.getElementById('prod-pago');
            const prodObservacoesTextarea = document.getElementById('prod-observacoes');
            const btnLimparFormProd = document.getElementById('btn-limpar-form-prod');
            const corpoTabelaProducao = document.getElementById('corpo-tabela-producao');
            const semProducaoMsg = document.getElementById('sem-producao-msg');
            const filtroStatusPagamento = document.getElementById('filtro-status-pagamento');
            const btnToggleFiltroPeriodoProducao = document.getElementById('btn-toggle-filtro-periodo-producao');
            const camposFiltroPeriodoProducao = document.getElementById('campos-filtro-periodo-producao');
            const filtroDataInicioProducao = document.getElementById('filtro-data-inicio-producao');
            const filtroDataFimProducao = document.getElementById('filtro-data-fim-producao');
            const btnAplicarFiltroPeriodoProducao = document.getElementById('btn-aplicar-filtro-periodo-producao');
            const btnResetarFiltroPeriodoProducao = document.getElementById('btn-resetar-filtro-periodo-producao'); // Corrigido
            const btnMesAtualProducao = document.getElementById('btn-mes-atual-producao');
            const periodoAtualProducaoEl = document.getElementById('periodo-atual-producao');

            const formPecaModelo = document.getElementById('form-tipo-peca');
            const pecaModeloIdEditInput = document.getElementById('tipo-peca-id-edit');
            const pecaModeloNomeInput = document.getElementById('tipo-peca-nome');
            const pecaModeloCobraParCheckbox = document.getElementById('tipo-peca-cobra-par');
            const listaProcessosPecaDiv = document.getElementById('lista-processos-peca');
            const btnAddProcessoPeca = document.getElementById('btn-add-processo-peca');
            const pecaModeloMateriaisTextarea = document.getElementById('tipo-peca-materiais');
            const corpoTabelaPecasModelos = document.getElementById('corpo-tabela-tipos-peca');
            const semPecasModelosMsg = document.getElementById('sem-tipos-peca-msg');
            const btnCancelarEdicaoPecaModelo = document.getElementById('btn-cancelar-edicao-tipo-peca');
            const btnAdicionarExemplosPecasModelos = document.getElementById('btn-adicionar-exemplos-tipos-peca');

            const formCliente = document.getElementById('form-cliente');
            const clienteIdEditInput = document.getElementById('cliente-id-edit');
            const clienteNomeInput = document.getElementById('cliente-nome');
            const clienteTelefoneInput = document.getElementById('cliente-telefone');
            const clienteEmailInput = document.getElementById('cliente-email');
            const clienteEnderecoTextarea = document.getElementById('cliente-endereco');
            const clienteObservacoesTextarea = document.getElementById('cliente-observacoes');
            const btnCancelarEdicaoCliente = document.getElementById('btn-cancelar-edicao-cliente');
            const tabelaClientesBody = document.getElementById('corpo-tabela-clientes');
            const semClientesMsg = document.getElementById('sem-clientes-msg');
            const filtroClientesInput = document.getElementById('filtro-clientes');

            const formContatoUtil = document.getElementById('form-contato-util');
            const contatoUtilIdEditInput = document.getElementById('contato-util-id-edit');
            const contatoUtilNomeInput = document.getElementById('contato-util-nome');
            const contatoUtilTipoSelect = document.getElementById('contato-util-tipo');
            const contatoUtilTelefoneInput = document.getElementById('contato-util-telefone');
            const contatoUtilEmailInput = document.getElementById('contato-util-email');
            const contatoUtilObservacoesTextarea = document.getElementById('contato-util-observacoes');
            const btnCancelarEdicaoContatoUtil = document.getElementById('btn-cancelar-edicao-contato-util');
            const tabelaContatosUteisBody = document.getElementById('corpo-tabela-contatos-uteis');
            const semContatosUteisMsg = document.getElementById('sem-contatos-uteis-msg');
            const filtroContatosInput = document.getElementById('filtro-contatos');

            const formReparo = document.getElementById('form-reparo');
            const reparoIdInput = document.getElementById('reparo-id');
            const reparoDataEntradaInput = document.getElementById('reparo-data-entrada');
            const reparoOrigemTextoInput = document.getElementById('reparo-origem-texto');
            const reparoDescricaoTextarea = document.getElementById('reparo-descricao');
            const reparoValorInput = document.getElementById('reparo-valor');
            const reparoStatusSelect = document.getElementById('reparo-status');
            const btnCancelarEdicaoReparo = document.getElementById('btn-cancelar-edicao-reparo');
            const corpoTabelaReparos = document.getElementById('corpo-tabela-reparos');
            const semReparosMsg = document.getElementById('sem-reparos-msg');

            const formConfiguracoesNomesEl = document.getElementById('form-configuracoes-nomes');
            const configNomeAtelieInput = document.getElementById('config-nome-atelie');
            const configNomeCostureiraInput = document.getElementById('config-nome-costureira');
            const configModoInterfaceSelect = document.getElementById('config-modo-interface');
            const configTemaPredefinidoSelect = document.getElementById('config-tema-predefinido');
            const editorTemaPersonalizadoDiv = document.getElementById('editor-tema-personalizado');
            const btnSalvarTemaPersonalizado = document.getElementById('btn-salvar-tema-personalizado');
            const colorPickers = { primaria: document.getElementById('cor-primaria-picker'), secundaria: document.getElementById('cor-secundaria-picker'), fundoApp: document.getElementById('cor-fundo-app-picker'), fundoContainer: document.getElementById('cor-fundo-container-picker'), texto: document.getElementById('cor-texto-picker'), destaque: document.getElementById('cor-destaque-picker'), };
            const formHoras = document.getElementById('form-horas');
            const horasDataInput = document.getElementById('horas-data');
            const horasQuantidadeInput = document.getElementById('horas-quantidade');
            const listaHorasRegistradasUl = document.getElementById('lista-horas-registradas');
            const semHorasMsg = document.getElementById('sem-horas-msg');
            const totalHorasMesSpan = document.getElementById('total-horas-mes');
            const filtroMesHoras = document.getElementById('filtro-mes-horas');
            const formAnotacao = document.getElementById('form-anotacao');
            const anotacaoIdInput = document.getElementById('anotacao-id');
            const anotacaoTituloInput = document.getElementById('anotacao-titulo');
            const anotacaoConteudoTextarea = document.getElementById('anotacao-conteudo');
            const btnCancelarEdicaoAnotacao = document.getElementById('btn-cancelar-edicao-anotacao');
            const listaAnotacoesDiv = document.getElementById('lista-anotacoes');
            const semAnotacoesMsg = document.getElementById('sem-anotacoes-msg');
            const btnExportarDados = document.getElementById('btn-exportar-dados');
            const inputImportarDados = document.getElementById('input-importar-dados');
            const comprovanteContainerHidden = document.getElementById('comprovante-para-impressao-container');

            const filtroRelatorioCliente = document.getElementById('filtro-relatorio-cliente');
            const btnGerarRelatorioPeriodo = document.getElementById('btn-gerar-relatorio-periodo');

            // --- ESTADO DA APLICAÇÃO ---
            let appData = {
                configuracoes: {
                    nomeAtelie: "Meu Ateliê de Costura", nomeCostureira: "Costureira Estrela",
                    temaPredefinido: "theme-classic-rose",
                    temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' },
                    modoInterface: "completo",
                    filtroPeriodoDashboard: { inicio: '', fim: '', expandido: false },
                    filtroPeriodoProducao: { inicio: '', fim: '', expandido: false }
                },
                pecasModelos: [], producoes: [], clientes: [], contatosUteis: [], reparos: [], horasTrabalhadas: [], anotacoes: []
            };

            const conteudosAjuda = { /* ... (Conteúdo de ajuda mantido) ... */
                 'dashboard': `<h3>📊 Dashboard</h3><p>Visão geral do seu ateliê. Use "🗓️ Definir Período" para analisar datas específicas ou "🔄 Mês Atual" para uma visão rápida do mês corrente.</p><ul><li><strong>Ganhos do Dia:</strong> Soma das produções de hoje (não afetado pelo filtro de período).</li><li><strong>Ganhos do Período:</strong> Soma das produções do período filtrado.</li><li><strong>Total Recebido (Período):</strong> Produções PAGAS no período.</li><li><strong>Total Pendente (Período):</strong> Produções NÃO PAGAS no período.</li><li><strong>Peças Produzidas (Período):</strong> Quantidade de peças no período.</li><li><strong>Horas Trabalhadas (Período):</strong> Total de horas no período (Modo Completo).</li></ul><p class="modo-completo-item">No <strong>Modo Completo</strong>, veja gráficos de ganhos e as peças mais produzidas para o período selecionado.</p>`,
                'producao': `<h3>🧵 Produção</h3><p>Aqui você registra novas produções e consulta o histórico.</p><h4>Nova Produção:</h4><ul><li>Preencha os detalhes do item produzido. Campos como Data e Peça/Modelo Base são essenciais.</li><li>No Modo Completo, você pode detalhar Processos e Materiais.</li><li>No Modo Simples, insira o Valor Total do Item manualmente.</li></ul><h4>Histórico de Produção:</h4><ul><li>Use "🗓️ Definir Período" para filtrar a tabela por datas ou "🔄 Mês Atual" para uma visão rápida.</li><li>Filtre também por Status de Pagamento.</li><li>Ações disponíveis: Alterar status de pagamento, Editar, Excluir, Gerar Comprovante individual e Compartilhar via WhatsApp.</li><li><strong>Gerar Relatório Detalhado:</strong> Cria um PDF/Impressão das produções do período selecionado na tabela, podendo filtrar por cliente.</li></ul>`,
                'pecas': `<h3>✂️ Peças/Modelos</h3><p>Cadastre os modelos de peças que você produz e gerencie sua lista.</p><h4>Cadastrar Peça/Modelo:</h4><ul><li>Defina um nome claro para o modelo.</li><li>Indique se é cobrado por par.</li><li class="modo-completo-item">No Modo Completo, adicione os Processos (etapas de costura com seus valores) e Materiais Padrão.</li><li>Use "+ Adicionar Exemplos Iniciais" para popular com modelos comuns, se desejar.</li></ul><h4>Peças/Modelos Cadastrados:</h4><ul><li>Visualize todos os seus modelos.</li><li>Ações: Editar (✏️) e Excluir (🗑️).</li></ul>`,
                'clientes': `<h3>👥 Clientes</h3><p>Gerencie sua carteira de clientes.</p><h4>Cadastrar Cliente:</h4><ul><li>Nome completo é obrigatório.</li><li>Adicione informações de contato e observações.</li></ul><h4>Lista de Clientes:</h4><ul><li>Busque por nome ou telefone.</li><li>Ações: Contatar via WhatsApp (📞), Editar (✏️), Excluir (🗑️).</li></ul>`,
                'contatos': `<h3>📞 Contatos Úteis</h3><p>Mantenha uma agenda de fornecedores, mecânicos, etc.</p><h4>Cadastrar Contato Útil:</h4><ul><li>Nome e Tipo são obrigatórios.</li><li>Adicione telefone, email e observações.</li></ul><h4>Lista de Contatos:</h4><ul><li>Busque por nome, tipo ou telefone.</li><li>Ações: Contatar via WhatsApp (📞), Editar (✏️), Excluir (🗑️).</li></ul>`,
                'reparos': `<h3>🛠️ Reparos/Consertos</h3><p>Registre e acompanhe os reparos e consertos realizados.</p><h4>Registrar Reparo/Conserto:</h4><ul><li>Informe a Data de Entrada, Origem (cliente ou interno), Descrição do problema/serviço, Valor e Status.</li></ul><h4>Histórico de Reparos:</h4><ul><li>Visualize todos os reparos.</li><li>Ações: Editar (✏️) e Excluir (🗑️).</li></ul>`,
                'configuracoes': `<h3>⚙️ Ajustes e Configurações</h3><p>Personalize o aplicativo e gerencie seus dados.</p><h4>Configurações Gerais:</h4><ul><li>Defina o Nome do Ateliê/Firma e Seu Nome para personalizar o app.</li><li>Escolha o Modo da Interface: Completo (todas as funcionalidades) ou Simples (foco no essencial).</li></ul><h4>Editor de Tema Visual:</h4><ul><li>Selecione Temas Predefinidos ou crie um Tema Personalizado ajustando as cores. As alterações são aplicadas em tempo real e podem ser salvas.</li></ul><h4 class="modo-completo-item">Registrar Horas (Modo Completo):</h4><ul><li>Anote suas horas de trabalho por data. O total mensal é exibido no Dashboard.</li></ul><h4 class="modo-completo-item">Anotações Rápidas (Modo Completo):</h4><ul><li>Crie lembretes, ideias ou listas rápidas.</li></ul><h4>Gerenciamento de Dados:</h4><ul><li><strong>Exportar Dados:</strong> Crie um backup seguro de todas as suas informações em um arquivo JSON. Faça isso regularmente!</li><li><strong>Importar Dados:</strong> Restaure dados de um arquivo de backup. <strong>ATENÇÃO:</strong> Esta ação substitui todos os dados atuais no aplicativo!</li></ul>`
            };
            conteudosAjuda['horas'] = conteudosAjuda.configuracoes?.split('<h4>Registrar Horas')[1]?.split('<h4>Anotações Rápidas')[0] || "Registro de horas trabalhadas.";
            conteudosAjuda['anotacoes'] = conteudosAjuda.configuracoes?.split('<h4>Anotações Rápidas')[1]?.split('<h4>Gerenciamento de Dados')[0] || "Suas anotações rápidas.";
            conteudosAjuda['config-dados'] = conteudosAjuda.configuracoes?.split('<h4>Gerenciamento de Dados')[1] || "Gerenciamento de dados, importação e exportação.";
            conteudosAjuda['config-tema'] = conteudosAjuda.configuracoes?.split('<h4>Editor de Tema Visual')[1]?.split('<h4>Registrar Horas')[0] || "Personalização do tema visual.";
            conteudosAjuda['config-geral'] = conteudosAjuda.configuracoes?.split('<h4>Configurações Gerais')[1]?.split('<h4>Editor de Tema Visual')[0] || "Configurações gerais do aplicativo.";


            // --- FUNÇÕES UTILITÁRIAS ---
            const formatarMoeda = (valor = 0) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatarData = (dataStr) => { if (!dataStr || dataStr.length < 10) return ''; try { const [y, m, d] = dataStr.split('-'); return `${d}/${m}/${y}`; } catch (e) { console.error("Erro ao formatar data:", dataStr, e); return ''; } };
            const hojeFormatado = () => new Date().toISOString().split('T')[0];
            const mesAnoAtualFormatado = () => new Date().toISOString().slice(0, 7);
            const primeiroDiaMesAtualFormatado = () => { try { const hoje = new Date(); return new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0]; } catch (e) { console.error("Erro ao obter primeiro dia do mês:", e); return hojeFormatado(); } };
            const ultimoDiaMesAtualFormatado = () => { try { const hoje = new Date(); return new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0]; } catch (e) { console.error("Erro ao obter último dia do mês:", e); return hojeFormatado(); } };
            const hexToRgba = (hex, alpha) => { if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) return `rgba(0,0,0,${alpha})`; try { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(0,0,0,${alpha})`; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } catch (e) { console.error("Erro ao converter HEX para RGBA:", hex, e); return `rgba(0,0,0,${alpha})`; } };
            const validarCorCSS = (corString) => { if (!corString) return null; if (/^(#([0-9a-f]{3}){1,2}|(rgb|hsl)a?\([0-9.,\s%]+\)|[a-z]+)$/i.test(corString.trim())) return corString.trim(); return null; };
            function mostrarMensagemGlobal(texto, tipo = 'sucesso', duracao = 3500) { if (!mensagemGlobalEl) return; mensagemGlobalEl.textContent = texto; mensagemGlobalEl.className = `mensagem-feedback ${tipo}`; mensagemGlobalEl.style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' }); setTimeout(() => { mensagemGlobalEl.style.display = 'none'; mensagemGlobalEl.textContent = ''; }, duracao); }

            // --- NAVEGAÇÃO E ABAS ---
            bottomNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    try { // Adiciona try-catch para a navegação
                        bottomNavItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        tabContents.forEach(content => content.classList.remove('active'));

                        const activeTabElement = document.getElementById(item.dataset.tab);
                        if (activeTabElement) {
                            activeTabElement.classList.add('active');

                            let tituloAbaTexto = item.title || item.textContent.replace(item.querySelector('.icon')?.textContent || '', '').trim();
                            const iconeAba = item.querySelector('.icon');
                            subHeaderTituloAbaEl.textContent = (iconeAba ? iconeAba.textContent + ' ' : '') + tituloAbaTexto;

                            if (btnAjudaSubHeader) {
                                const helpKeyForTab = activeTabElement.dataset.helpKey || item.dataset.tab.replace('tab-', '');
                                btnAjudaSubHeader.dataset.helpTarget = helpKeyForTab;
                            }
                        } else {
                            console.error("Elemento da aba não encontrado:", item.dataset.tab);
                        }

                        // Chamadas de renderização
                        if (item.dataset.tab === "tab-dashboard") renderizarDashboard();
                        else if (item.dataset.tab === "tab-producao") { renderizarTabelaProducao(); popularSelectClientesRelatorio(); }
                        else if (item.dataset.tab === "tab-pecas-modelos") renderizarTabelaPecasModelos();
                        else if (item.dataset.tab === "tab-clientes") renderizarTabelaClientes();
                        else if (item.dataset.tab === "tab-contatos") renderizarTabelaContatosUteis();
                        else if (item.dataset.tab === "tab-reparos") renderizarTabelaReparos();
                        else if (item.dataset.tab === "tab-configuracoes") {
                             if (appData.configuracoes.modoInterface === 'completo') { renderizarHorasTrabalhadas(); renderizarAnotacoes(); }
                        }
                    } catch (e) {
                        console.error("Erro ao trocar de aba:", e);
                        mostrarMensagemGlobal("Erro ao carregar aba.", "erro");
                    }
                });
            });
            window.addEventListener('scroll', () => { if (window.scrollY > 30) { bodyEl.classList.add('scrolled'); } else { bodyEl.classList.remove('scrolled'); } });

            // --- MODAL DE AJUDA ---
            function abrirModalAjuda(chaveAjuda) { /* ... (Mantida) ... */
                 const conteudo = conteudosAjuda[chaveAjuda];
                if (conteudo) {
                    let tituloModal = "Ajuda";
                    const abaAtivaElement = document.querySelector('.bottom-nav-item.active');
                    if(abaAtivaElement) {
                        let nomeAba = abaAtivaElement.title || abaAtivaElement.textContent.replace(abaAtivaElement.querySelector('.icon')?.textContent || '', '').trim();
                        tituloModal = `Ajuda: ${nomeAba}`;
                    }
                    modalAjudaTitulo.textContent = tituloModal;
                    
                    let cP = conteudo; 
                    if (appData.configuracoes.modoInterface === 'simples') { cP = cP.replace(/class="modo-completo-item"/g, 'style="display:none;"'); } else { cP = cP.replace(/class="modo-completo-item"/g, ''); } 
                    modalAjudaConteudo.innerHTML = cP; 
                    modalAjuda.style.display = 'block'; 
                } else { 
                    console.warn("Conteúdo de ajuda não encontrado para:", chaveAjuda);
                    mostrarMensagemGlobal(`Ajuda para "${chaveAjuda}" não encontrada.`, 'erro');
                }
            }
            if (btnAjudaSubHeader) {
                btnAjudaSubHeader.addEventListener('click', (e) => { /* ... (Mantida) ... */
                    e.stopPropagation();
                    const helpKey = e.currentTarget.dataset.helpTarget;
                    if (helpKey) {
                        abrirModalAjuda(helpKey);
                    } else {
                        const activeTab = document.querySelector('.tab-content.active');
                        const fallbackKey = activeTab ? (activeTab.dataset.helpKey || activeTab.id.replace('tab-','')) : 'geral';
                        console.warn("Chave de ajuda não definida no botão, usando fallback:", fallbackKey);
                        abrirModalAjuda(fallbackKey);
                    }
                });
            }
            if (modalAjudaFechar) modalAjudaFechar.addEventListener('click', () => modalAjuda.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target == modalAjuda) modalAjuda.style.display = 'none'; });

            // --- PERSISTÊNCIA DE DADOS ---
            function salvarDados() { try { localStorage.setItem('atelieAppData_vFinalFuncional', JSON.stringify(appData)); } catch (e) { console.error("Erro ao salvar dados:", e); } }
            function carregarDados() {
                const dadosSalvos = localStorage.getItem('atelieAppData_vFinalFuncional');
                const defaultInicio = primeiroDiaMesAtualFormatado();
                const defaultFim = hojeFormatado();
                const defaultConfig = {
                    nomeAtelie: "Meu Ateliê", nomeCostureira: "Costureira",
                    temaPredefinido: "theme-classic-rose",
                    temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' },
                    modoInterface: "completo",
                    filtroPeriodoDashboard: { inicio: defaultInicio, fim: defaultFim, expandido: false },
                    filtroPeriodoProducao: { inicio: defaultInicio, fim: defaultFim, expandido: false }
                };
                if (dadosSalvos) {
                    try {
                        const parsedData = JSON.parse(dadosSalvos);
                         // Deep merge para configurações, garantindo que os filtros existam
                        const mergedConfig = { ...defaultConfig };
                        if (parsedData.configuracoes) {
                            Object.assign(mergedConfig, parsedData.configuracoes);
                            mergedConfig.temaPersonalizado = { ...defaultConfig.temaPersonalizado, ...(parsedData.configuracoes.temaPersonalizado || {}) };
                            mergedConfig.filtroPeriodoDashboard = { ...defaultConfig.filtroPeriodoDashboard, ...(parsedData.configuracoes.filtroPeriodoDashboard || {}) };
                            mergedConfig.filtroPeriodoProducao = { ...defaultConfig.filtroPeriodoProducao, ...(parsedData.configuracoes.filtroPeriodoProducao || {}) };
                        }
                        // Garante datas válidas nos filtros após o merge
                        if (!mergedConfig.filtroPeriodoDashboard.inicio) mergedConfig.filtroPeriodoDashboard.inicio = defaultInicio;
                        if (!mergedConfig.filtroPeriodoDashboard.fim) mergedConfig.filtroPeriodoDashboard.fim = defaultFim;
                        if (!mergedConfig.filtroPeriodoProducao.inicio) mergedConfig.filtroPeriodoProducao.inicio = defaultInicio;
                        if (!mergedConfig.filtroPeriodoProducao.fim) mergedConfig.filtroPeriodoProducao.fim = defaultFim;

                        appData = { ...{pecasModelos: [], producoes: [], clientes: [], contatosUteis: [], reparos: [], horasTrabalhadas: [], anotacoes: []}, ...parsedData, configuracoes: mergedConfig };

                    } catch(e) {
                        console.error("Erro ao parsear dados salvos, usando defaults:", e);
                        appData.configuracoes = defaultConfig;
                    }
                } else {
                    appData.configuracoes = defaultConfig;
                }
                aplicarModoInterface(); aplicarTema(); preencherFormConfiguracoesNomes(); preencherFormConfigTema(); preencherSeletorModoInterface();
                // Configura filtros após carregar dados
                configurarFiltroPeriodo('dashboard', appData.configuracoes.filtroPeriodoDashboard, camposFiltroPeriodoDashboard, btnToggleFiltroPeriodoDashboard, filtroDataInicioDashboard, filtroDataFimDashboard, btnAplicarFiltroPeriodoDashboard, btnResetarFiltroPeriodoDashboard, btnMesAtualDashboard, periodoAtualDashboardEl, renderizarDashboard);
                configurarFiltroPeriodo('producao', appData.configuracoes.filtroPeriodoProducao, camposFiltroPeriodoProducao, btnToggleFiltroPeriodoProducao, filtroDataInicioProducao, filtroDataFimProducao, btnAplicarFiltroPeriodoProducao, btnResetarFiltroPeriodoProducao, btnMesAtualProducao, periodoAtualProducaoEl, renderizarTabelaProducao);
            }

            // --- FILTROS DE PERÍODO (SIMPLIFICADO) ---
            function configurarFiltroPeriodo(tipo, configFiltro, camposDiv, btnToggle, inputInicio, inputFim, btnAplicar, btnResetar, btnMesAtual, displayEl, callbackRender) {
                 // Verifica se todos os elementos necessários existem
                if (!camposDiv || !btnToggle || !inputInicio || !inputFim || !btnAplicar || !btnResetar || !btnMesAtual || !displayEl) {
                    console.error(`Elementos do filtro de período '${tipo}' não encontrados.`);
                    return;
                }
                
                configFiltro.inicio = configFiltro.inicio || primeiroDiaMesAtualFormatado();
                configFiltro.fim = configFiltro.fim || hojeFormatado();

                inputInicio.value = configFiltro.inicio;
                inputFim.value = configFiltro.fim;
                camposDiv.style.display = configFiltro.expandido ? 'flex' : 'none';
                btnToggle.querySelector('.arrow').textContent = configFiltro.expandido ? '▲' : '▼';
                atualizarDisplayPeriodo(displayEl, configFiltro);

                btnToggle.addEventListener('click', () => {
                    configFiltro.expandido = !configFiltro.expandido;
                    camposDiv.style.display = configFiltro.expandido ? 'flex' : 'none';
                    btnToggle.querySelector('.arrow').textContent = configFiltro.expandido ? '▲' : '▼';
                    salvarDados();
                });

                btnAplicar.addEventListener('click', () => {
                    if (!inputInicio.value || !inputFim.value) { mostrarMensagemGlobal("Selecione data de início e fim.", "erro"); return; }
                    if (new Date(inputInicio.value) > new Date(inputFim.value)) { mostrarMensagemGlobal("Data de início não pode ser maior que a data de fim.", "erro"); return; }
                    configFiltro.inicio = inputInicio.value;
                    configFiltro.fim = inputFim.value;
                    configFiltro.expandido = false;
                    camposDiv.style.display = 'none';
                    btnToggle.querySelector('.arrow').textContent = '▼';
                    salvarDados();
                    atualizarDisplayPeriodo(displayEl, configFiltro);
                    if (callbackRender) callbackRender();
                });

                btnMesAtual.addEventListener('click', () => {
                    configFiltro.inicio = primeiroDiaMesAtualFormatado();
                    configFiltro.fim = hojeFormatado(); // Usa hoje, não ultimo dia, para consistencia
                    inputInicio.value = configFiltro.inicio;
                    inputFim.value = configFiltro.fim;
                    configFiltro.expandido = false;
                    camposDiv.style.display = 'none';
                    btnToggle.querySelector('.arrow').textContent = '▼';
                    salvarDados();
                    atualizarDisplayPeriodo(displayEl, configFiltro);
                    if (callbackRender) callbackRender();
                });

                btnResetar.addEventListener('click', () => { // Agora 'Resetar' volta para o mês atual
                    configFiltro.inicio = primeiroDiaMesAtualFormatado();
                    configFiltro.fim = hojeFormatado();
                    inputInicio.value = configFiltro.inicio;
                    inputFim.value = configFiltro.fim;
                    configFiltro.expandido = false;
                    camposDiv.style.display = 'none';
                    btnToggle.querySelector('.arrow').textContent = '▼';
                    salvarDados();
                    atualizarDisplayPeriodo(displayEl, configFiltro);
                    if (callbackRender) callbackRender();
                });
            }

            function atualizarDisplayPeriodo(displayEl, configFiltro) {
                if (configFiltro.inicio && configFiltro.fim) {
                    displayEl.textContent = `Período: ${formatarData(configFiltro.inicio)} a ${formatarData(configFiltro.fim)}`;
                } else {
                    displayEl.textContent = 'Período não definido.';
                }
            }

            // --- GERENCIAMENTO DE TEMA E MODO DE INTERFACE ---
            // (Funções mantidas)
            function aplicarModoInterface() { /* ... (Mantida) ... */ if (appData.configuracoes.modoInterface === 'simples') { bodyEl.classList.remove('modo-completo'); bodyEl.classList.add('modo-simples'); } else { bodyEl.classList.remove('modo-simples'); bodyEl.classList.add('modo-completo'); } const vMP = prodValorManualInput?.closest('.campo-grupo'); const pPD = processosParaProducaoDiv; const vTCP = prodValorTotalCalculadoInput?.closest('.campo-grupo'); if (vMP && pPD && vTCP) { if (appData.configuracoes.modoInterface === 'simples') { vMP.style.display = 'block'; pPD.style.display = 'none'; vTCP.style.display = 'none'; } else { vMP.style.display = 'none'; pPD.style.display = 'block'; vTCP.style.display = 'block'; } } }
            function preencherSeletorModoInterface() { /* ... (Mantida) ... */ if(configModoInterfaceSelect) configModoInterfaceSelect.value = appData.configuracoes.modoInterface; }
            if(configModoInterfaceSelect) configModoInterfaceSelect.addEventListener('change', (e) => { /* ... (Mantida) ... */ appData.configuracoes.modoInterface = e.target.value; aplicarModoInterface(); salvarDados(); mostrarMensagemGlobal(`Modo da interface: ${e.target.value === 'simples' ? 'Simples' : 'Completo'}.`, 'info'); const aT = document.querySelector('.tab-content.active'); if(aT){ const nIA = document.querySelector(`.bottom-nav-item[data-tab="${aT.id}"]`); if(nIA) nIA.click(); } });
            function aplicarTema() { /* ... (Mantida) ... */ const { temaPredefinido, temaPersonalizado, nomeAtelie, nomeCostureira } = appData.configuracoes; const rS = document.documentElement.style; bodyEl.className = bodyEl.className.replace(/theme-\w+/g, '').trim(); if(appData.configuracoes.modoInterface === 'simples') bodyEl.classList.add('modo-simples'); else bodyEl.classList.add('modo-completo'); const aC = (c) => { try { rS.setProperty('--cor-primaria', c.primaria); rS.setProperty('--cor-secundaria', c.secundaria); rS.setProperty('--cor-fundo-app', c.fundoApp); rS.setProperty('--cor-fundo-container', c.fundoContainer); rS.setProperty('--cor-texto', c.texto); rS.setProperty('--cor-destaque', c.destaque); } catch(e){ console.error("Erro ao aplicar cores:", c, e); }}; if (temaPredefinido === 'custom' && temaPersonalizado) { aC(temaPersonalizado); } else if (temaPredefinido) { bodyEl.classList.add(temaPredefinido); ['--cor-primaria', '--cor-secundaria', '--cor-fundo-app', '--cor-fundo-container', '--cor-texto', '--cor-destaque'].forEach(v => rS.removeProperty(v)); setTimeout(() => { try { const cS = getComputedStyle(document.documentElement); const cC = { primaria: cS.getPropertyValue('--cor-primaria').trim(), secundaria: cS.getPropertyValue('--cor-secundaria').trim(), fundoApp: cS.getPropertyValue('--cor-fundo-app').trim(), fundoContainer: cS.getPropertyValue('--cor-fundo-container').trim(), texto: cS.getPropertyValue('--cor-texto').trim(), destaque: cS.getPropertyValue('--cor-destaque').trim(), }; Object.keys(colorPickers).forEach(k => { if(colorPickers[k] && cC[k]) colorPickers[k].value = cC[k];}); } catch(e){ console.error("Erro ao obter/aplicar cores computadas:", e); }}, 50); } try { const cPA = getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim(); rS.setProperty('--cor-primaria-transparente', hexToRgba(cPA, 0.25)); } catch(e) { console.error("Erro ao definir cor primária transparente:", e); } appTitle.textContent = `${nomeAtelie || "Ateliê"} - Gestor Pro`; nomeAtelieHeader.textContent = nomeAtelie || "Seu Ateliê"; footerNomeAtelie.textContent = nomeAtelie || "Seu Ateliê"; nomeCostureiraHeader.textContent = nomeCostureira || "Costureira"; }
            function preencherFormConfiguracoesNomes() { /* ... (Mantida) ... */ if(configNomeAtelieInput) configNomeAtelieInput.value = appData.configuracoes.nomeAtelie; if(configNomeCostureiraInput) configNomeCostureiraInput.value = appData.configuracoes.nomeCostureira; }
            function preencherFormConfigTema() { /* ... (Mantida) ... */ if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.value = appData.configuracoes.temaPredefinido; const cT = appData.configuracoes.temaPersonalizado; Object.keys(colorPickers).forEach(k => { if(colorPickers[k] && cT[k]) colorPickers[k].value = cT[k];}); if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = appData.configuracoes.temaPredefinido === 'custom' ? 'block' : 'none'; }
            if(formConfiguracoesNomesEl) formConfiguracoesNomesEl.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); appData.configuracoes.nomeAtelie = configNomeAtelieInput.value.trim() || "Meu Ateliê"; appData.configuracoes.nomeCostureira = configNomeCostureiraInput.value.trim() || "Costureira"; aplicarTema(); salvarDados(); mostrarMensagemGlobal('Nomes salvos!', 'sucesso'); });
            if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.addEventListener('change', (e) => { /* ... (Mantida) ... */ appData.configuracoes.temaPredefinido = e.target.value; if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = e.target.value === 'custom' ? 'block' : 'none'; aplicarTema(); salvarDados(); });
            Object.keys(colorPickers).forEach(key => { if(colorPickers[key]) colorPickers[key].addEventListener('input', (e) => { /* ... (Mantida) ... */ if (appData.configuracoes.temaPredefinido !== 'custom') { configTemaPredefinidoSelect.value = 'custom'; appData.configuracoes.temaPredefinido = 'custom'; if(editorTemaPersonalizadoDiv) editorTemaPersonalizadoDiv.style.display = 'block'; } const cssVarName = `--cor-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`; document.documentElement.style.setProperty(cssVarName, e.target.value); if (key === 'primaria') { try { document.documentElement.style.setProperty('--cor-primaria-transparente', hexToRgba(e.target.value, 0.25)); } catch(er){ console.error("Erro hexToRgba:", er); } } }); });
            if(btnSalvarTemaPersonalizado) btnSalvarTemaPersonalizado.addEventListener('click', () => { /* ... (Mantida) ... */ Object.keys(colorPickers).forEach(key => { if(appData.configuracoes.temaPersonalizado && colorPickers[key]) appData.configuracoes.temaPersonalizado[key] = colorPickers[key].value; }); appData.configuracoes.temaPredefinido = 'custom'; if(configTemaPredefinidoSelect) configTemaPredefinidoSelect.value = 'custom'; aplicarTema(); salvarDados(); mostrarMensagemGlobal('Tema personalizado salvo!', 'sucesso'); });

            // --- CRUD: PEÇAS/MODELOS, CLIENTES, CONTATOS, PRODUÇÃO, REPAROS, HORAS, ANOTAÇÕES ---
            // (Lógicas mantidas, verificando se elementos existem antes de adicionar listeners)
            let processosTemporariosPecaModelo = [];
            function renderizarInputProcessoPecaModelo(processo = { id: Date.now(), nome: '', valor: 0 }) { const div = document.createElement('div'); div.classList.add('processo-item'); div.dataset.id = processo.id; div.innerHTML = `<input type="text" placeholder="Nome Processo" value="${processo.nome}" data-field="nome-processo-peca"><input type="number" step="0.01" placeholder="Valor (R$)" value="${processo.valor}" data-field="valor-processo-peca"><button type="button" class="btn btn-pequeno btn-perigo btn-remover-processo-temp">X</button>`; if(listaProcessosPecaDiv) listaProcessosPecaDiv.appendChild(div); const btnRemover = div.querySelector('.btn-remover-processo-temp'); if(btnRemover) btnRemover.addEventListener('click', () => { processosTemporariosPecaModelo = processosTemporariosPecaModelo.filter(p => p.id !== processo.id); div.remove(); }); div.querySelectorAll('input').forEach(input => { input.addEventListener('input', () => { const idProc = parseInt(div.dataset.id); const nomeInput = div.querySelector('input[data-field="nome-processo-peca"]').value.trim(); const valorInput = parseFloat(div.querySelector('input[data-field="valor-processo-peca"]').value); const index = processosTemporariosPecaModelo.findIndex(p => p.id === idProc); if (index > -1) { processosTemporariosPecaModelo[index].nome = nomeInput; processosTemporariosPecaModelo[index].valor = isNaN(valorInput) ? 0 : valorInput; } }); });}
            if(btnAddProcessoPeca) btnAddProcessoPeca.addEventListener('click', () => { const nP = { id: Date.now(), nome: '', valor: 0 }; processosTemporariosPecaModelo.push(nP); renderizarInputProcessoPecaModelo(nP); });
            if(formPecaModelo) formPecaModelo.addEventListener('submit', (e) => { e.preventDefault(); const n = pecaModeloNomeInput.value.trim(); const cPP = pecaModeloCobraParCheckbox.checked; const m = pecaModeloMateriaisTextarea.value.trim(); const iE = pecaModeloIdEditInput.value; if (!n) { mostrarMensagemGlobal('Nome da peça/modelo obrigatório.', 'erro'); return; } const pVS = processosTemporariosPecaModelo.filter(p => p.nome.trim() !== '' && typeof p.valor === 'number' && !isNaN(p.valor) && p.valor >= 0); const pMD = { nome:n, cobraPorPar:cPP, processos: pVS, materiais:m }; if (iE) { const idx = appData.pecasModelos.findIndex(pm => pm.id == iE); if (idx > -1) appData.pecasModelos[idx] = { ...appData.pecasModelos[idx], ...pMD }; } else { pMD.id = Date.now(); appData.pecasModelos.push(pMD); } salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); limparFormPecaModelo(); mostrarMensagemGlobal(`Peça/Modelo ${iE ? 'atualizado' : 'salvo'}!`, 'sucesso'); });
            function limparFormPecaModelo() { if(formPecaModelo) formPecaModelo.reset(); if(pecaModeloIdEditInput) pecaModeloIdEditInput.value = ''; if(listaProcessosPecaDiv) listaProcessosPecaDiv.innerHTML = ''; processosTemporariosPecaModelo = []; if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.style.display = 'none'; if(pecaModeloNomeInput) pecaModeloNomeInput.focus(); }
            if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.addEventListener('click', limparFormPecaModelo);
            function carregarPecaModeloParaEdicao(id) { const pM = appData.pecasModelos.find(pm => pm.id == id); if (pM) { if(pecaModeloIdEditInput) pecaModeloIdEditInput.value = pM.id; if(pecaModeloNomeInput) pecaModeloNomeInput.value = pM.nome; if(pecaModeloCobraParCheckbox) pecaModeloCobraParCheckbox.checked = pM.cobraPorPar; if(pecaModeloMateriaisTextarea) pecaModeloMateriaisTextarea.value = pM.materiais || ''; if(listaProcessosPecaDiv) listaProcessosPecaDiv.innerHTML = ''; processosTemporariosPecaModelo = JSON.parse(JSON.stringify(pM.processos || [])); processosTemporariosPecaModelo.forEach(p => renderizarInputProcessoPecaModelo(p)); if(btnCancelarEdicaoPecaModelo) btnCancelarEdicaoPecaModelo.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-pecas-modelos"]').click(); setTimeout(() => { if(pecaModeloNomeInput) pecaModeloNomeInput.focus()}, 100); } }
            function excluirPecaModelo(id) { if (confirm('Excluir peça/modelo?')) { appData.pecasModelos = appData.pecasModelos.filter(pm => pm.id != id); salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); mostrarMensagemGlobal('Peça/Modelo excluído.', 'info'); } }
            function renderizarTabelaPecasModelos() { if (!corpoTabelaPecasModelos) return; corpoTabelaPecasModelos.innerHTML = ''; if (appData.pecasModelos.length === 0) { if(semPecasModelosMsg) semPecasModelosMsg.style.display = 'block'; if(corpoTabelaPecasModelos.parentElement) corpoTabelaPecasModelos.parentElement.style.display = 'none'; return; } if(semPecasModelosMsg) semPecasModelosMsg.style.display = 'none'; if(corpoTabelaPecasModelos.parentElement) corpoTabelaPecasModelos.parentElement.style.display = 'table'; appData.pecasModelos.forEach(pm => { const tr = document.createElement('tr'); const vTP = (pm.processos || []).reduce((s, p) => s + (p.valor || 0), 0); tr.innerHTML = `<td>${pm.nome}</td><td class="modo-completo-item">${(pm.processos && pm.processos.length > 0) ? (pm.processos || []).map(p => `${p.nome} (${formatarMoeda(p.valor || 0)})`).join('<br>') + `<hr style="margin:3px 0;"><small>Total: ${formatarMoeda(vTP)}</small>` : 'S/ Processos'}</td><td>${pm.cobraPorPar ? 'Par' : 'Unid.'}</td><td class="modo-completo-item">${(pm.materiais || '-').substring(0,30)}${(pm.materiais && pm.materiais.length > 30) ? '...' : ''}</td><td><button class="btn btn-pequeno btn-aviso btn-editar-peca-modelo" data-id="${pm.id}">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-peca-modelo" data-id="${pm.id}">🗑️</button></td>`; corpoTabelaPecasModelos.appendChild(tr); }); corpoTabelaPecasModelos.querySelectorAll('.btn-editar-peca-modelo').forEach(b => b.addEventListener('click', (e) => carregarPecaModeloParaEdicao(e.target.dataset.id))); corpoTabelaPecasModelos.querySelectorAll('.btn-excluir-peca-modelo').forEach(b => b.addEventListener('click', (e) => excluirPecaModelo(e.target.dataset.id))); aplicarModoInterface(); }
            function atualizarSelectPecaModeloProducao() { if (!prodPecaModeloSelect) return; prodPecaModeloSelect.innerHTML = '<option value="">Selecione...</option>'; appData.pecasModelos.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(pm => { const o = document.createElement('option'); o.value = pm.id; o.textContent = pm.nome; prodPecaModeloSelect.appendChild(o); }); }
            function popularPecasModelosExemploLingerie() { const exs = [ { id:Date.now()+1, nome:"Sutiã Básico Exemplo", cobraPorPar:false, processos:[{id:Date.now()+2,nome:"Cortar Ex.",valor:0.8},{id:Date.now()+3,nome:"Costurar Bojo Ex.",valor:1.5}], materiais:"Microfibra, Bojo" }, { id:Date.now()+4, nome:"Calcinha Básica Exemplo", cobraPorPar:false, processos:[{id:Date.now()+5,nome:"Cortar Ex.",valor:0.5},{id:Date.now()+6,nome:"Elástico Pernas Ex.",valor:0.9}], materiais:"Algodão, Elástico"} ]; exs.forEach(ex => { if (!appData.pecasModelos.find(pm => pm.nome === ex.nome)) appData.pecasModelos.push(ex); }); salvarDados(); renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao(); mostrarMensagemGlobal('Exemplos adicionados (se não existiam)!', 'info'); }
            if(btnAdicionarExemplosPecasModelos) btnAdicionarExemplosPecasModelos.addEventListener('click', () => { if (appData.pecasModelos.length === 0 || confirm("Adicionar exemplos mesmo com modelos existentes (não duplicará nomes idênticos)?")) { popularPecasModelosExemploLingerie(); } });
            if(formCliente) formCliente.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id=clienteIdEditInput.value; const n=clienteNomeInput.value.trim(); const t=clienteTelefoneInput.value.trim(); const em=clienteEmailInput.value.trim(); const end=clienteEnderecoTextarea.value.trim(); const o=clienteObservacoesTextarea.value.trim(); if(!n){mostrarMensagemGlobal('Nome do cliente obrigatório.','erro'); return;} const cD={nome:n,telefone:t,email:em,endereco:end,observacoes:o}; if(id){const idx=appData.clientes.findIndex(c=>c.id==id); if(idx>-1)appData.clientes[idx]={...appData.clientes[idx],...cD};}else{cD.id=Date.now();appData.clientes.push(cD);} salvarDados(); renderizarTabelaClientes(); popularSelectClientesProducao(); limparFormCliente(); mostrarMensagemGlobal(`Cliente ${id?'atualizado':'salvo'}!`,'sucesso');});
            function limparFormCliente() { /* ... (Mantida) ... */ if(formCliente) formCliente.reset(); if(clienteIdEditInput) clienteIdEditInput.value=''; if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.style.display='none'; if(clienteNomeInput) clienteNomeInput.focus(); }
            if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.addEventListener('click', limparFormCliente);
            function carregarClienteParaEdicao(id) { /* ... (Mantida) ... */ const c=appData.clientes.find(cl=>cl.id==id); if(c){ if(clienteIdEditInput) clienteIdEditInput.value=c.id; if(clienteNomeInput) clienteNomeInput.value=c.nome; if(clienteTelefoneInput) clienteTelefoneInput.value=c.telefone||''; if(clienteEmailInput) clienteEmailInput.value=c.email||''; if(clienteEnderecoTextarea) clienteEnderecoTextarea.value=c.endereco||''; if(clienteObservacoesTextarea) clienteObservacoesTextarea.value=c.observacoes||''; if(btnCancelarEdicaoCliente) btnCancelarEdicaoCliente.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-clientes"]').click(); setTimeout(()=>{ if(clienteNomeInput) clienteNomeInput.focus()},100);}}
            function excluirCliente(id) { /* ... (Mantida) ... */ if(confirm('Excluir cliente?')){appData.clientes=appData.clientes.filter(c=>c.id!=id); salvarDados(); renderizarTabelaClientes(); popularSelectClientesProducao(); mostrarMensagemGlobal('Cliente excluído.','info');}}
            function renderizarTabelaClientes() { /* ... (Mantida) ... */ if(!tabelaClientesBody || !filtroClientesInput) return; tabelaClientesBody.innerHTML=''; const tF=filtroClientesInput.value.toLowerCase(); const cFil=appData.clientes.filter(c=>c.nome.toLowerCase().includes(tF)||(c.telefone&&c.telefone.includes(tF))).sort((a,b)=>a.nome.localeCompare(b.nome)); if(cFil.length===0){ if(semClientesMsg) semClientesMsg.style.display='block'; if(tabelaClientesBody.parentElement) tabelaClientesBody.parentElement.style.display='none'; return;} if(semClientesMsg) semClientesMsg.style.display='none'; if(tabelaClientesBody.parentElement) tabelaClientesBody.parentElement.style.display='table'; cFil.forEach(c=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td>${c.telefone||'-'}${c.email?`<br><small>${c.email}</small>`:''}</td><td class="modo-completo-item">${(c.observacoes||'-').substring(0,40)}${(c.observacoes&&c.observacoes.length>40)?'...':''}</td><td>${c.telefone?`<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" class="btn btn-pequeno btn-whatsapp" title="WhatsApp">📞</a>`:''}<button class="btn btn-pequeno btn-aviso btn-editar-cliente" data-id="${c.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-cliente" data-id="${c.id}" title="Excluir">🗑️</button></td>`; tabelaClientesBody.appendChild(tr);}); tabelaClientesBody.querySelectorAll('.btn-editar-cliente').forEach(b=>b.addEventListener('click',(e)=>carregarClienteParaEdicao(e.target.dataset.id))); tabelaClientesBody.querySelectorAll('.btn-excluir-cliente').forEach(b=>b.addEventListener('click',(e)=>excluirCliente(e.target.dataset.id))); aplicarModoInterface();}
            if(filtroClientesInput) filtroClientesInput.addEventListener('input', renderizarTabelaClientes);
            function popularSelectClientesProducao() { /* ... (Mantida) ... */ if(!prodClienteSelect) return; prodClienteSelect.innerHTML='<option value="">Nenhum cliente</option>'; appData.clientes.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nome;prodClienteSelect.appendChild(o);});}
            if(formContatoUtil) formContatoUtil.addEventListener('submit', (e)=>{ /* ... (Mantida) ... */ e.preventDefault(); const id=contatoUtilIdEditInput.value; const n=contatoUtilNomeInput.value.trim(); const tipo=contatoUtilTipoSelect.value; const tel=contatoUtilTelefoneInput.value.trim(); const email=contatoUtilEmailInput.value.trim(); const obs=contatoUtilObservacoesTextarea.value.trim(); if(!n||!tipo){mostrarMensagemGlobal('Nome e tipo são obrigatórios.','erro'); return;} const cUData={nome:n,tipo,telefone:tel,email,observacoes:obs}; if(id){const idx=appData.contatosUteis.findIndex(cu=>cu.id==id); if(idx>-1)appData.contatosUteis[idx]={...appData.contatosUteis[idx],...cUData};}else{cUData.id=Date.now();appData.contatosUteis.push(cUData);} salvarDados();renderizarTabelaContatosUteis();limparFormContatoUtil();mostrarMensagemGlobal(`Contato ${id?'atualizado':'salvo'}!`,'sucesso');});
            function limparFormContatoUtil(){ /* ... (Mantida) ... */ if(formContatoUtil) formContatoUtil.reset(); if(contatoUtilIdEditInput) contatoUtilIdEditInput.value=''; if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.style.display='none'; if(contatoUtilNomeInput) contatoUtilNomeInput.focus();}
            if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.addEventListener('click', limparFormContatoUtil);
            function carregarContatoUtilParaEdicao(id){ /* ... (Mantida) ... */ const cu=appData.contatosUteis.find(c=>c.id==id); if(cu){ if(contatoUtilIdEditInput) contatoUtilIdEditInput.value=cu.id; if(contatoUtilNomeInput) contatoUtilNomeInput.value=cu.nome; if(contatoUtilTipoSelect) contatoUtilTipoSelect.value=cu.tipo; if(contatoUtilTelefoneInput) contatoUtilTelefoneInput.value=cu.telefone||''; if(contatoUtilEmailInput) contatoUtilEmailInput.value=cu.email||''; if(contatoUtilObservacoesTextarea) contatoUtilObservacoesTextarea.value=cu.observacoes||''; if(btnCancelarEdicaoContatoUtil) btnCancelarEdicaoContatoUtil.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-contatos"]').click(); setTimeout(()=>{ if(contatoUtilNomeInput) contatoUtilNomeInput.focus()},100);}}
            function excluirContatoUtil(id){ /* ... (Mantida) ... */ if(confirm('Excluir este contato útil?')){appData.contatosUteis=appData.contatosUteis.filter(cu=>cu.id!=id); salvarDados(); renderizarTabelaContatosUteis(); mostrarMensagemGlobal('Contato útil excluído.','info');}}
            function renderizarTabelaContatosUteis(){ /* ... (Mantida) ... */ if(!tabelaContatosUteisBody || !filtroContatosInput) return; tabelaContatosUteisBody.innerHTML=''; const tF=filtroContatosInput.value.toLowerCase(); const cUFil=appData.contatosUteis.filter(cu=>cu.nome.toLowerCase().includes(tF)||cu.tipo.toLowerCase().includes(tF)||(cu.telefone&&cu.telefone.includes(tF))).sort((a,b)=>a.nome.localeCompare(b.nome)); if(cUFil.length===0){ if(semContatosUteisMsg) semContatosUteisMsg.style.display='block'; if(tabelaContatosUteisBody.parentElement) tabelaContatosUteisBody.parentElement.style.display='none'; return;} if(semContatosUteisMsg) semContatosUteisMsg.style.display='none'; if(tabelaContatosUteisBody.parentElement) tabelaContatosUteisBody.parentElement.style.display='table'; cUFil.forEach(cu=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${cu.nome}</td><td>${cu.tipo}</td><td>${cu.telefone||'-'}${cu.email?`<br><small>${cu.email}</small>`:''}</td><td class="modo-completo-item">${(cu.observacoes||'-').substring(0,40)}${(cu.observacoes&&cu.observacoes.length>40)?'...':''}</td><td>${cu.telefone?`<a href="https://wa.me/55${cu.telefone.replace(/\D/g,'')}" target="_blank" class="btn btn-pequeno btn-whatsapp" title="WhatsApp">📞</a>`:''}<button class="btn btn-pequeno btn-aviso btn-editar-contato-util" data-id="${cu.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-contato-util" data-id="${cu.id}" title="Excluir">🗑️</button></td>`; tabelaContatosUteisBody.appendChild(tr);}); tabelaContatosUteisBody.querySelectorAll('.btn-editar-contato-util').forEach(b=>b.addEventListener('click',(e)=>carregarContatoUtilParaEdicao(e.target.dataset.id))); tabelaContatosUteisBody.querySelectorAll('.btn-excluir-contato-util').forEach(b=>b.addEventListener('click',(e)=>excluirContatoUtil(e.target.dataset.id))); aplicarModoInterface();}
            if(filtroContatosInput) filtroContatosInput.addEventListener('input', renderizarTabelaContatosUteis);
            if(prodPecaModeloSelect) prodPecaModeloSelect.addEventListener('change', () => { /* ... (Mantida) ... */ const pMID = prodPecaModeloSelect.value; if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = ''; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value = ''; if (pMID) { const pM = appData.pecasModelos.find(pm => pm.id == pMID); if (pM && pM.processos && pM.processos.length > 0) { pM.processos.forEach(pr => { const d = document.createElement('div'); d.innerHTML = `<label class="checkbox-label"><input type="checkbox" name="processo-producao" value="${pr.id}" data-valor="${pr.valor}">${pr.nome} (${formatarMoeda(pr.valor)})</label>`; if(processosParaProducaoDiv) processosParaProducaoDiv.appendChild(d); }); if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]').forEach(c => c.addEventListener('change', calcularValorTotalProducao)); calcularValorTotalProducao(); } else { if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = '<p class="info-text">Sem processos para este modelo.</p>'; } } else { if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML = '<p class="info-text">Selecione Peça/Modelo Base.</p>'; } });
            function calcularValorTotalProducao() { /* ... (Mantida) ... */ let vSP = 0; if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]:checked').forEach(c => { vSP += parseFloat(c.dataset.valor); }); const q = parseInt(prodQuantidadeInput?.value) || 1; const vT = vSP * q; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value = formatarMoeda(vT); return vT; }
            if(prodQuantidadeInput) prodQuantidadeInput.addEventListener('input', calcularValorTotalProducao);
            if(formProducao) formProducao.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id=producaoIdInput.value; const d=prodDataInput.value; const pMID=prodPecaModeloSelect.value; const pMObj=appData.pecasModelos.find(pm=>pm.id==pMID); const nPM=pMObj?pMObj.nome:'(Modelo Base Deletado)'; const cPP=pMObj?pMObj.cobraPorPar:false; const mD=prodModeloDescricaoInput.value.trim(); const cP=prodCorPecaInput.value.trim(); const cID=prodClienteSelect.value; const q=parseInt(prodQuantidadeInput.value); const pg=prodPagoCheckbox.checked; const obs=prodObservacoesTextarea.value.trim(); const mats=prodMateriaisTextarea.value.trim(); let pSel=[]; let vTI=0; if(appData.configuracoes.modoInterface==='simples'){vTI=parseFloat(prodValorManualInput.value)||0;}else{ if(processosParaProducaoDiv) processosParaProducaoDiv.querySelectorAll('input[name="processo-producao"]:checked').forEach(c=>{const pID=c.value; if(pMObj && pMObj.processos){ const pOrig=pMObj.processos.find(p=>p.id==pID); if(pOrig)pSel.push({id:pOrig.id,nome:pOrig.nome,valor:pOrig.valor});}}); vTI=calcularValorTotalProducao();} if(!d||!pMID||isNaN(q)||q<=0){mostrarMensagemGlobal('Preencha data, peça base e quantidade.','erro');return;} const pData={data:d,pecaModeloId:pMID,nomePecaModelo:nPM,cobraPorPar:cPP,modeloDescricao:mD,corPeca:cP,corPecaHTML:validarCorCSS(cP),clienteId:cID,quantidade:q,processos:pSel,valorTotalItem:vTI,pago:pg,observacoes:obs,materiais:mats}; if(id){const idx=appData.producoes.findIndex(p=>p.id==id); if(idx>-1)appData.producoes[idx]={...appData.producoes[idx],...pData};}else{pData.id=Date.now();appData.producoes.push(pData);} salvarDados();renderizarTabelaProducao();renderizarDashboard();limparFormProducao();mostrarMensagemGlobal(`Produção ${id?'atualizada':'adicionada'}!`,'sucesso');});
            function limparFormProducao(){ /* ... (Mantida) ... */ if(formProducao) formProducao.reset(); if(producaoIdInput) producaoIdInput.value=''; if(prodDataInput) prodDataInput.value=hojeFormatado(); if(processosParaProducaoDiv) processosParaProducaoDiv.innerHTML='<p class="info-text">Selecione Peça/Modelo Base.</p>'; if(prodValorTotalCalculadoInput) prodValorTotalCalculadoInput.value=''; if(prodValorManualInput) prodValorManualInput.value=''; if(btnLimparFormProd) btnLimparFormProd.style.display='none'; if(prodPecaModeloSelect) prodPecaModeloSelect.focus();}
            if(btnLimparFormProd) btnLimparFormProd.addEventListener('click',limparFormProducao);
            function carregarProducaoParaEdicao(id){ /* ... (Mantida) ... */ const p=appData.producoes.find(pr=>pr.id==id); if(p){ if(producaoIdInput) producaoIdInput.value=p.id; if(prodDataInput) prodDataInput.value=p.data; if(prodPecaModeloSelect) prodPecaModeloSelect.value=p.pecaModeloId; const ev=new Event('change'); if(prodPecaModeloSelect) prodPecaModeloSelect.dispatchEvent(ev); setTimeout(()=>{ if(processosParaProducaoDiv) (p.processos||[]).forEach(pS=>{const chk=processosParaProducaoDiv.querySelector(`input[value="${pS.id}"]`); if(chk)chk.checked=true;}); if(appData.configuracoes.modoInterface==='simples'){ if(prodValorManualInput) prodValorManualInput.value=p.valorTotalItem;}else{calcularValorTotalProducao();} },150); if(prodModeloDescricaoInput) prodModeloDescricaoInput.value=p.modeloDescricao; if(prodCorPecaInput) prodCorPecaInput.value=p.corPeca||''; if(prodClienteSelect) prodClienteSelect.value=p.clienteId||''; if(prodQuantidadeInput) prodQuantidadeInput.value=p.quantidade; if(prodMateriaisTextarea) prodMateriaisTextarea.value=p.materiais||''; if(prodPagoCheckbox) prodPagoCheckbox.checked=p.pago; if(prodObservacoesTextarea) prodObservacoesTextarea.value=p.observacoes; if(btnLimparFormProd) btnLimparFormProd.style.display='block'; document.querySelector('.bottom-nav-item[data-tab="tab-producao"]').click(); setTimeout(()=>{ if(prodPecaModeloSelect) prodPecaModeloSelect.focus()},100);}}
            function excluirProducao(id){ /* ... (Mantida) ... */ if(confirm('Excluir registro de produção?')){appData.producoes=appData.producoes.filter(p=>p.id!=id);salvarDados();renderizarTabelaProducao();renderizarDashboard();mostrarMensagemGlobal('Produção excluída.','info');}}
            function alternarStatusPagamentoProducao(id){ /* ... (Mantida) ... */ const idx=appData.producoes.findIndex(p=>p.id==id);if(idx>-1){appData.producoes[idx].pago=!appData.producoes[idx].pago;salvarDados();renderizarTabelaProducao();renderizarDashboard();mostrarMensagemGlobal('Status de pagamento atualizado.','sucesso');}}
            
            function renderizarTabelaProducao(){ /* ... (Adaptada para novo filtro) ... */
                if(!corpoTabelaProducao) return;
                corpoTabelaProducao.innerHTML='';
                const configFiltro = appData.configuracoes.filtroPeriodoProducao;
                const sF = filtroStatusPagamento ? filtroStatusPagamento.value : 'todos';

                let inicioFiltro = new Date((configFiltro.inicio || primeiroDiaMesAtualFormatado()) + "T00:00:00Z");
                let fimFiltro = new Date((configFiltro.fim || hojeFormatado()) + "T23:59:59Z");

                const pFil = appData.producoes.filter(p => {
                    const dataProducao = new Date(p.data + "T00:00:00Z");
                    let dataValida = dataProducao >= inicioFiltro && dataProducao <= fimFiltro;
                    let statusValido = (sF === 'todos') ? true : (sF === 'pago' && p.pago) || (sF === 'pendente' && !p.pago);
                    return dataValida && statusValido;
                }).sort((a,b) => new Date(b.data) - new Date(a.data) || b.id - a.id);

                if(pFil.length === 0){ /* ... (Resto da função mantida) ... */
                    if(semProducaoMsg) semProducaoMsg.textContent='Nenhuma produção com filtros atuais.';
                    if(semProducaoMsg) semProducaoMsg.style.display='block';
                    if(corpoTabelaProducao.parentElement) corpoTabelaProducao.parentElement.style.display='none';
                    return;
                }
                if(semProducaoMsg) semProducaoMsg.style.display='none';
                if(corpoTabelaProducao.parentElement) corpoTabelaProducao.parentElement.style.display='table'; 
                pFil.forEach(p=>{ /* ... (renderização da linha mantida) ... */
                    const tr=document.createElement('tr'); 
                    const pN=(p.processos||[]).map(pr=>pr.nome).join(', '); 
                    const cliP=appData.clientes.find(c=>c.id==p.clienteId); 
                    const nCliP=cliP?cliP.nome:'N/A'; 
                    tr.innerHTML=`<td>${formatarData(p.data)}</td><td>${p.nomePecaModelo||'(Base Deletada)'}${p.cobraPorPar?'(Par)':''}${p.corPeca?`<br><small style="font-size:0.85em;">${p.corPecaHTML?`<span class="cor-peca-preview" style="background-color:${p.corPecaHTML};"></span>`:''} ${p.corPeca}</small>`:''}</td><td class="modo-completo-item">${nCliP}</td><td>${p.modeloDescricao || '-'}</td><td>${p.quantidade}</td><td class="modo-completo-item" title="${(p.processos||[]).map(pr=>`${pr.nome}: ${formatarMoeda(pr.valor||0)}`).join('\n')}">${pN.substring(0,25)}${pN.length>25?'...':''}</td><td>${formatarMoeda(p.valorTotalItem)}</td><td><button class="btn btn-pequeno ${p.pago?'btn-sucesso':'btn-aviso'} btn-toggle-pago" data-id="${p.id}">${p.pago?'✔️ Pago':'⌛ Pend.'}</button></td><td><button class="btn btn-pequeno btn-aviso btn-editar-producao" data-id="${p.id}" title="Editar">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-producao" data-id="${p.id}" title="Excluir">🗑️</button><button class="btn btn-pequeno btn-info btn-gerar-comprovante" data-id="${p.id}" title="Gerar Comprovante">🧾</button><button class="btn btn-pequeno btn-whatsapp btn-share-whatsapp" data-id="${p.id}" title="Compartilhar no WhatsApp">💬</button></td>`; 
                    corpoTabelaProducao.appendChild(tr);
                }); 
                corpoTabelaProducao.querySelectorAll('.btn-editar-producao').forEach(b=>b.addEventListener('click',(e)=>carregarProducaoParaEdicao(e.target.dataset.id))); 
                corpoTabelaProducao.querySelectorAll('.btn-excluir-producao').forEach(b=>b.addEventListener('click',(e)=>excluirProducao(e.target.dataset.id))); 
                corpoTabelaProducao.querySelectorAll('.btn-toggle-pago').forEach(b=>b.addEventListener('click',(e)=>alternarStatusPagamentoProducao(e.target.dataset.id))); 
                corpoTabelaProducao.querySelectorAll('.btn-gerar-comprovante').forEach(b => b.addEventListener('click', (e) => gerarComprovanteProducao(e.target.dataset.id))); 
                corpoTabelaProducao.querySelectorAll('.btn-share-whatsapp').forEach(b => b.addEventListener('click', (e) => compartilharProducaoWhatsApp(e.target.dataset.id))); 
                aplicarModoInterface();
            }
            if(filtroStatusPagamento) filtroStatusPagamento.addEventListener('change',renderizarTabelaProducao); 

            if(formReparo) formReparo.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id = reparoIdInput.value; const dataEntrada = reparoDataEntradaInput.value; const origem = reparoOrigemTextoInput.value.trim(); const descricao = reparoDescricaoTextarea.value.trim(); const valor = parseFloat(reparoValorInput.value) || 0; const status = reparoStatusSelect.value; if (!dataEntrada) { mostrarMensagemGlobal('Data de entrada é obrigatória para o reparo.', 'erro'); return; } const reparoData = { dataEntrada, origem, descricao, valor, status }; if (id) { const index = appData.reparos.findIndex(r => r.id == id); if (index > -1) appData.reparos[index] = { ...appData.reparos[index], ...reparoData }; } else { reparoData.id = Date.now(); appData.reparos.push(reparoData); } salvarDados(); renderizarTabelaReparos(); limparFormReparo(); mostrarMensagemGlobal(`Reparo ${id ? 'atualizado' : 'registrado'}!`, 'sucesso'); });
            function limparFormReparo() { /* ... (Mantida) ... */ if(formReparo) formReparo.reset(); if(reparoIdInput) reparoIdInput.value = ''; if(reparoDataEntradaInput) reparoDataEntradaInput.value = hojeFormatado(); if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.style.display = 'none'; if(reparoDescricaoTextarea) reparoDescricaoTextarea.focus(); }
            if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.addEventListener('click', limparFormReparo);
            function carregarReparoParaEdicao(id) { /* ... (Mantida) ... */ const reparo = appData.reparos.find(r => r.id == id); if (reparo) { if(reparoIdInput) reparoIdInput.value = reparo.id; if(reparoDataEntradaInput) reparoDataEntradaInput.value = reparo.dataEntrada; if(reparoOrigemTextoInput) reparoOrigemTextoInput.value = reparo.origem || ''; if(reparoDescricaoTextarea) reparoDescricaoTextarea.value = reparo.descricao; if(reparoValorInput) reparoValorInput.value = reparo.valor; if(reparoStatusSelect) reparoStatusSelect.value = reparo.status; if(btnCancelarEdicaoReparo) btnCancelarEdicaoReparo.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-reparos"]').click(); setTimeout(() => {if(reparoDescricaoTextarea) reparoDescricaoTextarea.focus()}, 100); } }
            function excluirReparo(id) { /* ... (Mantida) ... */ if (confirm('Excluir este registro de reparo?')) { appData.reparos = appData.reparos.filter(r => r.id != id); salvarDados(); renderizarTabelaReparos(); mostrarMensagemGlobal('Reparo excluído.', 'info'); } }
            function renderizarTabelaReparos() { /* ... (Mantida) ... */ if(!corpoTabelaReparos) return; corpoTabelaReparos.innerHTML = ''; const reparosOrdenados = [...appData.reparos].sort((a,b) => new Date(b.dataEntrada) - new Date(a.dataEntrada)); if (reparosOrdenados.length === 0) { if(semReparosMsg) semReparosMsg.style.display = 'block'; if(corpoTabelaReparos.parentElement) corpoTabelaReparos.parentElement.style.display = 'none'; return; } if(semReparosMsg) semReparosMsg.style.display = 'none'; if(corpoTabelaReparos.parentElement) corpoTabelaReparos.parentElement.style.display = 'table'; reparosOrdenados.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${formatarData(r.dataEntrada)}</td><td>${r.origem || '-'}</td><td>${r.descricao || '-'}</td><td>${formatarMoeda(r.valor)}</td><td>${r.status}</td><td><button class="btn btn-pequeno btn-aviso btn-editar-reparo" data-id="${r.id}">✏️</button><button class="btn btn-pequeno btn-perigo btn-excluir-reparo" data-id="${r.id}">🗑️</button></td>`; corpoTabelaReparos.appendChild(tr); }); corpoTabelaReparos.querySelectorAll('.btn-editar-reparo').forEach(btn => btn.addEventListener('click', (e) => carregarReparoParaEdicao(e.target.dataset.id))); corpoTabelaReparos.querySelectorAll('.btn-excluir-reparo').forEach(btn => btn.addEventListener('click', (e) => excluirReparo(e.target.dataset.id))); }
            if(formHoras) formHoras.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const data = horasDataInput.value; const horas = parseFloat(horasQuantidadeInput.value); if (!data || isNaN(horas) || horas <= 0) { mostrarMensagemGlobal('Data e horas válidas são obrigatórias.', 'erro'); return; } const indexExistente = appData.horasTrabalhadas.findIndex(h => h.data === data); if (indexExistente > -1) appData.horasTrabalhadas[indexExistente].horas = horas; else appData.horasTrabalhadas.push({ data, horas }); salvarDados(); renderizarHorasTrabalhadas(); renderizarDashboard(); formHoras.reset(); if(horasDataInput) horasDataInput.value = hojeFormatado(); mostrarMensagemGlobal('Horas registradas!', 'sucesso'); });
            function excluirHoras(data) { /* ... (Mantida) ... */ if (confirm(`Excluir horas de ${formatarData(data)}?`)) { appData.horasTrabalhadas = appData.horasTrabalhadas.filter(h => h.data !== data); salvarDados(); renderizarHorasTrabalhadas(); renderizarDashboard(); mostrarMensagemGlobal('Registro de horas excluído.', 'info'); } }
            function renderizarHorasTrabalhadas() { /* ... (Mantida) ... */ const mesAnoSelecionado = filtroMesHoras?.value || mesAnoAtualFormatado(); if(!listaHorasRegistradasUl) return; listaHorasRegistradasUl.innerHTML = ''; const horasDoMes = appData.horasTrabalhadas.filter(h => h.data.startsWith(mesAnoSelecionado)).sort((a,b) => new Date(a.data) - new Date(b.data)); let totalHoras = 0; if (horasDoMes.length === 0) { if(semHorasMsg) semHorasMsg.style.display = 'block'; } else { if(semHorasMsg) semHorasMsg.style.display = 'none'; horasDoMes.forEach(h => { const li = document.createElement('li'); li.innerHTML = `<span>${formatarData(h.data)}: <strong>${h.horas.toFixed(1).replace('.',',')}h</strong></span><button class="btn btn-pequeno btn-perigo btn-excluir-horas" data-data="${h.data}">🗑️</button>`; listaHorasRegistradasUl.appendChild(li); totalHoras += h.horas; }); listaHorasRegistradasUl.querySelectorAll('.btn-excluir-horas').forEach(btn => { btn.addEventListener('click', (e) => excluirHoras(e.target.dataset.data)); }); } if(totalHorasMesSpan) totalHorasMesSpan.textContent = `${totalHoras.toFixed(1).replace('.',',')}h`; }
            if(filtroMesHoras) filtroMesHoras.addEventListener('change', renderizarHorasTrabalhadas);
            if(formAnotacao) formAnotacao.addEventListener('submit', (e) => { /* ... (Mantida) ... */ e.preventDefault(); const id = anotacaoIdInput.value; const titulo = anotacaoTituloInput.value.trim(); const conteudo = anotacaoConteudoTextarea.value.trim(); if (!conteudo && !titulo) { mostrarMensagemGlobal('Título ou conteúdo da anotação é obrigatório.', 'erro'); return; } const anotacao = { titulo, conteudo, dataModificacao: hojeFormatado() }; if (id) { const index = appData.anotacoes.findIndex(a => a.id == id); if (index > -1) appData.anotacoes[index] = { ...appData.anotacoes[index], ...anotacao }; } else { anotacao.id = Date.now(); anotacao.dataCriacao = hojeFormatado(); appData.anotacoes.push(anotacao); } salvarDados(); renderizarAnotacoes(); limparFormAnotacao(); mostrarMensagemGlobal(`Anotação ${id ? 'atualizada' : 'salva'}!`, 'sucesso'); });
            function limparFormAnotacao() { /* ... (Mantida) ... */ if(formAnotacao) formAnotacao.reset(); if(anotacaoIdInput) anotacaoIdInput.value = ''; if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.style.display = 'none'; } 
            if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.addEventListener('click', limparFormAnotacao);
            function carregarAnotacaoParaEdicao(id) { /* ... (Mantida) ... */ const anotacao = appData.anotacoes.find(a => a.id == id); if (anotacao) { if(anotacaoIdInput) anotacaoIdInput.value = anotacao.id; if(anotacaoTituloInput) anotacaoTituloInput.value = anotacao.titulo; if(anotacaoConteudoTextarea) anotacaoConteudoTextarea.value = anotacao.conteudo; if(btnCancelarEdicaoAnotacao) btnCancelarEdicaoAnotacao.style.display = 'block'; document.querySelector('.bottom-nav-item[data-tab="tab-configuracoes"]').click(); setTimeout(() => {const anCont = document.getElementById('anotacao-conteudo'); if(anCont) anCont.focus();}, 150);}}
            function excluirAnotacao(id) { /* ... (Mantida) ... */ if (confirm('Excluir esta anotação?')) { appData.anotacoes = appData.anotacoes.filter(a => a.id != id); salvarDados(); renderizarAnotacoes(); mostrarMensagemGlobal('Anotação excluída.', 'info'); } }
            function renderizarAnotacoes() { /* ... (Mantida) ... */ if(!listaAnotacoesDiv) return; listaAnotacoesDiv.innerHTML = ''; const anotacoesOrdenadas = [...appData.anotacoes].sort((a,b) => new Date(b.dataModificacao) - new Date(a.dataModificacao) || b.id - a.id); if (anotacoesOrdenadas.length === 0) { if(semAnotacoesMsg) semAnotacoesMsg.style.display = 'block'; return; } if(semAnotacoesMsg) semAnotacoesMsg.style.display = 'none'; anotacoesOrdenadas.forEach(a => { const div = document.createElement('div'); div.className = 'secao'; div.style.marginBottom = '10px'; div.innerHTML = `${a.titulo ? `<h3>${a.titulo}</h3>` : ''}<p style="white-space: pre-wrap;">${a.conteudo}</p><small>Modificado: ${formatarData(a.dataModificacao)}</small><div style="margin-top: 10px;"><button class="btn btn-pequeno btn-aviso btn-editar-anotacao" data-id="${a.id}">✏️ Editar</button><button class="btn btn-pequeno btn-perigo btn-excluir-anotacao" data-id="${a.id}">🗑️ Excluir</button></div>`; listaAnotacoesDiv.appendChild(div); }); listaAnotacoesDiv.querySelectorAll('.btn-editar-anotacao').forEach(btn => btn.addEventListener('click', (e) => carregarAnotacaoParaEdicao(e.target.dataset.id))); listaAnotacoesDiv.querySelectorAll('.btn-excluir-anotacao').forEach(btn => btn.addEventListener('click', (e) => excluirAnotacao(e.target.dataset.id))); }

            // --- IMPORT/EXPORT (Mantido) ---
            if(btnExportarDados) btnExportarDados.addEventListener('click', () => { /* ... (Mantida) ... */ const dJ = JSON.stringify(appData, null, 2); const b = new Blob([dJ],{type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); const nA = `backup_atelie_${(appData.configuracoes.nomeAtelie||'atelie').replace(/\s+/g,'_')}_${hojeFormatado()}.json`; a.href=u; a.download=nA; document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);mostrarMensagemGlobal('Dados exportados!','sucesso');});
            if(inputImportarDados) inputImportarDados.addEventListener('change', (event) => { /* ... (Mantida) ... */ const f = event.target.files[0]; if (f) { if (!confirm("ATENÇÃO: Importar substituirá TODOS os dados atuais. Continuar?")) { inputImportarDados.value = ''; return; } const r = new FileReader(); r.onload = (e) => { try { const dI = JSON.parse(e.target.result); if (dI.configuracoes && Array.isArray(dI.pecasModelos) && Array.isArray(dI.producoes)) { const defConf = { nomeAtelie: "Meu Ateliê", nomeCostureira: "Costureira", temaPredefinido: "theme-classic-rose", temaPersonalizado: { primaria: '#E91E63', secundaria: '#AD1457', fundoApp: '#F4F6F9', fundoContainer: '#FFFFFF', texto: '#343A40', destaque: '#FFC107' }, modoInterface: "completo", filtroPeriodoDashboard: { inicio: primeiroDiaMesAtualFormatado(), fim: hojeFormatado(), expandido: false }, filtroPeriodoProducao: { inicio: primeiroDiaMesAtualFormatado(), fim: hojeFormatado(), expandido: false } }; const mConf = { ...defConf, ...(dI.configuracoes || {}), filtroPeriodoDashboard: { ...defConf.filtroPeriodoDashboard, ...((dI.configuracoes || {}).filtroPeriodoDashboard || {}) }, filtroPeriodoProducao: { ...defConf.filtroPeriodoProducao, ...((dI.configuracoes || {}).filtroPeriodoProducao || {}) } }; mConf.temaPersonalizado = { ...defConf.temaPersonalizado, ...((dI.configuracoes || {}).temaPersonalizado || {}) }; appData = { ...{pecasModelos:[], producoes:[], clientes:[], contatosUteis:[], reparos:[], horasTrabalhadas:[], anotacoes:[]}, ...dI, configuracoes: mConf }; salvarDados(); aplicarTema(); preencherFormConfiguracoesNomes(); preencherFormConfigTema(); preencherSeletorModoInterface(); configurarFiltroPeriodo('dashboard', appData.configuracoes.filtroPeriodoDashboard, camposFiltroPeriodoDashboard, btnToggleFiltroPeriodoDashboard, filtroDataInicioDashboard, filtroDataFimDashboard, btnAplicarFiltroPeriodoDashboard, btnResetarFiltroPeriodoDashboard, btnMesAtualDashboard, periodoAtualDashboardEl, renderizarDashboard); configurarFiltroPeriodo('producao', appData.configuracoes.filtroPeriodoProducao, camposFiltroPeriodoProducao, btnToggleFiltroPeriodoProducao, filtroDataInicioProducao, filtroDataFimProducao, btnAplicarFiltroPeriodoProducao, btnResetarFiltroPeriodoProducao, btnMesAtualProducao, periodoAtualProducaoEl, renderizarTabelaProducao); inicializarTodasAsRenderizacoes(); mostrarMensagemGlobal('Dados importados! App recarregado.', 'sucesso'); } else { throw new Error("Arquivo JSON inválido."); } } catch (err) { console.error("Erro ao importar:", err); mostrarMensagemGlobal(`Erro ao importar: ${err.message}`, 'erro'); } finally { inputImportarDados.value = ''; } }; r.readAsText(f); } });
            
            // --- DASHBOARD E GRÁFICOS (Adaptado para novo filtro) ---
            function getPeriodoAtivoDashboard() { /* ... (Mantida) ... */
                 const configFiltro = appData.configuracoes.filtroPeriodoDashboard;
                const inicio = configFiltro.inicio || primeiroDiaMesAtualFormatado();
                const fim = configFiltro.fim || hojeFormatado();
                return { inicio: inicio, fim: fim };
            }
            function renderizarGraficoGanhosMensais() { /* ... (Mantida) ... */
                 if (!graficoGanhosMensaisDiv || appData.configuracoes.modoInterface === 'simples') {
                    if (graficoGanhosMensaisDiv) graficoGanhosMensaisDiv.innerHTML = '';
                    return;
                }
                graficoGanhosMensaisDiv.innerHTML = '';
                const periodoDashboard = getPeriodoAtivoDashboard();
                const dataFimPeriodo = new Date(periodoDashboard.fim + "T23:59:59Z");

                let ganhosPorMes = {};
                for (let i = 5; i >= 0; i--) {
                    const dBase = new Date(dataFimPeriodo.getUTCFullYear(), dataFimPeriodo.getUTCMonth() - i, 1);
                    const mesAno = dBase.toISOString().slice(0, 7);
                    ganhosPorMes[mesAno] = { nome: dBase.toLocaleDateString('pt-BR', {month:'short', timeZone: 'UTC'}), total: 0 };
                }

                appData.producoes.forEach(p => {
                    const dataProducao = new Date(p.data + "T00:00:00Z");
                    const inicioPeriodoDate = new Date(periodoDashboard.inicio + "T00:00:00Z");
                    if (dataProducao >= inicioPeriodoDate && dataProducao <= dataFimPeriodo) {
                        const mesAnoProd = p.data.slice(0, 7);
                        if (ganhosPorMes[mesAnoProd]) {
                            ganhosPorMes[mesAnoProd].total += p.valorTotalItem;
                        }
                    }
                });

                const valores = Object.values(ganhosPorMes).map(m => m.total);
                const maxValor = Math.max(...valores, 1);

                Object.values(ganhosPorMes).forEach(mes => {
                    const alturaPercent = (mes.total / maxValor) * 100;
                    const barra = document.createElement('div');
                    barra.className = 'barra';
                    barra.style.height = `${alturaPercent}%`;
                    barra.innerHTML = `<span>${mes.nome}<br>${formatarMoeda(mes.total)}</span>`;
                    graficoGanhosMensaisDiv.appendChild(barra);
                });
            }
            function renderizarTopPecas() { /* ... (Mantida) ... */
                 if(!listaTopPecasUl || appData.configuracoes.modoInterface === 'simples') {
                    if(listaTopPecasUl) listaTopPecasUl.innerHTML = '';
                    return;
                }
                listaTopPecasUl.innerHTML = '';
                const periodoDashboard = getPeriodoAtivoDashboard();
                
                const contagemPecas = {};
                appData.producoes.filter(p => {
                    const dataProducao = new Date(p.data + "T00:00:00Z");
                    return dataProducao >= new Date(periodoDashboard.inicio + "T00:00:00Z") && dataProducao <= new Date(periodoDashboard.fim + "T23:59:59Z");
                }).forEach(p => { 
                    const nomePeca = p.nomePecaModelo || "Desconhecida"; 
                    contagemPecas[nomePeca] = (contagemPecas[nomePeca] || 0) + p.quantidade; 
                });

                const topArray = Object.entries(contagemPecas).sort(([,a],[,b]) => b-a).slice(0, 5);
                if(topArray.length === 0) { 
                    listaTopPecasUl.innerHTML = '<li>Nenhuma peça produzida no período.</li>'; 
                    return; 
                }
                topArray.forEach(([nome, qtd]) => { 
                    const li = document.createElement('li'); 
                    li.textContent = `${nome}: ${qtd} unid.`; 
                    listaTopPecasUl.appendChild(li); 
                });
            }
            function renderizarDashboard() { /* ... (Adaptada) ... */
                const hj = hojeFormatado();
                const periodo = getPeriodoAtivoDashboard();
                let dataInicioFiltro = new Date(periodo.inicio + "T00:00:00Z");
                let dataFimFiltro = new Date(periodo.fim + "T23:59:59Z");

                let gD = 0, gP = 0, tRP = 0, tPP = 0, pPP = 0, hTP = 0;

                appData.producoes.forEach(p => {
                    const dataProducao = new Date(p.data + "T00:00:00Z");
                    if (p.data === hj) gD += p.valorTotalItem; 
                    if (dataProducao >= dataInicioFiltro && dataProducao <= dataFimFiltro) {
                        gP += p.valorTotalItem;
                        pPP += p.quantidade;
                        if (p.pago) tRP += p.valorTotalItem;
                        else tPP += p.valorTotalItem;
                    }
                });
                appData.horasTrabalhadas.forEach(h => {
                    const dataHora = new Date(h.data + "T00:00:00Z");
                    if (dataHora >= dataInicioFiltro && dataHora <= dataFimFiltro) {
                        hTP += h.horas;
                    }
                });

                if(dashValorCard1) dashValorCard1.textContent = formatarMoeda(gD);
                if(dashValorCard2) dashValorCard2.textContent = formatarMoeda(gP);
                if(dashValorCard3) dashValorCard3.textContent = formatarMoeda(tRP);
                if(dashValorCard4) dashValorCard4.textContent = formatarMoeda(tPP);
                if(dashValorCard5) dashValorCard5.textContent = pPP;
                if(dashValorCard6) dashValorCard6.textContent = `${hTP.toFixed(1).replace('.',',')}h`;

                if (appData.configuracoes.modoInterface === 'completo') {
                    renderizarGraficoGanhosMensais();
                    renderizarTopPecas();
                } else {
                     if (graficoGanhosMensaisDiv) graficoGanhosMensaisDiv.innerHTML = '';
                     if (listaTopPecasUl) listaTopPecasUl.innerHTML = '<li>Gráficos disponíveis no Modo Completo.</li>';
                }
            }
            
            // --- GERAR COMPROVANTE INDIVIDUAL E RELATÓRIO POR PERÍODO (Mantido) ---
            function gerarComprovanteProducao(producaoId) { /* ... (Mantida) ... */
                const p = appData.producoes.find(item => item.id == producaoId);
                if (!p) { mostrarMensagemGlobal("Produção não encontrada.", "erro"); return; }
                const cliente = p.clienteId ? appData.clientes.find(c => c.id == p.clienteId) : null;
                const pecaBase = appData.pecasModelos.find(pm => pm.id == p.pecaModeloId);

                let html = `<div id="comprovante-para-impressao">`;
                html += `<h1>Comprovante de Produção</h1>`;
                html += `<p style="text-align:center; margin-bottom:20px;"><strong>${appData.configuracoes.nomeAtelie}</strong></p>`;
                html += `<h2>Detalhes da Produção</h2>`;
                html += `<p><strong>Data:</strong> ${formatarData(p.data)}</p>`;
                if (cliente) html += `<p><strong>Cliente:</strong> ${cliente.nome}</p>`;
                html += `<p><strong>Peça Base:</strong> ${p.nomePecaModelo || (pecaBase ? pecaBase.nome : '(Não informado)')}</p>`;
                html += `<p><strong>Descrição Detalhada:</strong> ${p.modeloDescricao || '(Não informado)'}</p>`;
                if (p.corPeca) html += `<p><strong>Cor:</strong> ${p.corPeca}</p>`;
                html += `<p><strong>Quantidade:</strong> ${p.quantidade}</p>`;
                if (appData.configuracoes.modoInterface === 'completo' && p.processos && p.processos.length > 0) { html += `<h3>Processos Realizados e Custos</h3><ul>`; p.processos.forEach(proc => { html += `<li>${proc.nome || '(Processo sem nome)'}: ${formatarMoeda(proc.valor || 0)}</li>`; }); html += `</ul>`; }
                if (appData.configuracoes.modoInterface === 'completo' && p.materiais) { html += `<h3>Materiais Utilizados</h3><p>${p.materiais.replace(/\n/g, '<br>')}</p>`;}
                html += `<hr>`;
                if(p.quantidade > 0 && p.valorTotalItem !== 0 ) { html += `<p><strong>Valor Unitário Estimado: ${formatarMoeda(p.valorTotalItem / p.quantidade)}</strong> (x${p.quantidade})</p>`; }
                html += `<h2 style="margin-top:10px;">Valor Total: ${formatarMoeda(p.valorTotalItem)}</h2>`;
                html += `<p><strong>Status Pagamento:</strong> ${p.pago ? 'Pago' : 'Pendente'}</p>`;
                if (p.observacoes) html += `<p><strong>Observações:</strong> ${p.observacoes.replace(/\n/g, '<br>')}</p>`;
                html += `<hr><p id="rodape-comprovante">Gerado por: ${appData.configuracoes.nomeAtelie || 'Gestor de Ateliê Pro'}</p>`;
                html += `</div>`;
                if(comprovanteContainerHidden) comprovanteContainerHidden.innerHTML = html;
                requestAnimationFrame(() => { requestAnimationFrame(() => { window.print(); }); });
            }
            function compartilharProducaoWhatsApp(producaoId) { /* ... (Mantida) ... */
                 const p = appData.producoes.find(item => item.id == producaoId);
                if (!p) { mostrarMensagemGlobal("Produção não encontrada.", "erro"); return; }
                const cliente = p.clienteId ? appData.clientes.find(c => c.id == p.clienteId) : null;
                let msg = `*Resumo da Produção - ${appData.configuracoes.nomeAtelie}*\n\n`;
                msg += `Data: ${formatarData(p.data)}\n`;
                if (cliente) msg += `Cliente: ${cliente.nome}\n`;
                msg += `Peça: ${p.nomePecaModelo} - ${p.modeloDescricao || '(Sem descrição detalhada)'}\n`;
                if (p.corPeca) msg += `Cor: ${p.corPeca}\n`;
                msg += `Quantidade: ${p.quantidade}\n`;
                msg += `*Valor Total: ${formatarMoeda(p.valorTotalItem)}*\n`;
                msg += `Status: ${p.pago ? 'Pago' : 'Pendente'}\n`;
                if (p.observacoes) msg += `\nObservações: ${p.observacoes}\n`;
                const encodedMsg = encodeURIComponent(msg);
                let whatsappLink = `https://api.whatsapp.com/send?text=${encodedMsg}`;
                if (cliente && cliente.telefone) { whatsappLink = `https://api.whatsapp.com/send?phone=55${cliente.telefone.replace(/\D/g,'')}&text=${encodedMsg}`; }
                window.open(whatsappLink, '_blank');
            }
            function gerarRelatorioProducaoPeriodo() { /* ... (Adaptada para novo filtro) ... */
                const configFiltroProducao = appData.configuracoes.filtroPeriodoProducao;
                let dataInicioStr = configFiltroProducao.inicio;
                let dataFimStr = configFiltroProducao.fim;
                
                const clienteIdSelecionado = filtroRelatorioCliente ? filtroRelatorioCliente.value : '';
                const dataInicio = new Date(dataInicioStr + "T00:00:00Z");
                const dataFim = new Date(dataFimStr + "T23:59:59Z");

                if (dataInicio > dataFim) { mostrarMensagemGlobal("A Data Início não pode ser posterior à Data Fim.", "erro"); return; }
                let producoesFiltradas = appData.producoes.filter(p => { /* ... (Resto mantido) ... */
                    const dataProducao = new Date(p.data + "T00:00:00Z"); 
                    let atendeData = dataProducao >= dataInicio && dataProducao <= dataFim;
                    let atendeCliente = true;
                    if (clienteIdSelecionado) {
                        atendeCliente = p.clienteId == clienteIdSelecionado;
                    }
                    return atendeData && atendeCliente;
                });

                if (producoesFiltradas.length === 0) { mostrarMensagemGlobal("Nenhuma produção encontrada para o período e cliente selecionados.", "info"); return; }
                producoesFiltradas.sort((a, b) => new Date(a.data) - new Date(b.data)); 
                const clienteSelecionadoObj = clienteIdSelecionado ? appData.clientes.find(c => c.id == clienteIdSelecionado) : null;
                let totalGeralRelatorio = 0;
                let html = `<div id="comprovante-para-impressao">`; 
                html += `<h1>Relatório de Produção por Período</h1>`;
                html += `<p style="text-align:center; margin-bottom:10px;"><strong>${appData.configuracoes.nomeAtelie}</strong></p>`;
                html += `<p><strong>Período:</strong> ${formatarData(dataInicioStr)} a ${formatarData(dataFimStr)}</p>`;
                if (clienteSelecionadoObj) { html += `<p><strong>Cliente:</strong> ${clienteSelecionadoObj.nome}</p>`; }
                html += `<hr>`;
                html += `<table><thead><tr><th>Data</th><th>Peça Base</th><th>Descrição Detalhada</th><th>Qtd</th><th>Valor Item</th><th>Valor Total</th></tr></thead><tbody>`;
                producoesFiltradas.forEach(p => { const valorUnitario = p.quantidade > 0 ? (p.valorTotalItem / p.quantidade) : 0; html += `<tr><td>${formatarData(p.data)}</td><td>${p.nomePecaModelo || '-'} ${p.corPeca ? `(${p.corPeca})` : ''}</td><td>${p.modeloDescricao || '-'}</td><td style="text-align:center;">${p.quantidade}</td><td style="text-align:right;">${formatarMoeda(valorUnitario)}</td><td style="text-align:right;">${formatarMoeda(p.valorTotalItem)}</td></tr>`; totalGeralRelatorio += p.valorTotalItem; });
                html += `</tbody></table>`;
                html += `<hr>`;
                html += `<h2 style="text-align:right; margin-top:15px;">Total Geral do Período: ${formatarMoeda(totalGeralRelatorio)}</h2>`;
                html += `<p id="rodape-comprovante">Gerado por: Gestor de Ateliê Pro em ${formatarData(hojeFormatado())}</p>`;
                html += `</div>`;
                if(comprovanteContainerHidden) comprovanteContainerHidden.innerHTML = html;
                requestAnimationFrame(() => { requestAnimationFrame(() => { window.print(); }); });
            }
            if(btnGerarRelatorioPeriodo) btnGerarRelatorioPeriodo.addEventListener('click', gerarRelatorioProducaoPeriodo);
            function popularSelectClientesRelatorio() { /* ... (Mantida) ... */
                if(!filtroRelatorioCliente) return;
                filtroRelatorioCliente.innerHTML = '<option value="">Todos os Clientes</option>';
                appData.clientes.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.nome;
                    filtroRelatorioCliente.appendChild(option);
                });
            }

            // --- INICIALIZAÇÃO ---
            function inicializarTodasAsRenderizacoes() {
                if(anoAtualEl) anoAtualEl.textContent = new Date().getFullYear();
                if(prodDataInput) prodDataInput.value = hojeFormatado();
                if(reparoDataEntradaInput) reparoDataEntradaInput.value = hojeFormatado();
                if(horasDataInput) horasDataInput.value = hojeFormatado();
                if(filtroMesHoras) filtroMesHoras.value = mesAnoAtualFormatado();

                renderizarTabelaPecasModelos(); atualizarSelectPecaModeloProducao();
                renderizarTabelaClientes(); popularSelectClientesProducao(); popularSelectClientesRelatorio();
                renderizarTabelaContatosUteis();
                renderizarTabelaProducao();
                renderizarTabelaReparos();
                if (appData.configuracoes.modoInterface === 'completo') { renderizarHorasTrabalhadas(); renderizarAnotacoes(); }
                renderizarDashboard();

                if (btnAdicionarExemplosPecasModelos) {
                     btnAdicionarExemplosPecasModelos.style.display = appData.pecasModelos.length === 0 ? 'block' : 'inline-block';
                }
            }

            // --- Início da Execução ---
            carregarDados();
            inicializarTodasAsRenderizacoes();
            // Ativa a primeira aba (Dashboard) ao carregar
            if (bottomNavItems.length > 0 && bottomNavItems[0].classList.contains('active')) {
                 bottomNavItems[0].click(); // Simula clique para garantir estado inicial correto
            } else if (bottomNavItems.length > 0) {
                 bottomNavItems[0].click(); // Clica no primeiro se nenhum estiver ativo
            }

            console.log("App Ateliê Gestor Pro - vFinalCorrigidaFuncional - JS Finalizado.");

        } catch (error) {
            console.error("Erro GERAL na inicialização ou execução do script:", error);
            // Tenta exibir uma mensagem para o usuário mesmo em caso de erro grave
            const errorMsgDiv = document.getElementById('mensagem-global') || document.createElement('div');
             if (!document.getElementById('mensagem-global')) {
                 errorMsgDiv.id = 'mensagem-global';
                 errorMsgDiv.className = 'mensagem-feedback erro';
                 errorMsgDiv.style.margin = '20px';
                 document.body.prepend(errorMsgDiv); // Adiciona no início do body
             }
             errorMsgDiv.textContent = `Ocorreu um erro crítico. Por favor, recarregue a página ou contate o suporte. Detalhes: ${error.message}`;
             errorMsgDiv.style.display = 'block';
        }
    });
    </script>
</body>
</html>